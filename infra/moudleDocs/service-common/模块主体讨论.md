# service-common 模块主体讨论

> **文档位置**: `infra/moudleDocs/service-common/模块主体讨论.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 1. 模块概述

### 1.1 模块背景
service-common模块是BanyuMall积分商城系统的公共工具模块。在微服务架构中，各个微服务模块需要共享一些通用的组件、工具类和数据结构，为了避免代码重复和提高开发效率，需要一个统一的公共模块来提供这些基础功能。该模块负责提供静态方法、工具类和通用数据结构，为其他业务模块提供统一的基础组件支持。

### 1.2 模块目标
- 为整个微服务架构提供统一的公共组件
- 避免代码重复，提高开发效率
- 提供标准化的数据结构和响应格式
- 统一异常处理和错误码管理
- 提供通用的工具类和静态方法
- 确保各模块间的一致性和兼容性

### 1.3 模块范围
- **统一响应格式**: 提供标准的API响应数据结构
- **基础实体类**: 定义所有实体类的公共字段
- **异常处理**: 业务异常类和错误码定义
- **请求追踪**: 链路追踪和请求上下文管理
- **工具类**: 提供各种通用工具方法
- **常量定义**: 系统常量和枚举值定义

## 2. 需求分析

### 2.1 业务需求
1. **统一响应格式需求**
   - 所有微服务模块需要统一的API响应格式
   - 响应数据需要包含状态码、消息、数据和时间戳
   - 支持成功和失败的不同响应格式
   - 提供便捷的响应构建方法

2. **基础实体类需求**
   - 所有实体类需要公共的基础字段
   - 支持创建时间、更新时间、创建人、更新人等审计字段
   - 支持逻辑删除功能
   - 提供统一的字段填充策略

3. **异常处理需求**
   - 统一的异常处理机制
   - 标准化的错误码定义
   - 友好的错误消息提示
   - 异常信息的统一格式

4. **工具类需求**
   - 常用的工具方法集合
   - 字符串处理、日期处理等通用功能
   - 用户上下文管理工具
   - 数据转换和验证工具

### 2.2 功能需求
1. **响应格式功能**
   - 成功响应格式
   - 失败响应格式
   - 分页响应格式
   - 响应数据转换

2. **实体类功能**
   - 基础字段定义
   - 字段自动填充
   - 逻辑删除支持
   - 序列化支持

3. **异常处理功能**
   - 业务异常定义
   - 错误码枚举
   - 异常信息格式化
   - 异常堆栈处理

4. **工具类功能**
   - 字符串工具
   - 日期时间工具
   - 用户上下文工具
   - 数据验证工具

### 2.3 非功能需求
1. **性能需求**
   - 工具类方法执行效率高
   - 响应格式构建快速
   - 异常处理开销小
   - 内存使用优化

2. **兼容性需求**
   - 与Spring Boot 3.x兼容
   - 与MyBatis-Plus兼容
   - 与Jakarta Validation兼容
   - 向后兼容性保证

3. **可维护性需求**
   - 代码结构清晰
   - 注释完整详细
   - 易于扩展和修改
   - 版本管理规范

## 3. 技术方案

### 3.1 技术选型
- **框架**: Spring Boot 3.x
- **ORM**: MyBatis-Plus
- **验证**: Jakarta Validation
- **序列化**: FastJSON2
- **日志**: Log4j2
- **工具库**: Lombok

### 3.2 架构设计
- **模块化设计**: 按功能划分不同的包结构
- **工具类设计**: 提供静态方法和工具类
- **实体类设计**: 抽象基类和接口设计
- **异常设计**: 异常继承体系和错误码管理

### 3.3 包结构设计
```
com.origin.common
├── dto/           # 数据传输对象
├── entity/        # 基础实体类
├── exception/     # 异常处理
├── util/          # 工具类
└── constant/      # 常量定义
```

## 4. 接口设计

### 4.1 响应格式设计
- **统一响应类**: ResultData<T>
- **分页响应类**: PageResult<T>
- **响应构建器**: ResultDataBuilder
- **响应工具类**: ResponseUtils

### 4.2 实体类设计
- **基础实体类**: BaseEntity
- **审计实体类**: AuditableEntity
- **树形实体类**: TreeEntity
- **状态实体类**: StatusEntity

### 4.3 异常设计
- **业务异常**: BusinessException
- **参数异常**: ParameterException
- **权限异常**: AuthorizationException
- **系统异常**: SystemException

## 5. 数据结构设计

### 5.1 统一响应格式
- **响应码**: 标准HTTP状态码
- **响应消息**: 用户友好的消息
- **响应数据**: 泛型数据对象
- **时间戳**: 响应时间戳

### 5.2 基础实体字段
- **创建人**: 记录创建者信息
- **创建时间**: 记录创建时间
- **更新人**: 记录更新者信息
- **更新时间**: 记录更新时间
- **逻辑删除**: 软删除标记

### 5.3 错误码体系
- **成功码**: 200系列
- **客户端错误**: 400系列
- **服务端错误**: 500系列
- **业务错误**: 自定义错误码

## 6. 安全设计

### 6.1 数据安全
- **敏感信息过滤**: 自动过滤敏感字段
- **数据脱敏**: 支持数据脱敏处理
- **权限验证**: 用户权限验证工具
- **安全工具**: 加密解密工具类

### 6.2 异常安全
- **异常信息保护**: 避免敏感信息泄露
- **错误码安全**: 安全的错误码设计
- **堆栈信息**: 生产环境隐藏详细堆栈
- **日志安全**: 安全的日志记录

## 7. 性能优化

### 7.1 工具类优化
- **静态方法**: 使用静态方法提高性能
- **缓存机制**: 合理的缓存策略
- **对象复用**: 避免频繁创建对象
- **算法优化**: 高效的算法实现

### 7.2 响应优化
- **响应构建**: 高效的响应构建
- **数据序列化**: 优化的序列化策略
- **内存使用**: 合理的内存使用
- **并发处理**: 线程安全的实现

## 8. 监控和日志

### 8.1 监控指标
- **工具类性能**: 监控工具类执行性能
- **异常统计**: 统计异常发生情况
- **响应时间**: 监控响应构建时间
- **内存使用**: 监控内存使用情况

### 8.2 日志记录
- **操作日志**: 记录重要操作日志
- **异常日志**: 记录异常详细信息
- **性能日志**: 记录性能相关日志
- **调试日志**: 开发调试日志

## 9. 测试策略

### 9.1 单元测试
- **工具类测试**: 测试工具类功能
- **响应格式测试**: 测试响应格式
- **异常处理测试**: 测试异常处理
- **实体类测试**: 测试实体类功能

### 9.2 集成测试
- **模块集成**: 测试与其他模块集成
- **框架集成**: 测试与框架集成
- **序列化测试**: 测试序列化功能
- **兼容性测试**: 测试兼容性

### 9.3 性能测试
- **工具类性能**: 测试工具类性能
- **响应构建性能**: 测试响应构建性能
- **内存使用测试**: 测试内存使用情况
- **并发性能测试**: 测试并发性能

## 10. 部署和运维

### 10.1 部署配置
- **依赖管理**: 合理的依赖版本管理
- **打包配置**: 优化的打包配置
- **环境配置**: 多环境配置支持
- **版本管理**: 规范的版本管理

### 10.2 运维支持
- **监控集成**: 集成监控系统
- **日志收集**: 集成日志收集系统
- **告警机制**: 异常告警机制
- **文档维护**: 及时更新文档

## 11. 文档和规范

### 11.1 代码规范
- **编码规范**: 遵循阿里巴巴Java开发手册
- **注释规范**: 完整的代码注释和文档
- **命名规范**: 统一的命名规范和约定
- **版本控制**: 规范的Git提交和分支管理

### 11.2 文档规范
- **API文档**: 完整的API接口文档
- **设计文档**: 详细的设计和架构文档
- **使用文档**: 工具类使用说明文档
- **示例文档**: 代码示例和最佳实践 