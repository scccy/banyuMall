# 半语积分商城 - 微服务总体设计框架

> **文档位置**: `infra/moudleDocs/微服务总体设计框架.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 1. 系统概述

### 1.1 项目背景
半语积分商城是一个基于微服务架构的积分任务平台，支持B端发布任务、C端完成任务获得积分，并将积分同步到有赞商城。

### 1.2 核心业务
- **任务发布**: B端用户发布各类任务（评论、讨论、反馈等）
- **任务执行**: C端用户完成任务获得积分奖励
- **积分管理**: 积分获取、消费、同步到有赞商城
- **用户管理**: 用户注册、登录、权限管理
- **第三方集成**: 微信、有赞等第三方平台集成

## 2. 微服务架构设计

### 2.1 服务划分原则
1. **业务边界清晰**: 按业务领域划分服务
2. **高内聚低耦合**: 服务内部功能紧密相关，服务间依赖最小化
3. **可独立部署**: 每个服务可以独立开发、测试、部署
4. **数据自治**: 每个服务管理自己的数据，避免跨服务数据访问

### 2.2 服务架构图
```
┌─────────────────────────────────────────────────────────────┐
│                     API Gateway (8080)                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
    ┌─────────────────┼─────────────────┐
    │                 │                 │
┌───▼────┐    ┌──────▼──────┐    ┌─────▼────┐
│ Auth   │    │ User        │    │ Publisher│
│ 8081   │    │ 8082        │    │ 8083     │
└────────┘    └─────────────┘    └──────────┘
    │                 │                 │
    └─────────────────┼─────────────────┘
                      │
              ┌───────▼──────┐
              │ Third-Party  │
              │ OSS 8084     │
              └──────────────┘
```

### 2.3 服务说明

| 主题 | 微服务名称 | 端口 | 职责 | 技术栈 | 设计文档 |
|------|------------|------|------|--------|----------|
| 网关 | service-gateway | 8080 | 统一入口、路由转发、认证鉴权、限流熔断 | Spring Cloud Gateway | [查看设计](../service/service-gateway/design.md) |
| 认证 | service-auth | 8081 | 用户认证、JWT令牌管理、权限控制 | Spring Boot + Spring Security + JWT | [查看设计](../service/service-auth/design.md) |
| 用户 | service-user | 8082 | 用户管理、用户信息维护 | Spring Boot + MyBatis-Plus | [查看设计](../service/service-user/design.md) |
| 发布者 | core-publisher | 8083 | 任务发布、任务管理、任务审核 | Spring Boot + MyBatis-Plus | [查看设计](../core/core-publisher/design.md) |
| 第三方 | third-party-oss | 8084 | 文件上传、图片处理、第三方平台集成 | Spring Boot + Aliyun OSS | [查看设计](../third-party/aliyun-oss/design.md) |

## 3. 技术架构

### 3.1 技术栈
- **开发语言**: Java 21
- **框架**: Spring Boot 3.x + Spring Cloud
- **数据库**: MySQL 8.0
- **缓存**: Redis
- **ORM**: MyBatis-Plus
- **服务调用**: OpenFeign
- **配置中心**: Nacos
- **服务发现**: Nacos Discovery
- **网关**: Spring Cloud Gateway
- **认证**: JWT + Spring Security
- **文档**: Knife4j (Swagger)
- **JSON处理**: FastJSON2
- **日志框架**: Log4j2

### 3.2 数据架构
- **数据库设计**: 按服务划分数据库，每个服务独立管理自己的数据
- **缓存策略**: Redis缓存热点数据，提高查询性能
- **数据同步**: 通过Feign客户端进行服务间数据调用

### 3.3 安全架构
- **认证**: JWT令牌认证
- **授权**: 基于角色的权限控制 (RBAC)
- **数据安全**: 敏感数据加密存储
- **接口安全**: 接口签名验证、防重放攻击

## 4. 开发规范

### 4.1 代码规范
- **包结构**: 按功能模块分包 (controller, service, mapper, entity, dto)
- **命名规范**: 驼峰命名法，类名首字母大写
- **注释规范**: 类、方法、复杂逻辑必须添加注释
- **异常处理**: 统一异常处理，自定义业务异常

### 4.2 API设计规范
- **RESTful**: 遵循RESTful API设计原则
- **版本控制**: 通过URL路径进行版本控制
- **响应格式**: 统一响应格式，包含状态码、消息、数据
- **参数验证**: 请求参数必须进行验证

### 4.3 核心关键问题规范
- **统一响应数据类**: 所有接口返回的数据类都是 `com.origin.common.dto.ResultData<T>`
- **统一实体类**: 所有数据库表的实体类都依赖 `BaseEntity`
- **工具类管理**: 工具类优先放在 `service-common` 模块做公用类
- **异常处理分层**: base包的异常处理仅处理通用基础异常，每个微服务的异常处理在各自模块中实现

### 4.4 数据库规范
- **表命名**: 模块前缀_表名，如 `user_profile`
- **字段命名**: 下划线命名法
- **主键**: 统一使用UUID作为主键
- **软删除**: 重要数据使用软删除，保留删除标记
- **开发规范**: 遵循 `infra/database/MySQL数据开发规范.md`

## 5. 部署架构

### 5.1 环境划分
- **开发环境**: 本地开发环境
- **测试环境**: 集成测试环境
- **生产环境**: 正式运行环境

### 5.2 容器化部署
- **Docker**: 每个服务打包为Docker镜像
- **Docker Compose**: 本地开发环境使用Docker Compose
- **Kubernetes**: 生产环境使用Kubernetes编排

### 5.3 监控运维
- **日志**: 统一日志收集和分析
- **监控**: 服务性能监控、健康检查
- **告警**: 异常情况自动告警

## 6. 模块开发流程

### 6.1 新建模块流程
1. **模块主体讨论**: 明确模块需求和功能范围
2. **功能拆分**: 将需求拆分为具体的功能点
3. **设计模板**: 生成模块设计文档
4. **API设计**: 设计API接口文档
5. **开发实现**: 按照设计进行代码开发

### 6.2 模块迭代流程
1. **迭代需求**: 明确迭代需求和功能扩展
2. **功能分析**: 分析新功能点和技术方案
3. **迭代设计**: 生成迭代设计文档
4. **开发实现**: 实现新功能并集成
5. **文档更新**: 同步更新相关文档

## 7. 文档管理

### 7.1 文档结构
```
infra/moudleDocs/
├── 微服务总体设计框架.md          # 本文档
├── 数据库建表语句和表说明.md      # 数据库设计文档
├── {模块名称}/
│   ├── 模块主体讨论.md           # 模块需求讨论
│   ├── 模块设计.md              # 模块设计文档
│   ├── API接口说明.md           # API接口文档
│   ├── API接口测试.md           # API测试文档
│   ├── 模块迭代说明.md          # 迭代需求说明
│   └── 模块迭代设计.md          # 迭代设计文档
└── 模板文件/
    ├── xxxxxx-design_templates.md
    ├── xxxxxx-api-test-template.md
    └── xxxxxx-development-template.md
```

### 7.2 文档更新规范
- **设计变更**: 任何设计变更必须更新相应文档
- **版本控制**: 文档版本与代码版本保持一致
- **评审机制**: 重要文档变更需要团队评审

## 8. 质量保证

### 8.1 代码质量
- **代码审查**: 所有代码必须经过审查
- **单元测试**: 核心业务逻辑必须有单元测试
- **集成测试**: 服务间集成必须有测试用例
- **规范检查**: 确保遵循DEV-012统一响应数据类和实体类规范

### 8.2 规范合规性检查
- **响应格式检查**: 所有Controller方法必须返回 `ResultData<T>` 类型
- **实体类检查**: 所有Entity类必须继承 `BaseEntity`
- **异常处理检查**: 微服务模块必须有独立的异常处理器
- **工具类检查**: 通用工具类必须放在 `service-common` 模块

### 8.3 性能要求
- **响应时间**: API响应时间 < 500ms
- **并发能力**: 支持1000+并发用户
- **可用性**: 系统可用性 > 99.9%

### 8.4 安全要求
- **数据安全**: 敏感数据加密存储
- **接口安全**: 接口访问权限控制
- **审计日志**: 重要操作记录审计日志

## 9. 开发规则参考

### 9.1 核心开发规则
- **DEV-012**: 统一响应数据类和实体类规范
- **DEV-001**: 基础开发规范
- **DEV-005**: 错误处理规范
- **DEV-010**: Lombok @Data注解使用规范
- **LR-002**: 模块设计优先规则

## 10. 扩展性设计

### 10.1 水平扩展
- **无状态设计**: 服务设计为无状态，支持水平扩展
- **负载均衡**: 通过网关实现负载均衡
- **数据库扩展**: 支持读写分离、分库分表

### 10.2 功能扩展
- **插件化**: 支持功能模块的插件化扩展
- **配置化**: 通过配置文件控制功能开关
- **版本兼容**: 保证API的向后兼容性

## 11. 总结

本微服务总体设计框架为半语积分商城项目提供了完整的架构指导，包括：
- 清晰的服务划分和职责定义
- 标准化的技术栈和开发规范
- 完整的开发流程和文档管理
- 严格的质量保证和扩展性设计
- 统一的核心关键问题规范（响应数据类、实体类、工具类、异常处理）

所有模块开发都应遵循本框架的设计原则和规范要求，确保系统的整体一致性和可维护性。 