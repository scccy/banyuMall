# third-party-oss 模块主体讨论

> **文档位置**: `infra/moudleDocs/third-party-oss/模块主体讨论.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 微服务模块级别信息

### 模块层级结构
- **当前微服务模块级别**: 三级微服务
- **父模块**: third-party (二级模块 - 第三方业务模块)
- **模块类型**: 文件存储服务
- **服务端口**: 8085
- **基础路径**: `/tp/oss`

### 模块定位
third-party-oss模块是BanyuMall积分商城系统的第三方OSS文件存储服务模块。在微服务架构中，各个微服务模块都需要处理文件上传、存储和管理功能，为了避免重复开发和提高系统的一致性，需要一个统一的文件存储服务来提供这些功能。该模块负责提供文件存储服务，集成阿里云OSS，支持图片、文档等文件的上传、下载、管理。

## 1. 模块概述

### 1.1 模块背景
third-party-oss模块是BanyuMall积分商城系统的第三方OSS文件存储服务模块。在微服务架构中，各个微服务模块都需要处理文件上传、存储和管理功能，为了避免重复开发和提高系统的一致性，需要一个统一的文件存储服务来提供这些功能。该模块负责提供文件存储服务，集成阿里云OSS，支持图片、文档等文件的上传、下载、管理。

### 1.2 模块目标
- 为整个微服务架构提供统一的文件存储服务
- 集成阿里云OSS，提供可靠的文件存储能力
- 提供文件去重功能，避免重复存储
- 统一管理文件存储，简化其他服务的文件处理
- 提供文件访问日志，支持审计和统计
- 确保文件存储的安全性和可靠性

### 1.3 模块范围
- **文件上传**: 支持多种格式文件的上传
- **文件下载**: 提供文件下载和访问服务
- **文件管理**: 文件信息管理和路径组织
- **文件去重**: 基于MD5哈希值的文件去重
- **访问日志**: 文件访问记录和统计
- **Feign客户端**: 为其他服务提供统一的文件存储接口

## 2. 需求分析

### 2.1 业务需求
1. **文件存储需求**
   - 支持图片、文档等多种文件格式上传
   - 提供可靠的文件存储和访问服务
   - 支持文件路径的灵活组织和管理
   - 提供文件去重功能，节省存储空间

2. **服务集成需求**
   - 为其他微服务提供统一的文件存储接口
   - 支持Feign客户端调用
   - 提供完整的文件管理功能
   - 支持文件访问权限控制

3. **监控审计需求**
   - 记录文件上传和访问日志
   - 提供文件使用统计和分析
   - 支持文件访问审计
   - 提供存储空间使用情况监控

4. **安全需求**
   - 文件上传安全验证
   - 文件访问权限控制
   - 防止恶意文件上传
   - 文件存储加密保护

### 2.2 功能需求
1. **文件上传功能**
   - 单文件上传
   - 批量文件上传
   - 文件格式验证
   - 文件大小限制

2. **文件管理功能**
   - 文件信息查询
   - 文件路径管理
   - 文件删除功能
   - 文件重命名功能

3. **文件访问功能**
   - 文件下载
   - 文件预览
   - 访问URL生成
   - 访问权限控制

4. **日志统计功能**
   - 上传日志记录
   - 访问日志记录
   - 使用统计报表
   - 存储空间统计

### 2.3 非功能需求
1. **性能需求**
   - 文件上传响应时间 < 5秒
   - 文件下载响应时间 < 3秒
   - 支持并发文件上传
   - 高可用性保证

2. **安全需求**
   - 文件上传安全验证
   - 文件访问权限控制
   - 防止恶意文件上传
   - 文件存储加密保护

3. **可用性需求**
   - 系统可用性 > 99.9%
   - 支持文件备份和恢复
   - 提供完整的API文档
   - 支持服务监控和告警

## 3. 技术方案

### 3.1 技术选型
- **框架**: Spring Boot 3.x + Spring Cloud
- **存储**: 阿里云OSS SDK
- **数据库**: MySQL 8.0 + MyBatis-Plus
- **缓存**: Redis
- **文档**: Knife4j (Swagger)
- **服务调用**: OpenFeign

### 3.2 架构设计
- **微服务架构**: 独立的文件存储服务
- **分层设计**: Controller -> Service -> Mapper -> Database
- **OSS集成**: 集成阿里云OSS对象存储
- **Feign客户端**: 为其他服务提供统一接口

### 3.3 数据设计
- **文件存储记录**: 记录文件基本信息和存储路径
- **访问日志**: 记录文件访问情况和统计信息
- **元数据管理**: 管理文件元数据和业务信息

## 4. 接口设计

### 4.1 接口分类
- **文件上传接口**: 处理文件上传请求
- **文件下载接口**: 处理文件下载请求
- **文件管理接口**: 文件信息查询和管理
- **统计接口**: 文件使用统计和报表

### 4.2 接口规范
- **基础路径**: `/tp/oss`
- **请求方法**: GET、POST、PUT、DELETE
- **数据格式**: JSON、Multipart
- **认证方式**: JWT Token
- **错误处理**: 统一错误响应格式

### 4.3 接口列表
1. **文件上传接口**
   - POST `/tp/oss/upload` - 单文件上传
   - POST `/tp/oss/upload/batch` - 批量文件上传

2. **文件下载接口**
   - GET `/tp/oss/download/{fileId}` - 文件下载
   - GET `/tp/oss/preview/{fileId}` - 文件预览

3. **文件管理接口**
   - GET `/tp/oss/file/{fileId}` - 获取文件信息
   - GET `/tp/oss/file/list` - 文件列表查询
   - DELETE `/tp/oss/file/{fileId}` - 删除文件

4. **统计接口**
   - GET `/tp/oss/stats/upload` - 上传统计
   - GET `/tp/oss/stats/access` - 访问统计

## 5. 安全设计

### 5.1 文件安全
- **文件类型验证**: 限制允许上传的文件类型
- **文件大小限制**: 限制文件上传大小
- **文件内容检查**: 检查文件内容安全性
- **访问权限控制**: 控制文件访问权限

### 5.2 接口安全
- **身份认证**: JWT Token认证
- **权限验证**: 基于角色的权限控制
- **请求限流**: 防止恶意请求
- **参数验证**: 严格的参数验证

### 5.3 存储安全
- **OSS安全**: 阿里云OSS安全配置
- **数据加密**: 敏感数据加密存储
- **访问日志**: 完整的访问日志记录
- **备份策略**: 文件备份和恢复策略

## 6. 性能优化

### 6.1 上传优化
- **分片上传**: 大文件分片上传
- **并发控制**: 合理的并发上传控制
- **压缩传输**: 文件压缩传输
- **缓存策略**: 上传结果缓存

### 6.2 下载优化
- **CDN加速**: 使用CDN加速文件下载
- **断点续传**: 支持断点续传下载
- **压缩传输**: 文件压缩传输
- **缓存策略**: 下载结果缓存

### 6.3 存储优化
- **文件去重**: 基于MD5的文件去重
- **存储分层**: 热冷数据分层存储
- **压缩存储**: 文件压缩存储
- **清理策略**: 定期清理无用文件

## 7. 监控和日志

### 7.1 监控指标
- **上传性能**: 监控文件上传性能
- **下载性能**: 监控文件下载性能
- **存储使用**: 监控存储空间使用情况
- **访问统计**: 监控文件访问情况

### 7.2 日志记录
- **上传日志**: 记录文件上传日志
- **下载日志**: 记录文件下载日志
- **访问日志**: 记录文件访问日志
- **错误日志**: 记录系统错误日志

## 8. 部署和运维

### 8.1 部署配置
- **环境配置**: 开发、测试、生产环境配置
- **OSS配置**: 阿里云OSS配置
- **数据库配置**: MySQL数据库配置
- **缓存配置**: Redis缓存配置

### 8.2 运维支持
- **监控告警**: 集成监控和告警系统
- **日志收集**: 集成日志收集系统
- **备份恢复**: 文件备份和恢复策略
- **扩容缩容**: 支持水平扩容和缩容

## 9. 测试策略

### 9.1 单元测试
- **服务层测试**: 测试业务逻辑
- **控制器测试**: 测试接口功能
- **工具类测试**: 测试工具方法
- **异常处理测试**: 测试异常处理

### 9.2 集成测试
- **OSS集成测试**: 测试OSS集成功能
- **数据库测试**: 测试数据库操作
- **Feign测试**: 测试Feign客户端
- **文件操作测试**: 测试文件操作功能

### 9.3 性能测试
- **上传性能测试**: 测试文件上传性能
- **下载性能测试**: 测试文件下载性能
- **并发测试**: 测试并发访问性能
- **压力测试**: 测试系统承载能力

## 10. 文档和规范

### 10.1 代码规范
- **编码规范**: 遵循阿里巴巴Java开发手册
- **注释规范**: 完整的代码注释和文档
- **命名规范**: 统一的命名规范和约定
- **版本控制**: 规范的Git提交和分支管理

### 10.2 文档规范
- **API文档**: 完整的API接口文档
- **设计文档**: 详细的设计和架构文档
- **部署文档**: 完整的部署和运维文档
- **使用文档**: 文件存储使用说明文档 