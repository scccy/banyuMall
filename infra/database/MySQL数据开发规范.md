# MySQL数据开发规范

> **文档位置**: `infra/database/MySQL数据开发规范.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 1. 概述

### 1.1 规范目的
本规范旨在统一MySQL数据库开发标准，确保数据库设计的一致性、可维护性和性能优化。

### 1.2 适用范围
- 所有微服务模块的数据库设计
- 表结构创建和修改
- 索引设计
- 数据迁移脚本

### 1.3 技术栈
- **数据库版本**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_0900_bin
- **存储引擎**: InnoDB

## 2. 命名规范

### 2.1 数据库命名
- **命名规则**: 使用小写字母，下划线分隔
- **命名格式**: `{项目前缀}_{环境标识}`
- **示例**: `banyu_mall`、`banyu_mall_dev`、`banyu_mall_test`

### 2.2 表命名
- **命名规则**: 使用小写字母，下划线分隔
- **命名格式**: `{模块前缀}_{表名}`
- **示例**: `user_profile`、`publisher_task`、`sys_permission`

### 2.3 字段命名
- **命名规则**: 使用小写字母，下划线分隔
- **命名格式**: `{字段描述}`
- **示例**: `user_name`、`create_time`、`is_deleted`

### 2.4 索引命名
- **主键索引**: 自动生成，无需命名
- **唯一索引**: `uk_{表名}_{字段名}`
- **普通索引**: `idx_{表名}_{字段名}`
- **复合索引**: `idx_{表名}_{字段1}_{字段2}`
- **示例**: `uk_user_username`、`idx_user_create_time`

## 3. 表结构设计规范

### 3.1 通用字段规范
所有表都必须包含以下通用字段：

```sql
`{表名}_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
`created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
`updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
`created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
`updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
`deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除'
```

### 3.2 主键设计
- **主键类型**: 统一使用 VARCHAR(32)
- **主键生成**: 使用雪花算法生成UUID
- **主键约束**: 必须设置为主键，不允许为空

### 3.3 字段类型选择

#### 3.3.1 字符串类型
- **VARCHAR**: 变长字符串，最大长度65535
- **CHAR**: 定长字符串，适用于固定长度字段
- **TEXT**: 长文本，适用于大段文本内容
- **JSON**: JSON格式数据，MySQL 5.7+

#### 3.3.2 数值类型
- **TINYINT**: 小整数，-128到127
- **INT**: 整数，-2147483648到2147483647
- **BIGINT**: 大整数，适用于ID字段
- **DECIMAL**: 精确小数，适用于金额等精确计算

#### 3.3.3 时间类型
- **DATE**: 日期，格式：YYYY-MM-DD
- **DATETIME**: 日期时间，格式：YYYY-MM-DD HH:MM:SS
- **TIMESTAMP**: 时间戳，自动更新

### 3.4 字段约束
- **NOT NULL**: 必填字段必须设置
- **DEFAULT**: 为字段设置默认值
- **COMMENT**: 每个字段必须有中文注释
- **UNIQUE**: 唯一约束，防止重复数据

## 4. 索引设计规范

### 4.1 索引类型
- **主键索引**: 每个表必须有主键索引
- **唯一索引**: 业务唯一字段建立唯一索引
- **普通索引**: 常用查询字段建立普通索引
- **复合索引**: 多字段查询建立复合索引

### 4.2 索引设计原则
- **选择性**: 优先选择选择性高的字段建立索引
- **覆盖索引**: 查询字段尽量被索引覆盖
- **最左前缀**: 复合索引遵循最左前缀原则
- **索引数量**: 单表索引数量不超过5个

### 4.3 索引优化
- **避免冗余**: 避免创建重复或冗余的索引
- **定期维护**: 定期分析索引使用情况
- **性能监控**: 监控索引对查询性能的影响

## 5. 表设计规范

### 5.1 表结构示例
```sql
CREATE TABLE `user_profile` (
    `id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `user_id` VARCHAR(32) NOT NULL COMMENT '用户ID',
    `nickname` VARCHAR(50) DEFAULT NULL COMMENT '昵称',
    `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
    `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    `birthday` DATE DEFAULT NULL COMMENT '生日',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_id` (`user_id`),
    KEY `idx_nickname` (`nickname`),
    KEY `idx_created_time` (`created_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户档案表';
```

### 5.2 表设计原则
- **单一职责**: 每个表只负责一个业务实体
- **范式设计**: 遵循第三范式，避免数据冗余
- **扩展性**: 考虑未来业务扩展需求
- **性能**: 考虑查询和写入性能

## 6. 数据完整性规范

### 6.1 外键约束
- **谨慎使用**: 在高并发场景下谨慎使用外键约束
- **应用层控制**: 优先在应用层控制数据完整性
- **性能影响**: 外键约束会影响插入和更新性能

### 6.2 数据验证
- **应用层验证**: 在应用层进行数据格式验证
- **数据库约束**: 使用CHECK约束进行数据范围验证
- **触发器**: 必要时使用触发器进行数据一致性控制

### 6.3 软删除
- **统一实现**: 所有重要数据使用软删除
- **删除标记**: 使用deleted字段标记删除状态
- **查询过滤**: 查询时自动过滤已删除数据

## 7. 性能优化规范

### 7.1 查询优化
- **索引优化**: 为常用查询字段建立合适的索引
- **SQL优化**: 避免使用SELECT *，只查询需要的字段
- **分页查询**: 使用LIMIT进行分页，避免OFFSET过大

### 7.2 写入优化
- **批量操作**: 使用批量插入和更新提高性能
- **事务控制**: 合理控制事务范围，避免长事务
- **并发控制**: 使用乐观锁或悲观锁控制并发

### 7.3 存储优化
- **字段类型**: 选择合适的字段类型，避免浪费存储空间
- **索引优化**: 定期维护索引，删除无用索引
- **表分区**: 大表考虑使用分区表提高性能

## 8. 安全规范

### 8.1 访问控制
- **最小权限**: 数据库用户使用最小权限原则
- **连接限制**: 限制数据库连接来源和数量
- **密码策略**: 使用强密码，定期更换

### 8.2 数据加密
- **敏感数据**: 对敏感数据进行加密存储
- **传输加密**: 使用SSL/TLS加密数据传输
- **备份加密**: 对数据库备份文件进行加密

### 8.3 审计日志
- **操作日志**: 记录重要数据操作日志
- **访问日志**: 记录数据库访问日志
- **异常监控**: 监控异常访问和操作

## 9. 开发流程规范

### 9.1 表结构变更
1. **需求分析**: 明确变更需求和影响范围
2. **设计评审**: 进行表结构设计评审
3. **变更脚本**: 编写数据库变更脚本
4. **测试验证**: 在测试环境验证变更
5. **生产部署**: 在生产环境执行变更

### 9.2 版本管理
- **版本号**: 使用语义化版本号管理数据库变更
- **变更记录**: 详细记录每次变更内容
- **回滚方案**: 准备变更回滚方案

### 9.3 文档维护
- **设计文档**: 维护表结构设计文档
- **变更记录**: 记录数据库变更历史
- **使用说明**: 提供数据库使用说明

## 10. 检查清单

### 10.1 表结构检查
- [ ] 表名是否符合命名规范
- [ ] 字段名是否符合命名规范
- [ ] 是否包含所有必需字段
- [ ] 字段类型是否合适
- [ ] 是否设置了合适的约束
- [ ] 是否添加了字段注释

### 10.2 索引检查
- [ ] 是否设置了主键索引
- [ ] 唯一字段是否设置了唯一索引
- [ ] 查询字段是否设置了普通索引
- [ ] 复合索引是否遵循最左前缀原则
- [ ] 索引数量是否合理

### 10.3 性能检查
- [ ] 是否避免了全表扫描
- [ ] 是否优化了慢查询
- [ ] 是否控制了事务范围
- [ ] 是否使用了批量操作

### 10.4 安全检查
- [ ] 是否设置了访问权限
- [ ] 敏感数据是否加密
- [ ] 是否记录了操作日志
- [ ] 是否准备了回滚方案

## 11. 总结

本MySQL数据开发规范提供了：
- 完整的命名规范
- 详细的表结构设计规范
- 索引设计原则
- 性能优化指南
- 安全规范要求
- 开发流程规范

所有数据库开发工作都应遵循本规范，确保数据库设计的一致性、可维护性和性能优化。