# Third Party OSS 模块设计文档

## 📋 模块概述

**模块名称**: third-party-aliyunOss  
**模块类型**: 第三方服务  
**技术栈**: Spring Boot + MyBatis Plus + Aliyun OSS SDK + Nacos  
**作者**: scccy  
**创建时间**: 2025-01-27  

### 模块职责
- **文件上传**: 提供文件上传到阿里云OSS的功能
- **文件访问**: 提供文件访问URL生成和管理
- **文件删除**: 提供文件删除功能
- **批量操作**: 支持批量文件上传
- **文件管理**: 管理文件存储记录和访问日志
- **路径生成**: 根据业务需求生成文件存储路径

## 🏗️ 架构设计

### 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微服务集群     │───▶│  Third Party OSS │───▶│   阿里云OSS     │
│                │    │                │    │                │
│ - core-publisher│    │ - 文件上传      │    │ - 对象存储      │
│ - service-user  │    │ - 文件访问      │    │ - 访问控制      │
│ - service-auth  │    │ - 文件删除      │    │ - 数据备份      │
└─────────────────┘    │ - 批量操作      │    └─────────────────┘
                       │ - 路径管理      │
                       └─────────────────┘
                               │
                               ▼
                       ┌─────────────────┐
                       │   数据库        │
                       │                │
                       │ - oss_file_storage│
                       │ - oss_file_access_log│
                       └─────────────────┘
```

### 核心组件
1. **AliyunOssApplication**: OSS服务启动类
2. **OssFileController**: 文件操作控制器
3. **OssFileService**: 文件服务接口
4. **OssFileStorage**: 文件存储记录实体
5. **OssFileAccessLog**: 文件访问日志实体

## 🔧 核心功能

### 1. 文件上传
- **单文件上传**: 上传单个文件到OSS
- **批量文件上传**: 批量上传多个文件
- **文件验证**: 验证文件类型、大小等
- **路径生成**: 自动生成文件存储路径
- **元数据记录**: 记录文件上传元数据

### 2. 文件访问
- **URL生成**: 生成文件访问URL
- **访问控制**: 控制文件访问权限
- **访问日志**: 记录文件访问日志
- **缓存优化**: 优化文件访问性能

### 3. 文件删除
- **逻辑删除**: 支持逻辑删除文件记录
- **物理删除**: 从OSS中物理删除文件
- **权限验证**: 验证删除权限
- **删除日志**: 记录删除操作日志

### 4. 文件管理
- **存储记录**: 管理文件存储记录
- **访问统计**: 统计文件访问情况
- **空间管理**: 管理存储空间使用
- **备份策略**: 文件备份和恢复

## 📊 数据模型

### 1. OssFileStorage (文件存储记录表)
```java
public class OssFileStorage {
    private Long id;                    // 主键ID
    private String originalName;        // 原始文件名
    private Long fileSize;              // 文件大小(字节)
    private String mimeType;            // MIME类型
    private String objectKey;           // OSS对象键
    private String accessUrl;           // 文件访问URL
    private String bucketName;          // OSS存储桶名称
    private String filePath;            // 文件路径
    private String sourceService;       // 来源服务
    private String businessType;        // 业务类型
    private Long uploadUserId;          // 上传用户ID
    private String uploadUserName;      // 上传用户名
    private LocalDateTime uploadTime;   // 上传时间
    private LocalDateTime createdTime;  // 创建时间
    private LocalDateTime updatedTime;  // 更新时间
    private Integer deleted;            // 逻辑删除标识
}
```

### 2. OssFileAccessLog (文件访问日志表)
```java
public class OssFileAccessLog {
    private Long id;                    // 主键ID
    private Long fileId;                // 文件ID
    private String accessUrl;           // 访问URL
    private String accessIp;            // 访问IP
    private String userAgent;           // 用户代理
    private String referer;             // 来源页面
    private LocalDateTime accessTime;   // 访问时间
    private Integer accessResult;       // 访问结果
    private String errorMessage;        // 错误信息
    private LocalDateTime createdTime;  // 创建时间
}
```

## 🔗 Feign客户端接口

### 无Feign客户端
本模块作为第三方服务，不包含Feign客户端，其他服务通过HTTP请求调用本模块的接口。

## ⚙️ 配置说明

### 应用配置
```yaml
# 应用名称
spring:
  application:
    name: third-party-aliyunOss
  
  # 数据源配置
  datasource:
    url: jdbc:mysql://localhost:3306/third_party
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver

# MyBatis Plus配置
mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.origin.oss.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# 阿里云OSS配置
aliyun:
  oss:
    endpoint: ${OSS_ENDPOINT}
    access-key-id: ${OSS_ACCESS_KEY_ID}
    access-key-secret: ${OSS_ACCESS_KEY_SECRET}
    bucket-name: ${OSS_BUCKET_NAME}
    url-expiration: 3600  # URL过期时间(秒)
    max-file-size: 104857600  # 最大文件大小(100MB)
    allowed-file-types: jpg,jpeg,png,gif,pdf,doc,docx,xls,xlsx,zip,rar
```

### Nacos配置
- **服务发现**: 自动注册到Nacos注册中心
- **配置中心**: 从Nacos加载动态配置
- **负载均衡**: 使用Spring Cloud LoadBalancer

## 🔄 业务流程

### 1. 文件上传流程
```
1. 接收文件上传请求
   ↓
2. 验证文件类型和大小
   ↓
3. 生成文件存储路径
   ↓
4. 上传文件到OSS
   ↓
5. 记录文件存储信息
   ↓
6. 返回文件访问信息
```

### 2. 文件访问流程
```
1. 接收文件访问请求
   ↓
2. 验证文件是否存在
   ↓
3. 生成访问URL
   ↓
4. 记录访问日志
   ↓
5. 返回访问URL
```

### 3. 文件删除流程
```
1. 接收文件删除请求
   ↓
2. 验证删除权限
   ↓
3. 从OSS删除文件
   ↓
4. 更新数据库记录
   ↓
5. 记录删除日志
```

## 🚨 异常处理与错误码

### 1. 异常处理机制
- **统一异常处理**: 使用`@ControllerAdvice`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 处理系统级异常和网络异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 2. 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 413 | 文件过大 | 文件大小超过限制 |
| 415 | 文件类型不支持 | 不支持的文件类型 |
| 500 | 系统错误 | 系统内部错误 |
| 503 | 服务不可用 | OSS服务不可用 |

#### 第三方服务通用错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 4000 | 第三方服务错误 | 第三方服务通用错误 |
| 4001 | 第三方服务不可用 | 第三方服务不可用 |
| 4002 | 第三方服务超时 | 第三方服务超时 |
| 4003 | 第三方服务配置错误 | 第三方服务配置错误 |

#### OSS服务错误码 (41xx)
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 4101 | OSS服务错误 | OSS服务内部错误 |
| 4102 | OSS上传错误 | OSS文件上传失败 |
| 4103 | OSS下载错误 | OSS文件下载失败 |
| 4104 | OSS删除错误 | OSS文件删除失败 |
| 4105 | OSS访问被拒绝 | OSS访问权限不足 |
| 4106 | OSS存储桶不存在 | 指定的存储桶不存在 |
| 4107 | OSS对象不存在 | 指定的对象不存在 |
| 4108 | OSS配额超限 | OSS存储配额超限 |
| 4109 | 文件上传失败 | 文件上传到OSS失败 |
| 4110 | 文件下载失败 | 从OSS下载文件失败 |
| 4111 | 文件删除失败 | 从OSS删除文件失败 |
| 4112 | 文件访问被拒绝 | OSS文件访问权限不足 |
| 4113 | 文件大小超限 | 文件大小超过限制 |
| 4114 | 文件类型不支持 | 不支持的文件类型 |
| 4115 | 文件路径无效 | 文件路径格式错误 |
| 4116 | 文件已存在 | 文件已存在，不允许覆盖 |
| 4117 | 文件损坏 | 文件已损坏或格式错误 |

### 3. 异常处理流程
```
1. 异常发生
   ↓
2. 异常拦截器捕获
   ↓
3. 异常分类处理
   ↓
4. 错误码映射
   ↓
5. 错误信息格式化
   ↓
6. 返回统一错误响应
```

## 📊 监控与日志

### 日志配置
- **日志框架**: Log4j2
- **日志级别**: INFO (生产环境)
- **日志文件**: logs/third-party-aliyunOss.log
- **日志轮转**: 100MB/文件，保留30天

### 监控指标
- **文件上传成功率**: 文件上传成功次数/总上传次数
- **文件访问成功率**: 文件访问成功次数/总访问次数
- **存储空间使用率**: 已使用存储空间/总存储空间
- **平均响应时间**: 接口平均响应时间

## 🔒 安全考虑

### 文件安全
- **文件类型验证**: 严格验证文件类型
- **文件大小限制**: 限制文件上传大小
- **恶意文件检测**: 检测恶意文件
- **访问权限控制**: 控制文件访问权限

### 接口安全
- **参数验证**: 所有输入参数进行严格验证
- **访问频率限制**: 限制接口访问频率
- **IP白名单**: 支持IP白名单控制
- **数据加密**: 敏感数据传输加密

## 🚀 部署说明

### 环境要求
- **JDK版本**: 21
- **内存要求**: 最小1GB，推荐2GB
- **端口**: 8084

### 启动命令
```bash
# 开发环境
java -jar third-party-aliyunOss.jar --spring.profiles.active=dev

# 生产环境
java -jar third-party-aliyunOss.jar --spring.profiles.active=prod
```

### 依赖服务
- **MySQL数据库**: 存储文件记录和访问日志
- **Nacos注册中心**: 服务注册与发现
- **阿里云OSS**: 对象存储服务

## 📝 注意事项

### 性能优化
1. **文件上传优化**: 支持分片上传大文件
2. **访问优化**: 使用CDN加速文件访问
3. **缓存策略**: 缓存热点文件访问信息
4. **异步处理**: 非关键操作使用异步处理

### 扩展性
1. **存储扩展**: 支持多种存储后端
2. **文件处理**: 支持文件格式转换
3. **访问控制**: 支持多种访问控制策略
4. **监控告警**: 支持自定义监控告警

### 维护性
1. **代码规范**: 遵循统一的代码规范
2. **文档同步**: 及时更新接口文档
3. **版本管理**: 合理的版本管理策略
4. **备份策略**: 定期备份重要数据

---

**文档版本**: v1.0  
**最后更新**: 2025-01-27  
**维护人员**: scccy 