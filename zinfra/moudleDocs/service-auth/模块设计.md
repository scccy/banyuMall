# service-auth 模块设计文档

## 📋 模块概述

### 基本信息
- **模块名称**: service-auth
- **模块类型**: 微服务模块
- **主要职责**: 用户认证、JWT令牌管理、密码加密验证、用户信息管理
- **技术栈**: Spring Boot + Spring Security + JWT + MyBatis Plus + Redis
- **作者**: scccy
- **创建时间**: 2025-07-31

### 设计理念
service-auth模块作为系统的认证中心，负责所有用户的身份验证和授权管理。采用JWT令牌机制实现无状态认证，支持分布式部署。模块设计遵循单一职责原则，专注于认证相关的核心功能。

## 🏗️ 架构设计

### 核心架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │     Service     │    │     Mapper      │
│                 │    │                 │    │                 │
│ AuthController  │───▶│  AuthService    │───▶│  SysUserMapper  │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Interceptor   │    │      Util       │    │    Database     │
│                 │    │                 │    │                 │
│ JwtInterceptor  │    │  JwtUtil        │    │    sys_user     │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 业务模型
```
用户登录流程:
1. 客户端发送登录请求
2. 验证用户名密码
3. 生成JWT令牌
4. 返回用户信息和令牌

令牌验证流程:
1. 客户端携带JWT令牌
2. 验证令牌有效性
3. 提取用户信息
4. 返回验证结果
```

## 📁 目录结构

```
service-auth/
├── src/main/java/com/origin/auth/
│   ├── controller/
│   │   └── AuthController.java              # 认证控制器
│   ├── service/
│   │   ├── AuthService.java                 # 认证服务接口
│   │   ├── SysUserService.java              # 用户服务接口
│   │   └── impl/
│   │       ├── AuthServiceImpl.java         # 认证服务实现
│   │       └── SysUserServiceImpl.java      # 用户服务实现
│   ├── entity/
│   │   └── SysUser.java                     # 用户实体类
│   ├── mapper/
│   │   └── SysUserMapper.java               # 用户数据访问层
│   ├── dto/
│   │   ├── LoginRequest.java                # 登录请求DTO
│   │   ├── LoginResponse.java               # 登录响应DTO
│   │   └── PasswordEncryptRequest.java      # 密码加密请求DTO
│   ├── util/
│   │   └── JwtUtil.java                     # JWT工具类
│   ├── interceptor/
│   │   └── JwtInterceptor.java              # JWT拦截器
│   ├── exception/
│   │   └── AuthExceptionHandler.java        # 认证异常处理
│   ├── config/
│   │   ├── SecurityConfig.java              # 安全配置
│   │   └── AuthWebMvcConfig.java            # Web配置
│   └── ServiceAuthApplication.java          # 启动类
└── src/main/resources/
    ├── application.yml                      # 配置文件
    └── mapper/
        └── SysUserMapper.xml                # MyBatis映射文件
```

## 🔧 核心组件

### 1. 控制器 (AuthController)

#### 主要接口
```java
@RestController
@RequestMapping("/service/auth")
public class AuthController {
    
    // 用户登录
    @PostMapping("/login")
    public ResultData<LoginResponse> login(@RequestBody @Validated LoginRequest loginRequest);
    
    // 用户登出
    @PostMapping("/logout")
    public ResultData<String> logout(HttpServletRequest request);
    
    // 强制登出用户
    @PostMapping("/logout/force/{userId}")
    public ResultData<String> forceLogout(@PathVariable String userId);
    
    // 密码加密
    @PostMapping("/password/encrypt")
    public ResultData<PasswordEncryptResponse> encryptPassword(@RequestBody PasswordEncryptRequest request);
    
    // 密码验证
    @PostMapping("/password/verify")
    public ResultData<Boolean> verifyPassword(@RequestBody PasswordEncryptRequest request);
    
    // 获取用户信息
    @GetMapping("/user/info")
    public ResultData<SysUser> getUserInfo(@RequestParam("userId") String userId);
    
    // 验证JWT令牌
    @PostMapping("/validate")
    public ResultData<Boolean> validateToken(@RequestParam("token") String token);
    
    // 健康检查
    @GetMapping("/test")
    public ResultData<String> test(HttpServletRequest request);
}
```

#### 接口说明
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户登录 | POST | `/service/auth/login` | 处理用户登录请求，返回JWT令牌 |
| 用户登出 | POST | `/service/auth/logout` | 处理用户登出请求，清除会话 |
| 强制登出 | POST | `/service/auth/logout/force/{userId}` | 管理员强制登出指定用户 |
| 密码加密 | POST | `/service/auth/password/encrypt` | 为其他服务提供密码加密功能 |
| 密码验证 | POST | `/service/auth/password/verify` | 为其他服务提供密码验证功能 |
| 获取用户信息 | GET | `/service/auth/user/info` | 为其他服务提供用户信息查询 |
| 验证JWT令牌 | POST | `/service/auth/validate` | 为其他服务提供JWT令牌验证 |
| 健康检查 | GET | `/service/auth/test` | 服务健康检查接口 |

### 2. 服务层 (AuthService)

#### 核心方法
```java
public interface AuthService {
    
    // 用户登录
    LoginResponse login(LoginRequest loginRequest);
    
    // 用户登出
    void logout(String token);
    
    // 强制登出用户
    void forceLogout(String userId);
}
```

#### 业务逻辑
```java
// 登录业务逻辑
public LoginResponse login(LoginRequest loginRequest) {
    // 1. 验证用户名密码
    // 2. 生成JWT令牌
    // 3. 记录登录日志
    // 4. 返回用户信息和令牌
}
```

### 3. Feign客户端列表

#### 依赖的外部服务
| 服务名称 | Feign客户端 | 主要用途 | 接口路径 |
|----------|-------------|----------|----------|
| 无 | 无 | 认证服务为其他服务提供认证功能，不依赖外部服务 | 无 |

#### Feign客户端接口
本模块不包含Feign客户端，主要为其他微服务提供认证服务。

### 4. 工具类 (JwtUtil)

#### 核心功能
```java
@Component
public class JwtUtil {
    
    // 生成JWT令牌
    public String generateToken(String userId, String username);
    
    // 验证JWT令牌
    public boolean validateToken(String token);
    
    // 从令牌中提取用户ID
    public String getUserIdFromToken(String token);
    
    // 从令牌中提取用户名
    public String getUsernameFromToken(String token);
}
```

### 5. 拦截器 (JwtInterceptor)

#### 拦截逻辑
```java
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. 提取JWT令牌
        // 2. 验证令牌有效性
        // 3. 设置用户上下文
        // 4. 记录访问日志
        
        return true;
    }
}
```

## 🗄️ 数据模型

### 实体类 (SysUser)
```java
@Data
@TableName("sys_user")
public class SysUser extends BaseEntity {
    
    @TableId(value = "user_id", type = IdType.ASSIGN_ID)
    private String userId;                    // 用户ID
    
    private String phone;                     // 手机号
    private String wechatId;                  // 微信用户ID
    private String youzanId;                  // 有赞用户ID
    private String username;                  // 用户名
    private String password;                  // 密码（加密）
    private String nickname;                  // 昵称
    private String avatar;                    // 头像URL
    private String email;                     // 邮箱
    private Integer gender;                   // 性别：0-未知，1-男，2-女
    private LocalDate birthday;               // 生日
    private Integer status;                   // 用户状态
    private Integer userType;                 // 用户类型
    private String profileId;                 // 扩展信息ID
    private LocalDateTime lastLoginTime;      // 最后登录时间
}
```

### DTO设计

#### 请求DTO (LoginRequest)
```java
@Data
public class LoginRequest {
    private String username;                  // 用户名
    private String password;                  // 密码
    private String captcha;                   // 验证码
    private String captchaKey;                // 验证码键
    private Boolean rememberMe;               // 记住我
}
```

#### 响应DTO (LoginResponse)
```java
@Data
public class LoginResponse {
    private String userId;                    // 用户ID
    private String username;                  // 用户名
    private String nickname;                  // 昵称
    private String avatar;                    // 头像URL
    private String token;                     // JWT令牌
    private String tokenType;                 // 令牌类型
    private Long expiresIn;                   // 过期时间
    private Integer userType;                 // 用户类型
    private String userTypeDesc;              // 用户类型描述
}
```

## 🔐 安全设计

### 1. 认证授权
- **JWT验证**: 通过JWT拦截器验证用户身份
- **密码加密**: 使用BCrypt算法加密用户密码
- **令牌管理**: JWT令牌包含用户信息和过期时间
- **会话控制**: 支持强制登出和令牌黑名单

### 2. 数据安全
- **密码安全**: 密码使用BCrypt加密存储
- **输入验证**: 所有输入参数进行验证
- **SQL注入防护**: 使用MyBatis Plus参数化查询
- **敏感数据处理**: 密码等敏感信息不返回给前端

### 3. 接口安全
- **接口限流**: 登录接口进行限流保护
- **异常处理**: 统一的异常处理机制
- **日志记录**: 关键操作的日志记录
- **链路追踪**: 支持请求链路追踪

## ⚙️ 配置管理

### 应用配置
```yaml
spring:
  application:
    name: service-auth
  datasource:
    url: jdbc:mysql://localhost:3306/banyu
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:root}
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}

# JWT配置
jwt:
  secret: ${JWT_SECRET:your-secret-key}
  expiration: ${JWT_EXPIRATION:86400}
  header: Authorization

# 安全配置
security:
  bcrypt:
    strength: 12
  login:
    max-attempts: 5
    lock-duration: 300
```

### 环境配置
- **开发环境**: `application-dev.yml`
- **测试环境**: `application-test.yml`
- **生产环境**: `application-prod.yml`

## 🔄 业务流程

### 1. 用户登录流程
```
1. 客户端发送登录请求
   ↓
2. 验证用户名和密码
   ↓
3. 检查用户状态和权限
   ↓
4. 生成JWT令牌
   ↓
5. 记录登录日志
   ↓
6. 返回用户信息和令牌
```

### 2. 令牌验证流程
```
1. 客户端携带JWT令牌
   ↓
2. 拦截器提取令牌
   ↓
3. 验证令牌签名和过期时间
   ↓
4. 检查令牌是否在黑名单
   ↓
5. 提取用户信息
   ↓
6. 设置用户上下文
```

### 3. 用户登出流程
```
1. 客户端发送登出请求
   ↓
2. 验证JWT令牌
   ↓
3. 将令牌加入黑名单
   ↓
4. 清除用户会话
   ↓
5. 记录登出日志
   ↓
6. 返回登出成功响应
```

## 🚨 异常处理与错误码

### 1. 异常处理机制
- **统一异常处理**: 使用`@ControllerAdvice`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 使用`GlobalExceptionHandler`处理系统异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 2. 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 500 | 系统错误 | 系统内部错误 |

#### 认证模块特殊错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 1101 | 认证失败 | 认证过程失败 |
| 1102 | 认证令牌缺失 | 未提供认证令牌 |
| 1103 | 认证令牌已过期 | 认证令牌已过期 |
| 1104 | 认证令牌无效 | 认证令牌格式或签名无效 |
| 1105 | 用户账号已被禁用 | 用户账号被禁用或待审核 |
| 1106 | 用户名或密码错误 | 登录凭据错误 |

#### 用户模块相关错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 1001 | 用户不存在 | 指定的用户不存在 |
| 1002 | 用户已存在 | 用户名或手机号已存在 |
| 1003 | 密码错误 | 用户密码错误 |
| 1004 | 账号已被禁用 | 用户账号已被禁用 |
| 1005 | 令牌已过期 | JWT令牌已过期 |
| 1006 | 令牌无效 | JWT令牌无效 |
| 1007 | 用户档案不存在 | 用户档案信息不存在 |
| 1008 | 用户头像上传失败 | 用户头像上传操作失败 |
| 1009 | 用户权限不足 | 用户权限不足以执行操作 |

### 3. 异常处理流程
```
1. 异常发生
   ↓
2. 异常拦截器捕获
   ↓
3. 异常分类处理
   ↓
4. 错误码映射
   ↓
5. 错误信息格式化
   ↓
6. 返回统一错误响应
```

## 📊 性能优化

### 1. 缓存策略
- **Redis缓存**: 用户信息缓存，减少数据库查询
- **令牌缓存**: JWT令牌验证结果缓存
- **黑名单缓存**: 登出令牌黑名单缓存
- **缓存过期**: 合理的缓存过期时间设置

### 2. 数据库优化
- **索引优化**: 用户名、邮箱等字段创建索引
- **查询优化**: 使用MyBatis Plus优化查询
- **连接池**: 配置合适的数据库连接池
- **分页查询**: 用户列表使用分页查询

### 3. 接口优化
- **异步处理**: 日志记录使用异步处理
- **批量操作**: 批量处理用户操作
- **限流保护**: 登录接口限流保护
- **响应优化**: 合理设置响应数据大小

## 🧪 测试策略

### 1. 单元测试
- **Service层测试**: 测试认证业务逻辑
- **Util层测试**: 测试JWT工具类功能
- **Mapper层测试**: 测试数据访问层

### 2. 集成测试
- **API测试**: 测试REST接口功能
- **数据库测试**: 测试数据库操作
- **缓存测试**: 测试Redis缓存功能

### 3. 性能测试
- **并发测试**: 测试并发登录性能
- **压力测试**: 测试系统承载能力
- **稳定性测试**: 测试长期运行稳定性

### Mock配置
```java
@TestConfiguration
public class TestConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // 在测试环境中排除所有需要认证的路径
        // 这样可以专注于测试业务逻辑，而不需要处理认证
    }
}

@TestConfiguration
@EnableWebSecurity
@Profile("test")
public class TestSecurityConfig {
    
    @Bean
    public SecurityFilterChain testSecurityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(authz -> authz.anyRequest().permitAll());
        return http.build();
    }
}
```

## 📈 监控指标

### 1. 业务指标
- **登录成功率**: 登录成功次数/总登录次数
- **登录响应时间**: 登录接口平均响应时间
- **活跃用户数**: 当前在线用户数量
- **令牌验证频率**: JWT令牌验证次数

### 2. 技术指标
- **接口响应时间**: 各接口平均响应时间
- **错误率**: 接口错误率统计
- **缓存命中率**: Redis缓存命中率
- **数据库连接数**: 数据库连接池使用情况

### 3. 安全指标
- **登录失败次数**: 登录失败统计
- **异常访问次数**: 异常访问统计
- **令牌过期次数**: JWT令牌过期统计
- **强制登出次数**: 强制登出操作统计

## 🔮 扩展规划

### 1. 功能扩展
- **多因子认证**: 支持短信、邮箱验证码认证
- **OAuth2集成**: 支持第三方登录
- **权限管理**: 细粒度权限控制
- **审计日志**: 完整的操作审计日志

### 2. 性能优化
- **分布式缓存**: 使用Redis集群
- **数据库分库分表**: 支持大规模用户
- **微服务拆分**: 进一步拆分认证服务
- **CDN加速**: 静态资源CDN加速

### 3. 架构升级
- **服务网格**: 集成Istio服务网格
- **容器化部署**: 支持Kubernetes部署
- **监控告警**: 完善监控告警体系
- **自动化运维**: 实现自动化运维

---

**文档版本**: v1.0  
**创建时间**: 2025-07-31  
**维护人员**: scccy 