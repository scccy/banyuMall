# 认证服务模块设计文档

## 📋 模块概述

### 基本信息
- **模块名称**: service-auth
- **模块类型**: 微服务模块
- **主要职责**: 用户认证、JWT令牌管理、权限验证
- **技术栈**: Spring Boot + Spring Security + JWT + Redis
- **作者**: scccy
- **创建时间**: 2025-01-27

### 设计理念
基于简化的权限控制架构，使用用户类型字段直接控制权限，摒弃复杂的RBAC系统，提高系统性能和可维护性。

## 🏗️ 架构设计

### 核心架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │     Service     │    │     Mapper      │
│                 │    │                 │    │                 │
│  AuthController │───▶│   AuthService   │───▶│  SysUserMapper  │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Interceptor   │    │      Util       │    │    Database     │
│                 │    │                 │    │                 │
│ JwtInterceptor  │    │  JwtUtil        │    │    sys_user     │
│                 │    │  JwtTokenManager│    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 权限控制模型
```
用户类型 (user_type)
├── 1: 系统管理员 (拥有所有权限)
├── 2: 发布者 (可以发布任务)
└── 3: 接受者 (可以接受任务)
```

## 📁 目录结构

```
service-auth/
├── src/main/java/com/origin/auth/
│   ├── controller/
│   │   └── AuthController.java              # 认证控制器
│   ├── service/
│   │   ├── AuthService.java                 # 认证服务接口
│   │   ├── SysUserService.java              # 用户服务接口
│   │   └── impl/
│   │       ├── AuthServiceImpl.java         # 认证服务实现
│   │       └── SysUserServiceImpl.java      # 用户服务实现
│   ├── entity/
│   │   └── SysUser.java                     # 用户实体
│   ├── mapper/
│   │   └── SysUserMapper.java               # 用户数据访问层
│   ├── dto/
│   │   ├── LoginRequest.java                # 登录请求DTO
│   │   ├── LoginResponse.java               # 登录响应DTO
│   │   └── UserInfoResponse.java            # 用户信息响应DTO
│   ├── util/
│   │   ├── JwtUtil.java                     # JWT工具类
│   │   └── JwtTokenManager.java             # JWT令牌管理器
│   ├── interceptor/
│   │   └── JwtInterceptor.java              # JWT拦截器
│   ├── exception/
│   │   └── AuthException.java               # 认证异常
│   └── ServiceAuthApplication.java          # 启动类
└── src/main/resources/
    ├── application.yml                      # 配置文件
    └── mapper/
        └── SysUserMapper.xml                # MyBatis映射文件
```

## 🔧 核心组件

### 1. 认证控制器 (AuthController)

#### 主要接口
```java
@RestController
@RequestMapping("/service/auth")
public class AuthController {
    
    // 用户登录
    @PostMapping("/login")
    public ResultData<LoginResponse> login(@RequestBody LoginRequest request);
    
    // 用户登出
    @PostMapping("/logout")
    public ResultData<String> logout(HttpServletRequest request);
    
    // 健康检查
    @GetMapping("/test")
    public ResultData<String> test(HttpServletRequest request);
    
    // 强制登出用户（管理员功能）
    @PostMapping("/logout/force/{userId}")
    public ResultData<String> forceLogout(@PathVariable String userId);
}
```

#### 接口说明
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 用户登录 | POST | `/service/auth/login` | 处理用户登录，返回JWT令牌 |
| 用户登出 | POST | `/service/auth/logout` | 处理用户登出，清除令牌 |
| 健康检查 | GET | `/service/auth/test` | 服务健康检查 |
| 强制登出 | POST | `/service/auth/logout/force/{userId}` | 管理员强制登出用户 |

### 2. 认证服务 (AuthService)

#### 核心方法
```java
public interface AuthService {
    
    // 用户登录
    LoginResponse login(LoginRequest request);
    
    // 验证JWT令牌
    boolean validateToken(String token);
    
    // 用户登出
    void logout(String token);
    
    // 强制登出用户
    void forceLogout(String userId);
    
    // 从令牌获取用户信息
    String getUsernameFromToken(String token);
    String getUserIdFromToken(String token);
    Integer getUserTypeFromToken(String token);
    
    // 权限验证
    boolean hasPermission(String userId, Integer requiredUserType);
    boolean isAdmin(String userId);
    boolean isPublisher(String userId);
    boolean isReceiver(String userId);
    
    // 获取用户信息
    UserInfoResponse getUserInfo(String userId);
}
```

#### 权限验证逻辑
```java
// 权限验证示例
public boolean hasPermission(String userId, Integer requiredUserType) {
    SysUser user = sysUserService.getById(userId);
    if (user == null || !sysUserService.isUserStatusNormal(user)) {
        return false;
    }
    
    // 管理员拥有所有权限
    if (user.getUserType() == 1) {
        return true;
    }
    
    // 检查用户类型是否匹配
    return user.getUserType().equals(requiredUserType);
}
```

### 3. 用户服务 (SysUserService)

#### 核心方法
```java
public interface SysUserService extends IService<SysUser> {
    
    // 用户查询
    SysUser getByUsername(String username);
    SysUser getByPhone(String phone);
    SysUser getByWechatId(String wechatId);
    SysUser getByYouzanId(String youzanId);
    
    // 用户管理
    void updateLastLoginTime(String userId);
    
    // 密码管理
    boolean validatePassword(String rawPassword, String encodedPassword);
    String encodePassword(String rawPassword);
    
    // 状态检查
    boolean isUserStatusNormal(SysUser user);
}
```

### 4. JWT工具类 (JwtUtil)

#### 核心功能
```java
@Component
public class JwtUtil {
    
    // 令牌生成
    public String generateToken(String userId, String username);
    public String generateToken(String userId, String username, Map<String, Object> claims);
    
    // 令牌验证
    public boolean validateToken(String token);
    
    // 令牌解析
    public String getUserIdFromToken(String token);
    public String getUsernameFromToken(String token);
    public <T> T getClaimFromToken(String token, String claimName, Class<T> claimType);
    
    // 过期时间
    public long getExpirationTime(String token);
}
```

### 5. JWT令牌管理器 (JwtTokenManager)

#### 核心功能
```java
@Component
public class JwtTokenManager {
    
    // 黑名单管理
    public void addToBlacklist(String token, long expirationTime);
    public boolean isBlacklisted(String token);
    
    // 用户令牌管理
    public void updateUserToken(String userId, String token, long expirationTime);
    public boolean isUserTokenValid(String userId, String token);
    public void removeUserToken(String userId);
    
    // 令牌验证
    public boolean isValid(String token);
    public void removeFromValid(String token);
}
```

### 6. JWT拦截器 (JwtInterceptor)

#### 拦截逻辑
```java
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. 获取token
        String token = request.getHeader("Authorization");
        
        // 2. 检查token是否在黑名单中
        if (jwtTokenManager.isBlacklisted(token)) {
            throw new BusinessException(ErrorCode.UNAUTHORIZED, "认证令牌已失效");
        }
        
        // 3. 验证token是否有效
        if (!jwtUtil.validateToken(token)) {
            throw new BusinessException(ErrorCode.UNAUTHORIZED, "认证令牌无效或已过期");
        }
        
        // 4. 设置用户信息到请求属性
        String userId = jwtUtil.getUserIdFromToken(token);
        String username = jwtUtil.getUsernameFromToken(token);
        request.setAttribute("userId", userId);
        request.setAttribute("username", username);
        
        return true;
    }
}
```

## 🗄️ 数据模型

### 用户实体 (SysUser)
```java
@Data
@TableName("sys_user")
public class SysUser extends BaseEntity {
    
    @TableId(value = "user_id", type = IdType.ASSIGN_ID)
    private String userId;                    // 用户ID
    
    private String phone;                     // 手机号
    private String wechatId;                  // 微信用户ID
    private String youzanId;                  // 有赞用户ID
    private String username;                  // 用户名
    private String password;                  // 密码(BCrypt加密)
    private String nickname;                  // 昵称
    private String avatar;                    // 头像URL
    private String email;                     // 邮箱
    private Integer gender;                   // 性别：0-未知，1-男，2-女
    private LocalDate birthday;               // 生日
    private Integer status;                   // 状态：1-正常，2-禁用，3-待审核，4-已删除
    private Integer userType;                 // 用户类型：1-系统管理员，2-发布者，3-接受者
    private String profileId;                 // 扩展信息ID
    private LocalDateTime lastLoginTime;      // 最后登录时间
}
```

### DTO设计

#### 登录请求 (LoginRequest)
```java
@Data
public class LoginRequest {
    private String username;                  // 用户名
    private String password;                  // 密码
}
```

#### 登录响应 (LoginResponse)
```java
@Data
public class LoginResponse {
    private String userId;                    // 用户ID
    private String username;                  // 用户名
    private String nickname;                  // 昵称
    private String avatar;                    // 头像
    private Integer userType;                 // 用户类型
    private String userTypeDesc;              // 用户类型描述
    private String token;                     // 访问令牌
    private String tokenType = "Bearer";      // 令牌类型
    private Long expiresIn;                   // 过期时间（秒）
}
```

#### 用户信息响应 (UserInfoResponse)
```java
@Data
public class UserInfoResponse {
    private String userId;                    // 用户ID
    private String username;                  // 用户名
    private String nickname;                  // 昵称
    private String avatar;                    // 头像URL
    private String email;                     // 邮箱
    private String phone;                     // 手机号
    private String wechatId;                  // 微信用户ID
    private String youzanId;                  // 有赞用户ID
    private Integer gender;                   // 性别
    private LocalDate birthday;               // 生日
    private Integer status;                   // 状态
    private Integer userType;                 // 用户类型
    private String userTypeDesc;              // 用户类型描述
    private String profileId;                 // 扩展信息ID
    private LocalDateTime lastLoginTime;      // 最后登录时间
    private LocalDateTime createdTime;        // 创建时间
}
```

## 🔐 安全设计

### 1. 密码安全
- **加密算法**: BCrypt (强度12)
- **密码验证**: 使用Spring Security的PasswordEncoder
- **密码存储**: 数据库中只存储加密后的密码

### 2. JWT安全
- **签名算法**: HMAC-SHA256
- **密钥管理**: 通过配置文件管理JWT密钥
- **过期时间**: 可配置的令牌过期时间
- **刷新机制**: 支持令牌刷新

### 3. 令牌管理
- **黑名单机制**: 登出的令牌加入Redis黑名单
- **用户令牌管理**: 每个用户只保留最新的有效令牌
- **自动过期**: Redis自动清理过期的令牌

### 4. 权限控制
- **简化权限模型**: 基于用户类型的权限控制
- **权限验证**: 在Service层进行权限验证
- **拦截器验证**: 在请求拦截器中进行令牌验证

## ⚙️ 配置管理

### 应用配置
```yaml
spring:
  application:
    name: service-auth
  datasource:
    url: jdbc:mysql://localhost:3306/banyu
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:root}
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}

# JWT配置
jwt:
  secret: ${JWT_SECRET:your-secret-key}
  expiration: ${JWT_EXPIRATION:86400}        # 24小时
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800}  # 7天
  enable-blacklist: ${JWT_ENABLE_BLACKLIST:true}
  blacklist-prefix: "jwt:blacklist:"
  valid-token-prefix: "jwt:valid:"
  header: "Authorization"

# MyBatis Plus配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: assign_id
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 环境配置
- **开发环境**: `application-dev.yml`
- **测试环境**: `application-test.yml`
- **生产环境**: `application-prod.yml`

## 🔄 业务流程

### 1. 用户登录流程
```
1. 客户端发送登录请求
   ↓
2. AuthController接收请求
   ↓
3. AuthService验证用户名和密码
   ↓
4. 检查用户状态是否正常
   ↓
5. 更新用户最后登录时间
   ↓
6. 生成JWT令牌（包含用户类型信息）
   ↓
7. 将令牌存储到Redis
   ↓
8. 返回登录响应（包含令牌和用户信息）
```

### 2. 请求认证流程
```
1. 客户端发送请求（携带JWT令牌）
   ↓
2. JwtInterceptor拦截请求
   ↓
3. 检查令牌是否在黑名单中
   ↓
4. 验证JWT令牌格式和签名
   ↓
5. 检查令牌是否过期
   ↓
6. 从令牌中提取用户信息
   ↓
7. 设置用户信息到请求属性
   ↓
8. 继续处理业务请求
```

### 3. 用户登出流程
```
1. 客户端发送登出请求
   ↓
2. AuthController接收请求
   ↓
3. 从请求头中提取JWT令牌
   ↓
4. 将令牌加入Redis黑名单
   ↓
5. 移除用户的当前令牌
   ↓
6. 返回登出成功响应
```

## 📊 性能优化

### 1. 缓存策略
- **Redis缓存**: JWT令牌和黑名单信息
- **本地缓存**: 用户信息缓存（可选）
- **缓存过期**: 自动过期机制

### 2. 数据库优化
- **索引优化**: 用户名、手机号等字段建立索引
- **查询优化**: 使用MyBatis Plus的分页查询
- **连接池**: 配置合适的数据库连接池

### 3. JWT优化
- **令牌大小**: 控制JWT令牌的大小
- **声明精简**: 只包含必要的用户信息
- **过期时间**: 合理设置令牌过期时间

## 🧪 测试策略

### 1. 单元测试
- **Service层测试**: 测试业务逻辑
- **Util层测试**: 测试工具类功能
- **Mapper层测试**: 测试数据访问

### 2. 集成测试
- **API测试**: 测试REST接口
- **数据库测试**: 测试数据库操作
- **Redis测试**: 测试缓存功能

### 3. 性能测试
- **并发测试**: 测试并发登录性能
- **压力测试**: 测试系统承载能力
- **稳定性测试**: 测试长期运行稳定性

## 📈 监控指标

### 1. 业务指标
- **登录成功率**: 登录成功次数/总登录次数
- **登录响应时间**: 登录接口的平均响应时间
- **活跃用户数**: 当前在线用户数量

### 2. 技术指标
- **JWT令牌生成时间**: 令牌生成的平均时间
- **Redis操作延迟**: Redis读写的平均延迟
- **数据库查询时间**: 数据库查询的平均时间

### 3. 安全指标
- **异常登录次数**: 密码错误等异常登录次数
- **令牌失效次数**: 令牌验证失败的次数
- **黑名单大小**: 当前黑名单中的令牌数量

## 🔮 扩展规划

### 1. 功能扩展
- **多因子认证**: 支持短信验证码、邮箱验证等
- **OAuth2集成**: 支持第三方登录
- **单点登录**: 支持SSO功能

### 2. 安全增强
- **令牌轮换**: 定期更换JWT密钥
- **异常检测**: 检测异常登录行为
- **审计日志**: 记录详细的认证日志

### 3. 性能优化
- **分布式缓存**: 使用Redis集群
- **负载均衡**: 支持多实例部署
- **异步处理**: 异步处理非关键操作

---

**文档版本**: v2.0  
**最后更新**: 2025-01-27  
**维护人员**: scccy