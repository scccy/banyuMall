# service-auth 模块迭代设计

> **文档位置**: `zinfra/moudleDocs/service-auth/模块迭代设计.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 1. 微服务模块级别信息

### 1.1 模块基本信息
- **当前微服务模块级别**: service-auth（认证服务）
- **父模块**: service（服务层）
- **模块类型**: 认证授权服务
- **基础路径**: `/service/auth`

### 1.2 模块职责
**Service-Auth** 是BanyuMall微服务架构的认证授权模块，负责用户认证、JWT令牌管理、权限控制、角色管理等核心安全功能，为整个微服务架构提供统一的安全保障。

## 2. 接口功能列表

| 序号 | 接口名称 | 接口路径 | 请求方法 | 功能描述 | 是否需要Feign客户端 | 详细说明 |
|------|----------|----------|----------|----------|-------------------|----------|
| 1 | 用户登录 | `/service/auth/login` | POST | 用户登录认证，返回JWT令牌和用户信息 | 是 | [查看详情](#21-用户登录) |
| 2 | 用户登出 | `/service/auth/logout` | POST | 用户登出，清除会话信息和令牌 | 否 | [查看详情](#22-用户登出) |
| 3 | 强制登出用户 | `/service/auth/logout/force/{userId}` | POST | 管理员强制登出指定用户 | 否 | [查看详情](#23-强制登出用户) |
| 4 | 认证服务健康检查 | `/service/auth/test` | GET | 认证服务健康检查 | 否 | [查看详情](#24-认证服务健康检查) |
| 5 | 密码加密 | `/service/auth/password/encrypt` | POST | 密码加密服务 | 是 | [查看详情](#25-密码加密) |
| 6 | 密码验证 | `/service/auth/password/verify` | POST | 密码验证服务 | 是 | [查看详情](#26-密码验证) |
| 7 | 令牌验证 | `/service/auth/token/validate` | POST | JWT令牌验证服务 | 是 | [查看详情](#27-令牌验证) |
| 8 | 令牌刷新 | `/service/auth/token/refresh` | POST | JWT令牌刷新服务 | 是 | [查看详情](#28-令牌刷新) |

## 3. 数据模型设计

### 3.1 数据库表结构
参考: [user-schema-optimized.sql](../../database/data/user/user_init_creat_optimized.sql)

> **注意**: 数据模型设计直接指向 `zinfra/database/data/` 目录下的SQL文件，不重复定义表结构。

### 3.2 核心实体

#### 3.2.1 用户实体 (SysUser)
- **表名**: `sys_user`
- **职责**: 系统用户信息管理
- **主要字段**: id, username, password, nickname, avatar, email, phone, gender, birthday, status, userType, lastLoginTime

#### 3.2.2 角色实体 (SysRole)
- **表名**: `sys_role`
- **职责**: 系统角色信息管理
- **主要字段**: id, roleCode, roleName, description, status

#### 3.2.3 用户角色关联实体 (SysUserRole)
- **表名**: `sys_user_role`
- **职责**: 用户与角色的关联关系
- **主要字段**: id, userId, roleId, createTime

#### 3.2.4 权限实体 (SysPermission)
- **表名**: `sys_permission`
- **职责**: 系统权限信息管理
- **主要字段**: id, permissionCode, permissionName, description, status

#### 3.2.5 角色权限关联实体 (SysRolePermission)
- **表名**: `sys_role_permission`
- **职责**: 角色与权限的关联关系
- **主要字段**: id, roleId, permissionId, createTime

## 4. 技术架构

### 4.1 技术栈
- **框架**: Spring Boot 3.x + Spring Security
- **认证**: JWT (JSON Web Token)
- **数据库**: MySQL 8.0 + MyBatis-Plus
- **缓存**: Redis (令牌黑名单和权限缓存)
- **序列化**: FastJSON2
- **验证**: Jakarta Validation
- **日志**: Log4j2
- **文档**: Knife4j (Swagger)

### 4.2 架构设计
- **微服务架构**: 独立的认证服务模块
- **分层设计**: Controller -> Service -> Mapper -> Database
- **安全设计**: Spring Security + JWT + RBAC
- **缓存设计**: Redis缓存令牌黑名单和权限信息

## 5. 安全设计

### 5.1 认证机制
- **JWT令牌**: 使用JWT进行无状态认证
- **令牌过期**: 支持令牌自动过期和刷新机制
- **令牌黑名单**: 使用Redis管理已失效的令牌
- **密码安全**: 使用BCrypt进行密码加密存储

### 5.2 权限控制
- **RBAC模型**: 基于角色的访问控制
- **权限验证**: 细粒度的权限验证机制
- **权限缓存**: 使用Redis缓存权限信息，提高性能
- **动态权限**: 支持动态权限配置和更新

### 5.3 安全防护
- **SQL注入防护**: 使用MyBatis-Plus参数化查询
- **XSS防护**: 输入验证和输出编码
- **CSRF防护**: Spring Security内置CSRF防护
- **暴力破解防护**: 登录失败次数限制

## 6. 性能优化

### 6.1 缓存策略
- **令牌缓存**: Redis缓存JWT令牌信息
- **权限缓存**: Redis缓存用户权限信息
- **用户信息缓存**: Redis缓存用户基本信息
- **缓存过期**: 合理的缓存过期时间设置

### 6.2 数据库优化
- **索引优化**: 关键字段建立索引
- **查询优化**: 使用MyBatis-Plus优化查询
- **连接池**: 配置合适的数据库连接池参数
- **分页查询**: 大数据量查询使用分页

### 6.3 并发处理
- **线程池**: 配置合适的线程池参数
- **异步处理**: 非关键操作使用异步处理
- **限流机制**: 接口访问频率限制
- **熔断机制**: 服务降级和熔断保护

## 7. 监控和日志

### 7.1 监控指标
- **接口响应时间**: 监控各接口的响应时间
- **错误率**: 监控接口调用错误率
- **并发数**: 监控系统并发访问数
- **资源使用**: 监控CPU、内存、磁盘使用情况

### 7.2 日志记录
- **访问日志**: 记录所有接口访问日志
- **错误日志**: 记录系统错误和异常日志
- **安全日志**: 记录认证和授权相关日志
- **审计日志**: 记录重要操作的审计日志

## 8. 部署和运维

### 8.1 部署配置
- **环境配置**: 开发、测试、生产环境配置
- **健康检查**: 提供健康检查接口
- **优雅关闭**: 支持优雅关闭和重启
- **配置管理**: 使用Nacos进行配置管理

### 8.2 运维支持
- **日志收集**: 集成ELK日志收集系统
- **监控告警**: 集成Prometheus监控系统
- **备份恢复**: 数据库备份和恢复策略
- **扩容缩容**: 支持水平扩容和缩容

## 9. 测试策略

### 9.1 单元测试
- **Service层测试**: 测试业务逻辑
- **Controller层测试**: 测试接口功能
- **Mapper层测试**: 测试数据访问
- **工具类测试**: 测试工具方法

### 9.2 集成测试
- **接口测试**: 测试API接口功能
- **数据库测试**: 测试数据库操作
- **缓存测试**: 测试Redis缓存功能
- **安全测试**: 测试安全防护功能

### 9.3 性能测试
- **压力测试**: 测试系统承载能力
- **并发测试**: 测试并发访问性能
- **稳定性测试**: 测试系统稳定性
- **安全测试**: 测试安全防护效果

## 10. 文档和规范

### 10.1 代码规范
- **编码规范**: 遵循阿里巴巴Java开发手册
- **注释规范**: 完整的代码注释和文档
- **命名规范**: 统一的命名规范和约定
- **版本控制**: 规范的Git提交和分支管理

### 10.2 文档规范
- **API文档**: 完整的API接口文档
- **设计文档**: 详细的设计和架构文档
- **部署文档**: 完整的部署和运维文档
- **用户手册**: 用户使用和操作手册 