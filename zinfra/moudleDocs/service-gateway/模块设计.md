# Service Gateway 模块设计文档

## 📋 模块概述

**模块名称**: service-gateway  
**模块类型**: 网关服务  
**技术栈**: Spring Cloud Gateway + WebFlux + Nacos  
**作者**: scccy  
**创建时间**: 2025-07-31  

### 模块职责
- **统一入口**: 为所有微服务提供统一的API网关入口
- **路由转发**: 根据请求路径将请求转发到对应的微服务
- **链路追踪**: 为每个请求生成唯一ID，实现全链路追踪
- **跨域处理**: 统一处理CORS跨域请求
- **异常处理**: 统一处理网关层面的异常，返回标准错误响应
- **负载均衡**: 集成Spring Cloud LoadBalancer实现服务负载均衡

## 🏗️ 架构设计

### 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用     │───▶│  Service Gateway │───▶│   微服务集群     │
│                │    │                │    │                │
│ - Web前端       │    │ - 路由转发      │    │ - service-auth  │
│ - 移动端        │    │ - 链路追踪      │    │ - service-user  │
│ - 第三方应用    │    │ - 跨域处理      │    │ - core-publisher│
└─────────────────┘    │ - 异常处理      │    │ - third-party   │
                       │ - 负载均衡      │    └─────────────────┘
                       └─────────────────┘
```

### 核心组件
1. **GatewayApplication**: 网关服务启动类
2. **GatewayConfig**: 路由配置类
3. **GatewayWebConfig**: WebFlux配置类
4. **GlobalFilter**: 全局过滤器
5. **GatewayExceptionHandler**: 异常处理器

## 🔧 核心功能

### 1. 路由配置
- **认证服务路由**: `/auth/**` → `service-auth`
- **用户服务路由**: `/service/user/**` → `service-user`
- **自动添加请求头**: 为每个请求添加网关标识和服务名称

### 2. 链路追踪
- **请求ID生成**: 自动生成唯一请求ID
- **客户端信息**: 记录客户端IP、User-Agent等信息
- **请求日志**: 记录请求开始和结束时间，计算响应时长
- **链路传递**: 将追踪信息传递给下游服务

### 3. 跨域处理
- **CORS配置**: 支持所有来源、所有方法、所有头部
- **预检请求**: 自动处理OPTIONS预检请求
- **凭证支持**: 支持携带凭证的跨域请求

### 4. 异常处理
- **业务异常**: 处理BusinessException，返回标准错误响应
- **系统异常**: 处理未捕获异常，返回友好的错误信息
- **统一格式**: 所有异常都返回ResultData格式

## ⚙️ 配置说明

### 应用配置
```yaml
# 服务器配置
server:
  port: 8080

# 应用名称
spring:
  application:
    name: service-gateway
  
  # WebFlux配置
  main:
    web-application-type: reactive
    lazy-initialization: true
```

### Nacos配置
- **服务发现**: 自动注册到Nacos注册中心
- **配置中心**: 从Nacos加载动态配置
- **负载均衡**: 使用Spring Cloud LoadBalancer

### 路由配置
```java
@Bean
public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
    return builder.routes()
            // 认证服务路由
            .route("auth-service", r -> r
                    .path("/auth/**")
                    .filters(f -> f
                            .addRequestHeader("X-Gateway-Source", "service-gateway")
                            .addRequestHeader("X-Service-Name", "service-auth"))
                    .uri("lb://service-auth"))
            
            // 用户服务路由
            .route("user-service", r -> r
                    .path("/service/user/**")
                    .filters(f -> f
                            .addRequestHeader("X-Gateway-Source", "service-gateway")
                            .addRequestHeader("X-Service-Name", "service-user"))
                    .uri("lb://service-user"))
            .build();
}
```

## 🔍 过滤器链

### GlobalFilter 全局过滤器
- **优先级**: HIGHEST_PRECEDENCE
- **功能**:
  - 生成请求ID
  - 记录请求日志
  - 添加链路追踪头
  - 计算响应时间

### 请求头添加
- `X-Request-ID`: 请求唯一标识
- `X-Client-IP`: 客户端IP地址
- `X-User-Agent`: 用户代理信息
- `X-Request-Time`: 请求开始时间
- `X-Service-Name`: 服务名称
- `X-Gateway-Time`: 网关处理时间

## 🚨 异常处理与错误码

### 1. 异常处理机制
- **统一异常处理**: 使用`GatewayExceptionHandler`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 处理系统级异常和网络异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 2. 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 408 | 请求超时 | 请求处理超时 |
| 429 | 请求过于频繁 | 请求频率超限 |
| 500 | 系统错误 | 系统内部错误 |
| 502 | 网关错误 | 网关服务错误 |
| 503 | 服务不可用 | 后端服务不可用 |

#### 网关模块特殊错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 5001 | 网关路由不存在 | 请求的路由不存在 |
| 5002 | 网关超时 | 网关处理超时 |
| 5003 | 网关服务不可用 | 网关服务不可用 |
| 5004 | 网关限流 | 请求频率超限 |
| 5005 | 网关CORS错误 | 跨域请求错误 |
| 5006 | 网关过滤器错误 | 网关过滤器处理错误 |

#### 路由相关错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 404 | 路由不存在 | 请求的路径不存在 |
| 405 | 方法不允许 | 请求方法不被允许 |
| 502 | 后端服务错误 | 后端服务返回错误 |
| 503 | 后端服务不可用 | 后端服务不可用 |

### 3. 异常处理流程
```
1. 请求进入网关
   ↓
2. 路由匹配
   ↓
3. 过滤器处理
   ↓
4. 转发到后端服务
   ↓
5. 异常捕获处理
   ↓
6. 错误响应格式化
   ↓
7. 返回统一错误响应
```

### 4. 响应格式
```json
{
  "code": 500,
  "message": "网关服务异常，请稍后重试",
  "data": null,
  "timestamp": "2025-07-31T14:30:00"
}
```

## 📊 监控与日志

### 日志配置
- **日志框架**: Log4j2
- **日志级别**: DEBUG (开发环境)
- **日志文件**: logs/service-gateway.log
- **日志轮转**: 100MB/文件，保留30天

### 监控端点
- **健康检查**: `/actuator/health`
- **应用信息**: `/actuator/info`
- **指标监控**: `/actuator/metrics`
- **网关信息**: `/actuator/gateway`

## 🔒 安全考虑

### 请求头安全
- 自动添加网关标识头，防止伪造请求
- 记录客户端真实IP，支持代理环境
- 过滤敏感请求头信息

### 异常安全
- 不暴露系统内部错误信息
- 统一错误响应格式
- 记录异常日志用于问题排查

## 🚀 部署说明

### 环境要求
- **JDK版本**: 21
- **内存要求**: 最小512MB，推荐1GB
- **端口**: 8080

### 启动命令
```bash
# 开发环境
java -jar service-gateway.jar --spring.profiles.active=dev

# 生产环境
java -jar service-gateway.jar --spring.profiles.active=prod
```

### 依赖服务
- **Nacos注册中心**: 服务注册与发现
- **Nacos配置中心**: 动态配置管理
- **微服务集群**: 下游业务服务

## 📝 注意事项

### 性能优化
1. **懒加载**: 开发环境启用懒加载提升启动速度
2. **内存配置**: 合理配置JVM内存参数
3. **连接池**: 配置合适的连接池大小

### 故障排查
1. **日志分析**: 查看请求日志和异常日志
2. **链路追踪**: 通过请求ID追踪完整请求链路
3. **健康检查**: 监控服务健康状态

### 扩展性
1. **路由扩展**: 新增微服务时只需添加路由配置
2. **过滤器扩展**: 可以添加自定义过滤器
3. **监控扩展**: 可以集成更多监控工具

---

**文档版本**: v1.0  
**最后更新**: 2025-07-31  
**维护人员**: scccy 