# service-gateway 模块迭代设计

> **文档位置**: `zinfra/moudleDocs/service-gateway/模块迭代设计.md`
> **创建时间**: 2025-08-01
> **作者**: scccy

## 1. 微服务模块级别信息

### 1.1 模块基本信息
- **当前微服务模块级别**: service-gateway（网关服务）
- **父模块**: service（服务层）
- **模块类型**: API网关服务
- **基础路径**: `/` (根路径)

### 1.2 模块职责
**Service-Gateway** 是BanyuMall微服务架构的API网关模块，负责统一入口、路由转发、负载均衡、限流熔断、链路追踪等核心功能，为整个微服务架构提供统一的访问入口。

## 2. 接口功能列表

| 序号 | 接口名称 | 接口路径 | 请求方法 | 功能描述 | 是否需要Feign客户端 | 详细说明 |
|------|----------|----------|----------|----------|-------------------|----------|
| 1 | 认证服务路由 | `/auth/**` | ALL | 路由转发到认证服务 | 否 | [查看详情](#21-认证服务路由) |
| 2 | 用户服务路由 | `/service/user/**` | ALL | 路由转发到用户服务 | 否 | [查看详情](#22-用户服务路由) |
| 3 | 发布者服务路由 | `/core/publisher/**` | ALL | 路由转发到发布者服务 | 否 | [查看详情](#23-发布者服务路由) |
| 4 | OSS服务路由 | `/third-party/oss/**` | ALL | 路由转发到OSS服务 | 否 | [查看详情](#24-OSS服务路由) |
| 5 | 网关健康检查 | `/actuator/health` | GET | 网关服务健康检查 | 否 | [查看详情](#25-网关健康检查) |
| 6 | 网关监控指标 | `/actuator/metrics` | GET | 网关性能监控指标 | 否 | [查看详情](#26-网关监控指标) |

## 3. 数据模型设计

### 3.1 数据库表结构
> **注意**: 网关服务通常不需要数据库，主要依赖配置文件和内存缓存。

### 3.2 配置模型

#### 3.2.1 路由配置模型
- **路由规则**: 基于路径的路由匹配规则
- **服务发现**: Nacos服务发现配置
- **负载均衡**: 负载均衡策略配置
- **限流配置**: 限流规则和策略配置

#### 3.2.2 过滤器配置模型
- **全局过滤器**: 全局过滤器配置
- **局部过滤器**: 局部过滤器配置
- **请求头配置**: 请求头添加和过滤配置
- **跨域配置**: CORS跨域配置

## 4. 技术架构

### 4.1 技术栈
- **框架**: Spring Boot 3.x + Spring Cloud Gateway
- **响应式编程**: WebFlux + Reactor
- **服务发现**: Nacos Discovery
- **配置中心**: Nacos Config
- **负载均衡**: Spring Cloud LoadBalancer
- **限流**: Spring Cloud Gateway Rate Limiter
- **日志**: Log4j2
- **序列化**: FastJSON2

### 4.2 架构设计
- **微服务架构**: 独立的API网关服务
- **响应式架构**: 基于WebFlux的非阻塞架构
- **路由设计**: 动态路由配置和服务发现
- **过滤器设计**: 全局过滤器和局部过滤器

## 5. 路由设计

### 5.1 路由规则配置
- **路径匹配**: 基于Ant风格的路径匹配
- **服务发现**: 集成Nacos服务发现
- **负载均衡**: 支持多种负载均衡策略
- **动态配置**: 支持路由规则热更新

### 5.2 路由映射表
| 服务名称 | 路由路径 | 目标服务 | 负载均衡 | 限流策略 |
|----------|----------|----------|----------|----------|
| **认证服务** | `/auth/**` | `service-auth` | 轮询 | 基于IP |
| **用户服务** | `/service/user/**` | `service-user` | 轮询 | 基于IP |
| **发布者服务** | `/core/publisher/**` | `core-publisher` | 轮询 | 基于IP |
| **OSS服务** | `/third-party/oss/**` | `third-party-oss` | 轮询 | 基于IP |

## 6. 过滤器设计

### 6.1 全局过滤器
- **链路追踪**: 自动生成请求ID和链路信息
- **请求日志**: 记录详细的请求和响应日志
- **性能监控**: 记录请求处理时间
- **异常处理**: 统一的异常处理机制

### 6.2 局部过滤器
- **限流过滤器**: 基于IP地址的限流保护
- **跨域过滤器**: 处理CORS跨域请求
- **请求头过滤器**: 添加和过滤请求头
- **响应过滤器**: 处理响应数据和格式

## 7. 安全设计

### 7.1 限流保护
- **IP限流**: 基于客户端IP地址的限流
- **接口限流**: 基于接口路径的限流
- **全局限流**: 系统级别的限流保护
- **限流策略**: 可配置的限流策略

### 7.2 跨域处理
- **CORS配置**: 统一的跨域配置
- **请求头处理**: 自动添加必要的请求头
- **预检请求**: 处理OPTIONS预检请求
- **安全策略**: 严格的安全策略配置

### 7.3 异常处理
- **统一异常**: 统一的异常处理机制
- **错误响应**: 标准化的错误响应格式
- **降级策略**: 服务降级和熔断保护
- **重试机制**: 智能重试和故障恢复

## 8. 性能优化

### 8.1 响应式优化
- **非阻塞处理**: 基于WebFlux的非阻塞架构
- **异步处理**: 异步请求处理
- **连接池**: 优化的连接池配置
- **内存管理**: 高效的内存使用

### 8.2 路由优化
- **路由缓存**: 路由规则缓存
- **负载均衡**: 智能负载均衡策略
- **服务发现**: 高效的服务发现机制
- **连接复用**: HTTP连接复用

### 8.3 监控优化
- **链路追踪**: 高效的链路追踪
- **性能监控**: 实时性能监控
- **日志优化**: 结构化的日志记录
- **指标收集**: 关键指标收集

## 9. 监控和日志

### 9.1 监控指标
- **响应时间**: 网关响应时间监控
- **吞吐量**: 请求处理吞吐量
- **错误率**: 请求错误率监控
- **资源使用**: CPU、内存、网络使用情况

### 9.2 链路追踪
- **请求ID**: 自动生成请求唯一标识
- **链路信息**: 完整的请求链路信息
- **性能分析**: 各环节性能分析
- **异常定位**: 快速定位异常位置

### 9.3 日志记录
- **访问日志**: 详细的访问日志记录
- **错误日志**: 异常和错误日志
- **性能日志**: 性能相关日志
- **审计日志**: 安全审计日志

## 10. 部署和运维

### 10.1 部署配置
- **环境配置**: 开发、测试、生产环境配置
- **健康检查**: 提供健康检查接口
- **优雅关闭**: 支持优雅关闭和重启
- **配置管理**: 使用Nacos进行配置管理

### 10.2 运维支持
- **日志收集**: 集成ELK日志收集系统
- **监控告警**: 集成Prometheus监控系统
- **自动扩容**: 支持自动扩容和缩容
- **故障恢复**: 自动故障检测和恢复

## 11. 测试策略

### 11.1 单元测试
- **路由测试**: 测试路由转发功能
- **过滤器测试**: 测试过滤器功能
- **限流测试**: 测试限流保护功能
- **异常测试**: 测试异常处理功能

### 11.2 集成测试
- **服务集成**: 测试与微服务的集成
- **负载均衡**: 测试负载均衡功能
- **服务发现**: 测试服务发现功能
- **配置管理**: 测试配置管理功能

### 11.3 性能测试
- **压力测试**: 测试系统承载能力
- **并发测试**: 测试并发访问性能
- **稳定性测试**: 测试系统稳定性
- **容量测试**: 测试系统容量极限

## 12. 接口详细说明

### 12.1 认证服务路由
**接口路径**: `/auth/**`
**功能描述**: 路由转发到认证服务
**是否需要Feign客户端**: 否

**路由规则**:
- 路径匹配: `/auth/**`
- 目标服务: `service-auth`
- 负载均衡: 轮询策略
- 限流策略: 基于IP地址限流

**请求头添加**:
```
X-Gateway-Source: service-gateway
X-Service-Name: service-auth
X-Request-ID: {自动生成的请求ID}
X-Client-IP: {客户端IP地址}
X-User-Agent: {用户代理信息}
```

### 12.2 用户服务路由
**接口路径**: `/service/user/**`
**功能描述**: 路由转发到用户服务
**是否需要Feign客户端**: 否

**路由规则**:
- 路径匹配: `/service/user/**`
- 目标服务: `service-user`
- 负载均衡: 轮询策略
- 限流策略: 基于IP地址限流

**请求头添加**:
```
X-Gateway-Source: service-gateway
X-Service-Name: service-user
X-Request-ID: {自动生成的请求ID}
X-Client-IP: {客户端IP地址}
X-User-Agent: {用户代理信息}
```

### 12.3 发布者服务路由
**接口路径**: `/core/publisher/**`
**功能描述**: 路由转发到发布者服务
**是否需要Feign客户端**: 否

**路由规则**:
- 路径匹配: `/core/publisher/**`
- 目标服务: `core-publisher`
- 负载均衡: 轮询策略
- 限流策略: 基于IP地址限流

**请求头添加**:
```
X-Gateway-Source: service-gateway
X-Service-Name: core-publisher
X-Request-ID: {自动生成的请求ID}
X-Client-IP: {客户端IP地址}
X-User-Agent: {用户代理信息}
```

### 12.4 OSS服务路由
**接口路径**: `/third-party/oss/**`
**功能描述**: 路由转发到OSS服务
**是否需要Feign客户端**: 否

**路由规则**:
- 路径匹配: `/third-party/oss/**`
- 目标服务: `third-party-oss`
- 负载均衡: 轮询策略
- 限流策略: 基于IP地址限流

**请求头添加**:
```
X-Gateway-Source: service-gateway
X-Service-Name: third-party-oss
X-Request-ID: {自动生成的请求ID}
X-Client-IP: {客户端IP地址}
X-User-Agent: {用户代理信息}
```

### 12.5 网关健康检查
**接口路径**: `/actuator/health`
**功能描述**: 网关服务健康检查
**是否需要Feign客户端**: 否

**响应数据**:
```json
{
  "status": "UP",
  "components": {
    "discoveryComposite": {
      "status": "UP",
      "components": {
        "discoveryClient": {
          "status": "UP",
          "details": {
            "services": ["service-auth", "service-user", "core-publisher", "third-party-oss"]
          }
        }
      }
    },
    "diskSpace": {
      "status": "UP",
      "details": {
        "total": 107374182400,
        "free": 53687091200,
        "threshold": 10485760
      }
    }
  }
}
```

### 12.6 网关监控指标
**接口路径**: `/actuator/metrics`
**功能描述**: 网关性能监控指标
**是否需要Feign客户端**: 否

**响应数据**:
```json
{
  "names": [
    "gateway.requests",
    "gateway.requests.seconds",
    "gateway.requests.seconds.max",
    "gateway.requests.seconds.count",
    "gateway.requests.seconds.sum",
    "jvm.memory.used",
    "jvm.memory.max",
    "process.cpu.usage",
    "system.cpu.usage"
  ]
}
```

## 13. 文档和规范

### 13.1 代码规范
- **编码规范**: 遵循阿里巴巴Java开发手册
- **注释规范**: 完整的代码注释和文档
- **命名规范**: 统一的命名规范和约定
- **版本控制**: 规范的Git提交和分支管理

### 13.2 文档规范
- **API文档**: 完整的API接口文档
- **设计文档**: 详细的设计和架构文档
- **部署文档**: 完整的部署和运维文档
- **用户手册**: 用户使用和操作手册 