# third-party-wechatwork 模块设计文档

> **文档位置**: `zinfra/moudleDocs/third-party-wechatwork/模块设计.md`
> **创建时间**: 2025-07-31
> **作者**: scccy
> **状态**: 设计完成

## 1. 模块概述

### 1.1 模块定位
third-party-wechatwork模块是BanyuMall积分商城系统的企业微信集成服务模块，负责提供企业微信API的统一封装，为其他微服务提供企业微信相关的功能支持。

### 1.2 技术栈
- **框架**: Spring Boot 3.x
- **数据库**: MySQL 8.0+
- **ORM**: MyBatis-Plus
- **JSON处理**: fastjson2
- **服务端口**: 8086
- **基础路径**: `/tp/wechatwork`

### 1.3 核心功能
- 企业微信用户授权绑定
- 企业微信用户信息同步
- 客户联系人管理
- 群聊成员管理
- 朋友圈互动数据获取

## 2. 用户体系设计

### 2.1 用户类型定义

#### 2.1.1 BanyuMall系统用户 (sys_user)
- **标识**: `sys_user_id` (VARCHAR(32))
- **说明**: BanyuMall系统内部的用户账户
- **来源**: 系统内部创建
- **用途**: 系统登录、权限管理、业务操作

#### 2.1.2 企业微信内部用户 (wechatwork_users)
- **标识**: `userid` (VARCHAR(64)) - 企业微信API返回的内部用户ID
- **说明**: 企业微信员工账户
- **来源**: 企业微信API同步
- **用途**: 企业微信内部员工管理

#### 2.1.3 企业微信外部用户 (external_users)
- **标识**: `external_userid` (VARCHAR(64)) - 企业微信API返回的外部用户ID
- **说明**: 客户、群聊成员等外部联系人
- **来源**: 企业微信API获取
- **用途**: 客户管理、群聊成员管理、朋友圈互动

### 2.2 用户关系映射
```
sys_user (系统用户)
    ↓ (通过wechat_id关联)
wechatwork_users (企业微信内部用户)
    ↓ (通过API获取)
external_users (企业微信外部用户)
```

## 3. 数据库设计

### 3.1 数据库表结构

#### 3.1.1 企业微信用户信息表 (wechatwork_users)
```sql
CREATE TABLE `wechatwork_users` (
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `userid` VARCHAR(64) NOT NULL COMMENT '企业微信用户ID',
    `sys_user_id` VARCHAR(32) DEFAULT NULL COMMENT '关联的系统用户ID',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '用户姓名',
    `mobile` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `department` JSON DEFAULT NULL COMMENT '部门ID列表',
    `position` VARCHAR(50) DEFAULT NULL COMMENT '职位',
    `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
    `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
    `status` TINYINT(1) DEFAULT 1 COMMENT '状态：1-已激活，2-已禁用，4-未激活，5-退出企业',
    `enable` TINYINT(1) DEFAULT 1 COMMENT '是否启用：1-启用，0-禁用',
    `isleader` TINYINT(1) DEFAULT 0 COMMENT '是否部门领导：1-是，0-否',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_users_id`),
    UNIQUE KEY `uk_userid` (`userid`),
    UNIQUE KEY `uk_sys_user_id` (`sys_user_id`),
    KEY `idx_name` (`name`),
    KEY `idx_mobile` (`mobile`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信用户信息表';
```

#### 3.1.2 企业微信外部用户信息表 (external_users)
```sql
CREATE TABLE `external_users` (
    `external_users_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '企业微信外部用户ID',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '用户姓名',
    `type` TINYINT(1) DEFAULT 1 COMMENT '用户类型：1-微信用户，2-企业微信用户',
    `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
    `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    `unionid` VARCHAR(64) DEFAULT NULL COMMENT '微信unionid',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`external_users_id`),
    UNIQUE KEY `uk_external_userid` (`external_userid`),
    KEY `idx_name` (`name`),
    KEY `idx_unionid` (`unionid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信外部用户信息表';
```

#### 3.1.3 企业微信客户联系人关系表 (wechatwork_contacts)
```sql
CREATE TABLE `wechatwork_contacts` (
    `wechatwork_contacts_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '客户外部用户ID',
    `remark` VARCHAR(100) DEFAULT NULL COMMENT '备注',
    `description` VARCHAR(500) DEFAULT NULL COMMENT '描述',
    `createtime` BIGINT DEFAULT NULL COMMENT '创建时间戳',
    `tag_id` JSON DEFAULT NULL COMMENT '标签ID列表',
    `state` VARCHAR(50) DEFAULT NULL COMMENT '自定义状态',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_contacts_id`),
    UNIQUE KEY `uk_wechatwork_user_external` (`wechatwork_users_id`, `external_userid`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`),
    KEY `idx_external_userid` (`external_userid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信客户联系人关系表';
```

#### 3.1.4 企业微信群聊成员关系表 (wechatwork_group_members)
```sql
CREATE TABLE `wechatwork_group_members` (
    `wechatwork_group_members_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `chat_id` VARCHAR(64) NOT NULL COMMENT '群聊ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '外部用户ID',
    `type` TINYINT(1) DEFAULT 1 COMMENT '成员类型：1-企业成员，2-外部联系人',
    `join_time` BIGINT DEFAULT NULL COMMENT '入群时间戳',
    `group_nickname` VARCHAR(50) DEFAULT NULL COMMENT '群昵称',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '姓名',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_group_members_id`),
    UNIQUE KEY `uk_chat_external_user` (`chat_id`, `external_userid`),
    KEY `idx_chat_id` (`chat_id`),
    KEY `idx_external_userid` (`external_userid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信群聊成员关系表';
```

#### 3.1.5 企业微信朋友圈动态表 (wechatwork_moments)
```sql
CREATE TABLE `wechatwork_moments` (
    `wechatwork_moments_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `moment_id` VARCHAR(64) NOT NULL COMMENT '朋友圈动态ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `content` TEXT DEFAULT NULL COMMENT '动态内容',
    `media_urls` JSON DEFAULT NULL COMMENT '媒体文件URL列表',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_moments_id`),
    UNIQUE KEY `uk_moment_id` (`moment_id`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信朋友圈动态表';
```

#### 3.1.6 企业微信朋友圈互动表 (wechatwork_moment_interactions)
```sql
CREATE TABLE `wechatwork_moment_interactions` (
    `wechatwork_moment_interactions_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `moment_id` VARCHAR(64) NOT NULL COMMENT '朋友圈动态ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '互动外部用户ID',
    `interaction_type` TINYINT(1) NOT NULL COMMENT '互动类型：1-点赞，2-评论',
    `comment_content` TEXT DEFAULT NULL COMMENT '评论内容',
    `interaction_time` BIGINT DEFAULT NULL COMMENT '互动时间戳',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_moment_interactions_id`),
    UNIQUE KEY `uk_moment_user_interaction` (`moment_id`, `external_userid`, `interaction_type`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`),
    KEY `idx_external_userid` (`external_userid`),
    KEY `idx_interaction_type` (`interaction_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信朋友圈互动表';
```

### 3.2 表关系图
```
sys_user (系统用户表)
    ↓ (wechat_id)
wechatwork_users (企业微信用户表)
    ↓ (wechatwork_users_id)
wechatwork_contacts (客户联系人表)
    ↓ (external_userid)
external_users (外部用户表)

wechatwork_users (企业微信用户表)
    ↓ (wechatwork_users_id)
wechatwork_moments (朋友圈动态表)
    ↓ (moment_id)
wechatwork_moment_interactions (朋友圈互动表)
    ↓ (external_userid)
external_users (外部用户表)

wechatwork_group_members (群聊成员表)
    ↓ (external_userid)
external_users (外部用户表)
```

## 4. 核心业务逻辑

### 4.1 用户授权绑定流程

#### 4.1.1 业务流程
1. 用户扫描企业微信授权二维码
2. 用户确认授权，获取授权code
3. 调用企业微信API获取用户身份信息
4. 绑定系统用户与企业微信用户
5. 更新用户授权状态

#### 4.1.2 涉及API
- **获取访问用户身份**: `GET /cgi-bin/auth/getuserinfo`
- **获取用户详情**: `GET /cgi-bin/user/get`

#### 4.1.3 数据更新
- 更新 `sys_user` 表的 `wechat_id`、`wechat_auth_status`、`wechat_auth_time` 字段
- 创建或更新 `wechatwork_users` 表记录

### 4.2 客户联系人管理

#### 4.2.1 业务流程
1. 获取企业微信用户的客户列表
2. 获取每个客户的详细信息
3. 同步客户数据到本地数据库
4. 建立客户与发布者的关联关系

#### 4.2.2 涉及API
- **获取客户列表**: `GET /cgi-bin/externalcontact/list`
- **获取客户详情**: `GET /cgi-bin/externalcontact/get`

#### 4.2.3 数据同步
- 创建或更新 `external_users` 表记录
- 创建或更新 `wechatwork_contacts` 表记录

### 4.3 群聊成员管理

#### 4.3.1 业务流程
1. 获取指定群聊的成员列表
2. 获取群成员的详细信息
3. 同步群成员数据到本地数据库
4. 建立群成员与群聊的关联关系

#### 4.3.2 涉及API
- **获取群成员列表**: `POST /cgi-bin/externalcontact/group_chat/get`

#### 4.3.3 数据同步
- 创建或更新 `external_users` 表记录
- 创建或更新 `wechatwork_group_members` 表记录

### 4.4 朋友圈互动数据获取

#### 4.4.1 业务流程
1. 获取企业微信用户的朋友圈动态列表
2. 获取每个动态的点赞和评论数据
3. 同步互动数据到本地数据库
4. 生成互动统计报告

#### 4.4.2 涉及API
- **获取朋友圈动态列表**: `POST /cgi-bin/externalcontact/get_moment_list`
- **获取朋友圈互动数据**: `POST /cgi-bin/externalcontact/get_moment_comments`

#### 4.4.3 数据同步
- 创建或更新 `wechatwork_moments` 表记录
- 创建或更新 `wechatwork_moment_interactions` 表记录

## 5. 技术架构设计

### 5.1 模块结构
```
third-party-wechatwork/
├── config/                 # 配置类
│   ├── WechatWorkConfig.java
│   └── WebConfig.java
├── controller/             # 控制器
│   ├── WechatWorkAuthController.java
│   ├── WechatWorkUserController.java
│   ├── WechatWorkContactController.java
│   ├── WechatWorkGroupController.java
│   └── WechatWorkMomentController.java
├── service/                # 服务层
│   ├── WechatWorkAuthService.java
│   ├── WechatWorkUserService.java
│   ├── WechatWorkContactService.java
│   ├── WechatWorkGroupService.java
│   ├── WechatWorkMomentService.java
│   └── impl/
├── mapper/                 # 数据访问层
│   ├── WechatWorkUsersMapper.java
│   ├── ExternalUsersMapper.java
│   ├── WechatWorkContactsMapper.java
│   ├── WechatWorkGroupMembersMapper.java
│   ├── WechatWorkMomentsMapper.java
│   └── WechatWorkMomentInteractionsMapper.java
├── entity/                 # 实体类
│   ├── WechatWorkUsers.java
│   ├── ExternalUsers.java
│   ├── WechatWorkContacts.java
│   ├── WechatWorkGroupMembers.java
│   ├── WechatWorkMoments.java
│   └── WechatWorkMomentInteractions.java
├── dto/                    # 数据传输对象
│   ├── request/
│   └── response/
├── util/                   # 工具类
│   ├── WechatWorkApiUtil.java
│   └── WechatWorkTokenUtil.java
└── ThirdPartyWechatWorkApplication.java
```

### 5.2 核心配置

#### 5.2.1 应用配置 (application.yml)
```yaml
server:
  port: 8086

spring:
  application:
    name: third-party-wechatwork
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/banyu_mall?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}

wechatwork:
  corp-id: ${WECHATWORK_CORP_ID}
  agent-id: ${WECHATWORK_AGENT_ID}
  secret: ${WECHATWORK_SECRET}
  token: ${WECHATWORK_TOKEN}
  encoding-aes-key: ${WECHATWORK_ENCODING_AES_KEY}
  api-base-url: https://qyapi.weixin.qq.com
```

#### 5.2.2 企业微信配置类
```java
@Configuration
@ConfigurationProperties(prefix = "wechatwork")
@Data
public class WechatWorkConfig {
    private String corpId;
    private String agentId;
    private String secret;
    private String token;
    private String encodingAesKey;
    private String apiBaseUrl;
}
```

### 5.3 核心服务接口

#### 5.3.1 授权服务接口
```java
public interface WechatWorkAuthService {
    /**
     * 获取访问用户身份
     */
    WechatWorkUserInfo getUserInfo(String code);
    
    /**
     * 绑定企业微信用户
     */
    boolean bindWechatWorkUser(String sysUserId, String userid);
    
    /**
     * 解绑企业微信用户
     */
    boolean unbindWechatWorkUser(String sysUserId);
}
```

#### 5.3.2 用户服务接口
```java
public interface WechatWorkUserService {
    /**
     * 获取用户详情
     */
    WechatWorkUserDetail getUserDetail(String userid);
    
    /**
     * 同步用户信息
     */
    boolean syncUserInfo(String userid);
    
    /**
     * 获取部门成员列表
     */
    List<WechatWorkUser> getDepartmentMembers(Long departmentId, boolean fetchChild);
}
```

#### 5.3.3 客户服务接口
```java
public interface WechatWorkContactService {
    /**
     * 获取客户列表
     */
    List<String> getContactList(String userid);
    
    /**
     * 获取客户详情
     */
    WechatWorkContactDetail getContactDetail(String externalUserid);
    
    /**
     * 同步客户信息
     */
    boolean syncContactInfo(String userid);
}
```

#### 5.3.4 群聊服务接口
```java
public interface WechatWorkGroupService {
    /**
     * 获取群成员列表
     */
    WechatWorkGroupChat getGroupMembers(String chatId);
    
    /**
     * 同步群成员信息
     */
    boolean syncGroupMembers(String chatId);
}
```

#### 5.3.5 朋友圈服务接口
```java
public interface WechatWorkMomentService {
    /**
     * 获取朋友圈动态列表
     */
    List<WechatWorkMoment> getMomentList(WechatWorkMomentQueryRequest request);
    
    /**
     * 获取朋友圈互动数据
     */
    WechatWorkMomentInteraction getMomentInteractions(String momentId, String userid);
    
    /**
     * 同步朋友圈数据
     */
    boolean syncMomentData(String userid);
}
```

## 6. API接口设计

### 6.1 授权相关接口

#### 6.1.1 获取授权URL
```http
GET /tp/wechatwork/auth/url
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "authUrl": "https://open.weixin.qq.com/connect/oauth2/authorize?appid=CORPID&redirect_uri=REDIRECT_URI&response_type=code&scope=snsapi_base&state=STATE#wechat_redirect"
    }
}
```

#### 6.1.2 处理授权回调
```http
POST /tp/wechatwork/auth/callback
```

**请求参数**:
```json
{
    "code": "授权码",
    "state": "状态参数"
}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "userid": "企业微信用户ID",
        "sysUserId": "系统用户ID",
        "bindStatus": true
    }
}
```

### 6.2 用户管理接口

#### 6.2.1 获取用户详情
```http
GET /tp/wechatwork/user/{userid}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "userid": "zhangsan",
        "name": "张三",
        "mobile": "13800000000",
        "department": [1, 2],
        "position": "产品经理",
        "gender": 1,
        "email": "zhangsan@example.com",
        "avatar": "http://wx.qlogo.cn/...",
        "status": 1,
        "enable": 1,
        "isleader": 0
    }
}
```

#### 6.2.2 同步用户信息
```http
POST /tp/wechatwork/user/sync/{userid}
```

### 6.3 客户管理接口

#### 6.3.1 获取客户列表
```http
GET /tp/wechatwork/contact/list/{userid}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "total": 10,
        "list": [
            {
                "externalUserid": "wmxxx",
                "name": "张三",
                "avatar": "http://wx.qlogo.cn/...",
                "gender": 1,
                "remark": "备注",
                "description": "描述"
            }
        ]
    }
}
```

#### 6.3.2 获取客户详情
```http
GET /tp/wechatwork/contact/{externalUserid}
```

#### 6.3.3 同步客户信息
```http
POST /tp/wechatwork/contact/sync/{userid}
```

### 6.4 群聊管理接口

#### 6.4.1 获取群成员列表
```http
POST /tp/wechatwork/group/members
```

**请求参数**:
```json
{
    "chatId": "群聊ID",
    "needName": 1
}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "chatId": "wrOgNnBK-AF8ZxfJ...",
        "name": "测试群聊",
        "owner": "zhangsan",
        "memberCount": 10,
        "memberList": [
            {
                "externalUserid": "wmxxx",
                "type": 1,
                "joinTime": 1572505490,
                "groupNickname": "张三",
                "name": "张三"
            }
        ]
    }
}
```

#### 6.4.2 同步群成员信息
```http
POST /tp/wechatwork/group/sync
```

### 6.5 朋友圈管理接口

#### 6.5.1 获取朋友圈动态列表
```http
POST /tp/wechatwork/moment/list
```

**请求参数**:
```json
{
    "userid": "zhangsan",
    "cursor": "",
    "limit": 20
}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "nextCursor": "CURSOR",
        "list": [
            {
                "momentId": "momxxx",
                "content": "动态内容",
                "mediaUrls": ["http://...", "http://..."],
                "createTime": 1600000000
            }
        ]
    }
}
```

#### 6.5.2 获取朋友圈互动数据
```http
POST /tp/wechatwork/moment/interactions
```

**请求参数**:
```json
{
    "momentId": "momxxx",
    "userid": "zhangsan"
}
```

**响应示例**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "momentId": "momxxx",
        "commentList": [
            {
                "externalUserid": "wmxxx",
                "createTime": 1600000000,
                "content": "评论内容"
            }
        ],
        "likeList": [
            {
                "externalUserid": "wmxxx",
                "createTime": 1600000000
            }
        ]
    }
}
```

#### 6.5.3 同步朋友圈数据
```http
POST /tp/wechatwork/moment/sync/{userid}
```

## 7. 异常处理与错误码

### 7.1 异常处理机制
- **统一异常处理**: 使用`@ControllerAdvice`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 处理系统级异常和网络异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 7.2 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 500 | 系统错误 | 系统内部错误 |

#### 第三方服务通用错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 4000 | 第三方服务错误 | 第三方服务通用错误 |
| 4001 | 第三方服务不可用 | 第三方服务不可用 |
| 4002 | 第三方服务超时 | 第三方服务超时 |
| 4003 | 第三方服务配置错误 | 第三方服务配置错误 |

#### 企业微信服务错误码 (42xx) - 预留
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 4200 | 企业微信服务错误 | 企业微信服务通用错误 |
| 4201 | 企业微信API错误 | 企业微信API调用失败 |
| 4202 | 企业微信认证错误 | 企业微信认证失败 |
| 4203 | 企业微信回调错误 | 企业微信回调处理失败 |
| 4204 | 企业微信用户不存在 | 企业微信用户不存在 |
| 4205 | 企业微信部门不存在 | 企业微信部门不存在 |

### 7.3 异常处理流程
```
1. 异常发生
   ↓
2. 异常拦截器捕获
   ↓
3. 异常分类处理
   ↓
4. 错误码映射
   ↓
5. 错误信息格式化
   ↓
6. 返回统一错误响应
```

### 7.4 异常类型定义
```java
// 使用统一的ErrorCode枚举，企业微信相关错误码在4200-4299范围内
// 当前模块未构建，预留错误码空间
public enum WechatWorkErrorCode {
    // 企业微信服务通用错误
    WECHATWORK_SERVICE_ERROR(4200, "企业微信服务错误"),
    
    // 预留错误码空间，待模块构建时完善
    // 4201-4299: 企业微信具体错误码
}
```

### 7.5 全局异常处理
```java
@RestControllerAdvice
public class WechatWorkGlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResultData<Object> handleBusinessException(BusinessException e) {
        log.warn("企业微信业务异常: {}", e.getMessage());
        return ResultData.fail(e.getErrorCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public ResultData<Object> handleException(Exception e) {
        log.error("企业微信系统异常", e);
        return ResultData.fail(ErrorCode.INTERNAL_ERROR, "系统内部错误");
    }
}
```

## 8. 安全设计

### 8.1 接口安全
- 所有接口都需要进行身份验证
- 使用JWT Token进行身份验证
- 敏感接口需要权限验证

### 8.2 数据安全
- 敏感数据加密存储
- 数据库连接使用SSL
- 定期备份重要数据

### 8.3 配置安全
- 敏感配置使用环境变量
- 配置文件不包含敏感信息
- 生产环境配置隔离

## 9. 性能优化

### 9.1 数据库优化
- 合理设计索引
- 使用连接池
- 定期清理无用数据

### 9.2 缓存策略
- 企业微信Token缓存
- 用户信息缓存
- 接口响应缓存

### 9.3 异步处理
- 数据同步异步处理
- 消息队列处理大量数据
- 定时任务处理

## 10. 监控与日志

### 10.1 日志配置
- 使用Log4j2进行日志记录
- 不同级别日志分别记录
- 敏感信息脱敏处理

### 10.2 监控指标
- 接口调用次数和响应时间
- 数据同步成功率
- 系统资源使用情况

### 10.3 告警机制
- API调用失败告警
- 数据同步异常告警
- 系统资源告警

## 11. 部署说明

### 11.1 环境要求
- JDK 21
- MySQL 8.0+
- Redis 6.0+

### 11.2 部署步骤
1. 准备数据库环境
2. 配置应用参数
3. 打包应用
4. 部署到服务器
5. 启动应用
6. 验证服务状态

### 11.3 配置检查清单
- [ ] 数据库连接配置
- [ ] 企业微信应用配置
- [ ] 日志配置
- [ ] 监控配置
- [ ] 安全配置

## 12. 测试计划

### 12.1 单元测试
- 服务层方法测试
- 工具类方法测试
- 异常处理测试

### 12.2 集成测试
- API接口测试
- 数据库操作测试
- 企业微信API集成测试

### 12.3 性能测试
- 接口响应时间测试
- 并发处理能力测试
- 数据同步性能测试

## 13. 总结

本设计文档详细描述了third-party-wechatwork模块的完整设计方案，包括：

1. **用户体系设计**: 明确定义了三种用户类型及其关系
2. **数据库设计**: 完整的表结构设计和关系映射
3. **业务逻辑设计**: 详细的核心业务流程
4. **技术架构设计**: 模块结构和核心配置
5. **API接口设计**: 完整的接口定义和示例
6. **安全与性能**: 安全设计和性能优化方案
7. **部署与测试**: 部署说明和测试计划

该设计遵循了MySQL数据开发规范，确保了数据的一致性和系统的可维护性。通过统一使用`external_userid`作为外部用户标识，解决了用户体系混乱的问题，为后续的开发和维护奠定了良好的基础。 