# third-party-wechatwork 模块主体讨论

> **文档位置**: `zinfra/moudleDocs/third-party-wechatwork/模块主体讨论.md`
> **创建时间**: 2025-01-27
> **作者**: scccy
> **更新时间**: 2025-01-27

## 微服务模块级别信息

### 模块层级结构
- **当前微服务模块级别**: 三级微服务
- **父模块**: third-party (二级模块 - 第三方业务模块)
- **模块类型**: 企业微信集成服务
- **服务端口**: 8086
- **基础路径**: `/tp/wechatwork`

### 功能实现对应文档
- **基础API文档**: https://developer.work.weixin.qq.com/document/path/91201
- **服务端API文档**: https://developer.work.weixin.qq.com/document/path/92424
- **群聊管理API**: https://developer.work.weixin.qq.com/document/path/92122
- **朋友圈API**: https://developer.work.weixin.qq.com/document/path/93506
- **朋友圈互动API**: https://developer.work.weixin.qq.com/document/path/93333
- **客户管理API**: https://developer.work.weixin.qq.com/document/path/92109

## 用户体系设计

### 用户类型定义
BanyuMall系统与企业微信集成涉及三种用户类型：

#### 1. BanyuMall系统用户 (sys_user)
- **标识**: `sys_user_id` (VARCHAR(32))
- **说明**: BanyuMall系统内部的用户账户
- **来源**: 系统内部创建
- **用途**: 系统登录、权限管理、业务操作

#### 2. 企业微信内部用户 (wechatwork_users)
- **标识**: `userid` (VARCHAR(64)) - 企业微信API返回的内部用户ID
- **说明**: 企业微信员工账户
- **来源**: 企业微信API同步
- **用途**: 企业微信内部员工管理

#### 3. 企业微信外部用户 (external_users)
- **标识**: `external_userid` (VARCHAR(64)) - 企业微信API返回的外部用户ID
- **说明**: 客户、群聊成员等外部联系人
- **来源**: 企业微信API获取
- **用途**: 客户管理、群聊成员管理、朋友圈互动

### 用户关系映射
```
sys_user (系统用户)
    ↓ (通过wechat_id关联)
wechatwork_users (企业微信内部用户)
    ↓ (通过API获取)
external_users (企业微信外部用户)
```

### BanyuMall系统字段与企业微信API字段映射关系

#### BanyuMall系统内部字段
- **`sys_user_id`**: BanyuMall系统用户ID，关联到sys_user表的主键
- **`wechatwork_users_id`**: 企业微信用户信息表主键ID
- **`external_userid`**: 企业微信外部用户ID（统一标识）
- **`wechatwork_contacts_id`**: 客户联系人关系表主键ID
- **`wechatwork_group_members_id`**: 群聊成员关系表主键ID
- **`wechatwork_moments_id`**: 朋友圈动态表主键ID
- **`wechatwork_moment_interactions_id`**: 朋友圈互动表主键ID

#### 企业微信API返回字段
- **`userid`**: 企业微信API返回的内部用户ID
- **`external_userid`**: 企业微信API返回的外部用户ID
- **`moment_id`**: 企业微信API返回的朋友圈动态ID
- **`chat_id`**: 企业微信API返回的群聊ID

#### 字段映射关系表
| BanyuMall系统字段 | 企业微信API字段 | 说明 | 数据来源 |
|------------------|-----------------|------|----------|
| `wechatwork_users.userid` | `userid` | 企业微信内部用户ID | 获取用户详情API |
| `external_users.external_userid` | `external_userid` | 外部用户ID（统一标识） | 获取客户列表API |
| `wechatwork_contacts.external_userid` | `external_userid` | 客户外部用户ID | 获取客户列表API |
| `wechatwork_group_members.external_userid` | `external_userid` | 群聊成员外部用户ID | 获取群成员列表API |
| `wechatwork_moments.moment_id` | `moment_id` | 朋友圈动态ID | 获取朋友圈动态API |
| `wechatwork_moment_interactions.moment_id` | `moment_id` | 朋友圈动态ID | 获取朋友圈互动API |
| `wechatwork_moment_interactions.external_userid` | `external_userid` | 互动外部用户ID | 获取朋友圈互动API |
| `wechatwork_contacts.wechatwork_users_id` | - | 发布者企业微信用户ID | 系统内部关联 |
| `wechatwork_group_members.chat_id` | `chat_id` | 群聊ID | 获取群成员列表API |

### 模块定位
third-party-wechatwork模块是BanyuMall积分商城系统的企业微信集成服务模块。在微服务架构中，需要与企业微信进行深度集成，实现消息推送、用户同步、应用管理等功能。该模块负责提供企业微信API的统一封装，为其他微服务提供企业微信相关的功能支持。

## 业务主体逻辑

### 1. 发布者扫码获取微信授权相关信息

**业务流程**:
1. 发布者扫描二维码进入授权页面
2. 用户确认授权，获取授权code
3. 通过code换取access_token和用户信息
4. 绑定用户表的wechat_id，记录授权状态

**需要使用的API接口**:
- **获取访问用户身份**: `GET /cgi-bin/auth/getuserinfo`
- **获取用户详情**: `GET /cgi-bin/user/get`
- **获取部门成员**: `GET /cgi-bin/user/simplelist`
- **获取部门成员详情**: `GET /cgi-bin/user/list`

**数据表字段**:
```sql
-- 用户表扩展字段
ALTER TABLE sys_user ADD COLUMN wechat_id VARCHAR(64) COMMENT '企业微信用户ID';
ALTER TABLE sys_user ADD COLUMN wechat_auth_status TINYINT(1) DEFAULT 0 COMMENT '企业微信授权状态：0-未授权，1-已授权';
ALTER TABLE sys_user ADD COLUMN wechat_auth_time DATETIME COMMENT '企业微信授权时间';

-- 企业微信用户信息表
CREATE TABLE `wechatwork_users` (
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `userid` VARCHAR(64) NOT NULL COMMENT '企业微信用户ID',
    `sys_user_id` VARCHAR(32) DEFAULT NULL COMMENT '关联的系统用户ID',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '用户姓名',
    `mobile` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `department` JSON DEFAULT NULL COMMENT '部门ID列表',
    `position` VARCHAR(50) DEFAULT NULL COMMENT '职位',
    `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
    `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
    `status` TINYINT(1) DEFAULT 1 COMMENT '状态：1-已激活，2-已禁用，4-未激活，5-退出企业',
    `enable` TINYINT(1) DEFAULT 1 COMMENT '是否启用：1-启用，0-禁用',
    `isleader` TINYINT(1) DEFAULT 0 COMMENT '是否部门领导：1-是，0-否',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_users_id`),
    UNIQUE KEY `uk_userid` (`userid`),
    UNIQUE KEY `uk_sys_user_id` (`sys_user_id`),
    KEY `idx_name` (`name`),
    KEY `idx_mobile` (`mobile`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信用户信息表';

-- 企业微信外部用户信息表
CREATE TABLE `external_users` (
    `external_users_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '企业微信外部用户ID',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '用户姓名',
    `type` TINYINT(1) DEFAULT 1 COMMENT '用户类型：1-微信用户，2-企业微信用户',
    `avatar` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
    `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    `unionid` VARCHAR(64) DEFAULT NULL COMMENT '微信unionid',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`external_users_id`),
    UNIQUE KEY `uk_external_userid` (`external_userid`),
    KEY `idx_name` (`name`),
    KEY `idx_unionid` (`unionid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信外部用户信息表';
```

### 2. 获取发布者企业微信的联系人信息,指定群聊/组的用户列表

**业务流程**:
1. 获取发布者的客户联系人列表
2. 获取指定群聊的成员列表
3. 获取群成员详细信息
4. 同步联系人数据到系统

**需要使用的API接口**:
- **获取客户列表**: `GET /cgi-bin/externalcontact/list`
- **获取客户详情**: `GET /cgi-bin/externalcontact/get`
- **获取群成员列表**: `POST /cgi-bin/externalcontact/group_chat/get`
- **获取用户详情**: `GET /cgi-bin/user/get`

**数据表设计**:
```sql
-- 客户联系人关系表
CREATE TABLE `wechatwork_contacts` (
    `wechatwork_contacts_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '客户外部用户ID',
    `remark` VARCHAR(100) DEFAULT NULL COMMENT '备注',
    `description` VARCHAR(500) DEFAULT NULL COMMENT '描述',
    `createtime` BIGINT DEFAULT NULL COMMENT '创建时间戳',
    `tag_id` JSON DEFAULT NULL COMMENT '标签ID列表',
    `state` VARCHAR(50) DEFAULT NULL COMMENT '自定义状态',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_contacts_id`),
    UNIQUE KEY `uk_wechatwork_user_external` (`wechatwork_users_id`, `external_userid`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`),
    KEY `idx_external_userid` (`external_userid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信客户联系人关系表';

-- 群聊成员关系表
CREATE TABLE `wechatwork_group_members` (
    `wechatwork_group_members_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `chat_id` VARCHAR(64) NOT NULL COMMENT '群聊ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '外部用户ID',
    `type` TINYINT(1) DEFAULT 1 COMMENT '成员类型：1-企业成员，2-外部联系人',
    `join_time` BIGINT DEFAULT NULL COMMENT '入群时间戳',
    `group_nickname` VARCHAR(50) DEFAULT NULL COMMENT '群昵称',
    `name` VARCHAR(50) DEFAULT NULL COMMENT '姓名',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_group_members_id`),
    UNIQUE KEY `uk_chat_external_user` (`chat_id`, `external_userid`),
    KEY `idx_chat_id` (`chat_id`),
    KEY `idx_external_userid` (`external_userid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信群聊成员关系表';
```

### 3. 获取发布者企业微信的点赞人员信息,评论人员信息

**业务流程**:
1. 获取发布者发布的朋友圈动态列表
2. 获取每个动态的点赞人员列表
3. 获取每个动态的评论人员信息
4. 统计互动数据，生成报告

**需要使用的API接口**:
- **获取朋友圈动态列表**: `POST /cgi-bin/externalcontact/get_moment_list`
- **获取朋友圈互动数据**: `POST /cgi-bin/externalcontact/get_moment_comments`
- **获取客户详情**: `GET /cgi-bin/externalcontact/get`

**数据表设计**:
```sql
-- 朋友圈动态表
CREATE TABLE `wechatwork_moments` (
    `wechatwork_moments_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `moment_id` VARCHAR(64) NOT NULL COMMENT '朋友圈动态ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `content` TEXT DEFAULT NULL COMMENT '动态内容',
    `media_urls` JSON DEFAULT NULL COMMENT '媒体文件URL列表',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_moments_id`),
    UNIQUE KEY `uk_moment_id` (`moment_id`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信朋友圈动态表';

-- 朋友圈互动表
CREATE TABLE `wechatwork_moment_interactions` (
    `wechatwork_moment_interactions_id` VARCHAR(32) NOT NULL COMMENT '主键ID',
    `moment_id` VARCHAR(64) NOT NULL COMMENT '朋友圈动态ID',
    `wechatwork_users_id` VARCHAR(32) NOT NULL COMMENT '发布者企业微信用户ID',
    `external_userid` VARCHAR(64) NOT NULL COMMENT '互动外部用户ID',
    `interaction_type` TINYINT(1) NOT NULL COMMENT '互动类型：1-点赞，2-评论',
    `comment_content` TEXT DEFAULT NULL COMMENT '评论内容',
    `interaction_time` BIGINT DEFAULT NULL COMMENT '互动时间戳',
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `created_by` VARCHAR(32) DEFAULT NULL COMMENT '创建人ID',
    `updated_by` VARCHAR(32) DEFAULT NULL COMMENT '更新人ID',
    `deleted` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`wechatwork_moment_interactions_id`),
    UNIQUE KEY `uk_moment_user_interaction` (`moment_id`, `external_userid`, `interaction_type`),
    KEY `idx_wechatwork_users_id` (`wechatwork_users_id`),
    KEY `idx_external_userid` (`external_userid`),
    KEY `idx_interaction_type` (`interaction_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='企业微信朋友圈互动表';
```

## 1. 模块概述

### 1.1 模块背景
随着企业数字化转型的深入，企业微信已成为企业内部沟通和外部客户服务的重要平台。BanyuMall积分商城系统需要与企业微信进行深度集成，实现以下目标：
- 通过企业微信进行消息推送和通知
- 同步企业微信用户信息到系统
- 提供企业微信应用管理功能
- 支持企业微信机器人消息推送
- 实现企业微信与系统的单点登录

### 1.2 业务需求

#### 用户授权绑定
用户需要授权登入后,绑定用户表的wechat_id,实现企业微信与用户关系的绑定,同时还要有授权相关字段

**API接口**: 获取访问用户身份
```http
GET /cgi-bin/auth/getuserinfo?access_token=ACCESS_TOKEN&code=CODE
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "userid": "zhangsan",
    "user_ticket": "USER_TICKET",
    "expires_in": 7200
}
```

#### 企业微信用户信息管理
获取企业微信用户的详细信息

**API接口**: 获取用户详情
```http
GET /cgi-bin/user/get?access_token=ACCESS_TOKEN&userid=USERID
```

**请求示例**:
```http
GET /cgi-bin/user/get?access_token=ACCESS_TOKEN&userid=zhangsan
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "userid": "zhangsan",
    "name": "张三",
    "department": [1, 2],
    "position": "产品经理",
    "mobile": "13800000000",
    "gender": "1",
    "email": "zhangsan@example.com",
    "avatar": "http://wx.qlogo.cn/...",
    "status": 1,
    "enable": 1,
    "isleader": 0
}
```

**API接口**: 获取部门成员列表
```http
GET /cgi-bin/user/simplelist?access_token=ACCESS_TOKEN&department_id=DEPARTMENT_ID&fetch_child=FETCH_CHILD
```

**请求示例**:
```http
GET /cgi-bin/user/simplelist?access_token=ACCESS_TOKEN&department_id=1&fetch_child=1
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "userlist": [
        {
            "userid": "zhangsan",
            "name": "张三"
        },
        {
            "userid": "lisi",
            "name": "李四"
        }
    ]
}
```

#### 客户联系人管理
获取所有联系人的列表，包括客户信息

**API接口**: 获取客户列表
```http
GET /cgi-bin/externalcontact/list?access_token=ACCESS_TOKEN&userid=USERID
```

**请求示例**:
```http
GET /cgi-bin/externalcontact/list?access_token=ACCESS_TOKEN&userid=zhangsan
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "external_userid": [
        "wmxxx",
        "wmxxx2"
    ]
}
```

**API接口**: 获取客户详情
```http
GET /cgi-bin/externalcontact/get?access_token=ACCESS_TOKEN&external_userid=EXTERNAL_USERID&cursor=CURSOR
```

**请求示例**:
```http
GET /cgi-bin/externalcontact/get?access_token=ACCESS_TOKEN&external_userid=wmxxx&cursor=
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "external_contact": {
        "external_userid": "wmxxx",
        "name": "张三",
        "type": 1,
        "avatar": "http://wx.qlogo.cn/...",
        "gender": 1,
        "unionid": "oxxxx"
    },
    "follow_info": {
        "remark": "备注",
        "description": "描述",
        "createtime": 1600000000,
        "tag_id": ["tagxxx"],
        "state": "statexxx"
    }
}
```

#### 群聊成员管理
获取指定微信群中的社群人员id 微信号,昵称等数据

**API接口**: 获取群成员列表
```http
POST /cgi-bin/externalcontact/group_chat/get
```

**请求示例**:
```json
{
    "chat_id": "wrOgNnBK-AF8ZxfJ...",
    "need_name": 1
}
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "group_chat": {
        "chat_id": "wrOgNnBK-AF8ZxfJ...",
        "name": "测试群聊",
        "owner": "zhangsan",
        "member_list": [
            {
                "userid": "zhangsan",
                "type": 1,
                "join_time": 1572505490,
                "group_nickname": "张三",
                "name": "张三"
            }
        ]
    }
}
```

#### 朋友圈互动数据获取
获取朋友圈动态的点赞列表和评论数据

**API接口**: 获取朋友圈互动数据
```http
POST /cgi-bin/externalcontact/get_moment_comments?access_token=ACCESS_TOKEN
```

**请求示例**:
```json
{
    "moment_id": "momxxx",
    "userid": "zhangsan"
}
```

**返回示例**:
```json
{
    "errcode": 0,
    "errmsg": "ok",
    "comment_list": [
        {
            "external_userid": "wmxxx",
            "create_time": 1600000000,
            "text": {
                "content": "评论内容"
            }
        }
    ],
    "like_list": [
        {
            "external_userid": "wmxxx",
            "create_time": 1600000000
        }
    ]
}
```

## 2. 设计原则

### 2.1 用户标识统一原则
- **外部用户统一标识**: 所有客户、群聊成员等外部用户统一使用 `external_userid` 作为唯一标识
- **内部用户关联**: 企业微信内部用户通过 `userid` 与系统用户 `sys_user_id` 关联
- **数据一致性**: 确保同一外部用户在不同场景下使用相同的 `external_userid`

### 2.2 数据表设计原则
- **遵循MySQL规范**: 严格按照 `MySQL数据开发规范.md` 进行表结构设计
- **主键设计**: 所有表使用VARCHAR(32)作为主键，采用雪花算法生成
- **通用字段**: 所有表包含标准的创建时间、更新时间、删除标记等字段
- **索引优化**: 为常用查询字段建立合适的索引，提高查询性能

### 2.3 业务逻辑原则
- **数据同步**: 定期同步企业微信数据到本地数据库
- **关系维护**: 维护好三种用户类型之间的关系映射
- **数据完整性**: 确保数据的完整性和一致性
- **性能优化**: 合理设计查询和索引，避免性能瓶颈

