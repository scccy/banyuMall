# Service Common 模块设计文档

## 📋 模块概述

**模块名称**: service-common  
**模块类型**: 通用工具模块  
**技术栈**: Spring Boot + FastJSON2 + JWT + Log4j2  
**作者**: scccy  
**创建时间**: 2025-07-31  

### 模块职责
- **统一响应格式**: 提供统一的API响应数据结构
- **异常处理**: 提供统一的业务异常处理机制
- **工具类**: 提供通用的工具类和辅助方法
- **枚举定义**: 定义系统中使用的枚举类型
- **基础实体**: 提供基础实体类和通用字段
- **日志配置**: 提供统一的日志配置

## 🏗️ 架构设计

### 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   微服务集群     │───▶│  Service Common  │───▶│   通用组件      │
│                │    │                │    │                │
│ - core-publisher│    │ - 统一响应格式  │    │ - ResultData   │
│ - service-user  │    │ - 异常处理      │    │ - BusinessException│
│ - service-auth  │    │ - 工具类        │    │ - 工具类        │
│ - service-gateway│   │ - 枚举定义      │    │ - 枚举类        │
│ - third-party-* │    │ - 基础实体      │    │ - 基础实体      │
└─────────────────┘    │ - 日志配置      │    └─────────────────┘
                       └─────────────────┘
```

### 核心组件
1. **ResultData**: 统一API响应数据结构
2. **BusinessException**: 业务异常处理类
3. **ErrorCode**: 错误码定义枚举
4. **BaseEntity**: 基础实体类
5. **UserUtils**: 用户工具类
6. **ValidationUtils**: 验证工具类
7. **UserPermissionUtil**: 用户权限工具类

## 🔧 核心功能

### 1. 统一响应格式 (ResultData)
- **成功响应**: 统一的成功响应格式
- **错误响应**: 统一的错误响应格式
- **分页响应**: 支持分页数据的响应格式
- **数据包装**: 自动包装返回数据

### 2. 异常处理 (BusinessException)
- **业务异常**: 处理业务逻辑异常
- **错误码映射**: 统一的错误码定义
- **异常信息**: 标准化的异常信息格式
- **异常传播**: 支持异常在微服务间传播

### 3. 工具类集合
- **UserUtils**: 用户相关工具方法
- **ValidationUtils**: 数据验证工具方法
- **UserPermissionUtil**: 用户权限验证工具

### 4. 枚举定义
- **UserStatusEnum**: 用户状态枚举
- **UserTypeEnum**: 用户类型枚举
- **ErrorCode**: 错误码枚举

### 5. 基础实体
- **BaseEntity**: 包含通用字段的基础实体
- **RequestTrace**: 请求追踪信息

## 📊 数据模型

### 1. ResultData (统一响应数据结构)
```java
public class ResultData<T> {
    private Integer code;           // 响应码
    private String message;         // 响应消息
    private T data;                // 响应数据
    private Long timestamp;         // 时间戳
    private String traceId;         // 追踪ID
}
```

### 2. BusinessException (业务异常)
```java
public class BusinessException extends RuntimeException {
    private Integer code;           // 错误码
    private String message;         // 错误消息
    private Object[] args;          // 错误参数
}
```

### 3. ErrorCode (错误码枚举)
```java
public enum ErrorCode {
    SUCCESS(200, "操作成功"),
    PARAM_ERROR(400, "参数错误"),
    UNAUTHORIZED(401, "未授权"),
    FORBIDDEN(403, "禁止访问"),
    NOT_FOUND(404, "资源不存在"),
    INTERNAL_ERROR(500, "内部服务器错误");
    
    private final Integer code;
    private final String message;
}
```

### 4. BaseEntity (基础实体)
```java
public class BaseEntity {
    private LocalDateTime createdTime;  // 创建时间
    private LocalDateTime updatedTime;  // 更新时间
    private String createdBy;           // 创建人
    private String updatedBy;           // 更新人
    private Integer deleted;            // 逻辑删除标识
}
```

### 5. RequestTrace (请求追踪)
```java
public class RequestTrace {
    private String traceId;         // 追踪ID
    private String userId;          // 用户ID
    private String username;        // 用户名
    private String ipAddress;       // IP地址
    private String userAgent;       // 用户代理
    private LocalDateTime timestamp; // 时间戳
}
```

## 🔌 接口设计

### 1. 文件上传相关DTO

#### FileUploadRequest (文件上传请求)
```java
public class FileUploadRequest {
    private String sourceService;   // 来源服务
    private String businessType;    // 业务类型
    private String filePath;        // 文件路径
    private Long uploadUserId;      // 上传用户ID
    private String uploadUserName;  // 上传用户名
}
```

#### FileUploadResponse (文件上传响应)
```java
public class FileUploadResponse {
    private Long fileId;            // 文件ID
    private String originalName;    // 原始文件名
    private Long fileSize;          // 文件大小
    private String mimeType;        // MIME类型
    private String objectKey;       // OSS对象键
    private String accessUrl;       // 访问URL
    private String bucketName;      // 存储桶名称
    private String filePath;        // 文件路径
    private String sourceService;   // 来源服务
    private String businessType;    // 业务类型
    private Long uploadUserId;      // 上传用户ID
    private String uploadUserName;  // 上传用户名
    private LocalDateTime uploadTime; // 上传时间
}
```

### 2. 用户认证相关DTO

#### LoginRequest (登录请求)
```java
public class LoginRequest {
    private String username;        // 用户名
    private String password;        // 密码
    private String captcha;         // 验证码
    private String captchaId;       // 验证码ID
}
```

#### LoginResponse (登录响应)
```java
public class LoginResponse {
    private String token;           // JWT令牌
    private String refreshToken;    // 刷新令牌
    private Long expiresIn;         // 过期时间
    private UserInfo userInfo;      // 用户信息
}
```

### 3. 分页相关DTO

#### PageResult (分页结果)
```java
public class PageResult<T> {
    private List<T> records;        // 数据记录
    private Long total;             // 总记录数
    private Long size;              // 每页大小
    private Long current;           // 当前页码
    private Long pages;             // 总页数
}
```

## 🔒 安全考虑

### 数据安全
- **参数验证**: 所有输入参数进行严格验证
- **数据脱敏**: 敏感数据自动脱敏处理
- **权限控制**: 统一的权限验证机制
- **日志安全**: 敏感信息不记录到日志

### 接口安全
- **输入验证**: 所有输入进行验证和过滤
- **异常处理**: 统一的异常处理，避免信息泄露
- **访问控制**: 基于角色的访问控制
- **数据加密**: 敏感数据传输加密

## 📊 监控与日志

### 日志配置
- **日志框架**: Log4j2
- **日志级别**: INFO (生产环境)
- **日志格式**: 统一的日志格式
- **日志轮转**: 100MB/文件，保留30天

### 监控指标
- **接口调用次数**: 统计接口调用频率
- **异常统计**: 统计异常发生情况
- **响应时间**: 监控接口响应时间
- **错误率**: 监控错误率变化

## 🚀 部署说明

### 环境要求
- **JDK版本**: 21
- **内存要求**: 最小512MB，推荐1GB
- **依赖服务**: 无外部依赖

### 使用方式
```xml
<!-- 在其他微服务中引入依赖 -->
<dependency>
    <groupId>com.origin</groupId>
    <artifactId>service-common</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

### 配置说明
```yaml
# 日志配置
logging:
  config: classpath:log4j2.xml
  level:
    com.origin.common: info
```

## 📝 注意事项

### 使用规范
1. **统一响应**: 所有API必须使用ResultData包装响应
2. **异常处理**: 使用BusinessException处理业务异常
3. **错误码**: 使用ErrorCode枚举定义错误码
4. **日志记录**: 使用统一的日志格式记录

### 扩展性
1. **工具类扩展**: 新增工具类遵循现有规范
2. **枚举扩展**: 新增枚举遵循现有命名规范
3. **DTO扩展**: 新增DTO遵循现有结构规范
4. **异常扩展**: 新增异常继承BusinessException

### 维护性
1. **代码规范**: 遵循统一的代码规范
2. **文档同步**: 及时更新接口文档
3. **版本管理**: 合理的版本管理策略
4. **向后兼容**: 保持向后兼容性

## 🔄 版本历史

### v1.0.0 (2025-07-31)
- 初始版本发布
- 提供基础的工具类和组件
- 实现统一的响应格式和异常处理
- 提供用户认证相关的DTO
- 提供文件上传相关的DTO
- 提供分页相关的DTO

---

**文档版本**: v1.0  
**最后更新**: 2025-07-31  
**维护人员**: scccy 