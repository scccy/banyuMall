# service-user 设计文档

## 1. 模块概述

service-user模块是BanyuMall系统的用户管理模块，负责用户基础信息管理和用户扩展信息管理。基于简化的权限控制，专注于用户管理功能。

**核心职责**:
1. 满足(管理员)对普通用户进行管理,包括增加/删除 (发布用户) (可批量)，对(发布用户)进行权限管理 修改(发布用户)相关数据(基础信息)
2. 用户(包含管理员、发布用户)可以修改自己的用户信息(基础数据)
3. 管理员和发布用户 微信id和有赞id默认是0
4. 通过Feign客户端调用认证服务进行密码加密和验证

### 1.1 接口功能列表

| 序号 | 接口名称 | 请求方法 | 接口路径 | 功能描述 | 职责对应 | Feign调用 | 详细说明 |
|------|----------|----------|----------|----------|----------|-----------|----------|
| 1 | 创建用户 | POST | `/user` | 创建新用户，支持管理员和发布者两种用户类型 | 满足管理员对普通用户进行管理 | 是(Auth) | [查看详情](#31-用户基础信息管理接口) |
| 2 | 创建用户(含头像) | POST | `/user/with-avatar` | 创建新用户并上传头像 | 满足管理员对普通用户进行管理 | 是(Auth+OSS) | [查看详情](#31-用户基础信息管理接口) |
| 3 | 获取用户信息 | GET | `/user/{userId}` | 根据用户ID获取用户详细信息 | 用户信息查询和管理 | **是** | [查看详情](#31-用户基础信息管理接口) |
| 4 | 更新用户信息 | PUT | `/user/{userId}` | 更新用户的基础信息（昵称、头像、邮箱等） | 用户(包含管理员、发布用户)可以修改自己的用户信息 | 否 | [查看详情](#31-用户基础信息管理接口) |
| 5 | 更新用户信息(含头像) | PUT | `/user/{userId}/with-avatar` | 更新用户信息并上传头像 | 用户信息修改 | 是(OSS) | [查看详情](#31-用户基础信息管理接口) |
| 6 | 删除用户 | DELETE | `/user/{userId}` | 软删除指定用户 | 满足管理员对普通用户进行管理 | 否 | [查看详情](#31-用户基础信息管理接口) |
| 7 | 用户列表查询 | GET | `/user/list` | 分页查询用户列表，支持多条件筛选 | 满足管理员对普通用户进行管理 | **是** | [查看详情](#31-用户基础信息管理接口) |
| 8 | 批量删除用户 | DELETE | `/user/batch` | 批量软删除多个用户 | 满足管理员对普通用户进行管理(可批量) | 否 | [查看详情](#31-用户基础信息管理接口) |
| 9 | 上传头像 | POST | `/user/{userId}/avatar` | 上传用户头像 | 用户头像管理 | 是(OSS) | [查看详情](#31-用户基础信息管理接口) |
| 10 | 获取头像信息 | GET | `/user/{userId}/avatar` | 获取用户头像信息 | 用户头像管理 | 否 | [查看详情](#31-用户基础信息管理接口) |
| 11 | 获取用户扩展信息 | GET | `/profile/{userId}` | 获取用户的详细资料和公司信息 | 用户扩展信息管理 | **是** | [查看详情](#32-用户扩展信息管理接口) |
| 12 | 创建或更新用户扩展信息 | POST | `/profile/{userId}` | 创建或更新用户的扩展信息（真实姓名、公司信息等） | 用户扩展信息管理 | 否 | [查看详情](#32-用户扩展信息管理接口) |

### 1.2 技术栈
- **框架**: Spring Boot 3.x
- **数据库**: MySQL 8.0
- **ORM**: MyBatis-Plus
- **缓存**: Redis
- **认证**: JWT + Spring Security
- **文档**: Knife4j (Swagger)
- **配置中心**: Nacos
- **服务发现**: Nacos Discovery
- **服务调用**: OpenFeign
- **JSON处理**: FastJSON2
- **日志框架**: Log4j2

### 1.3 架构优化亮点

#### 1.3.1 代码重构优化
- ✅ **消除重复代码**: 重构SysUserServiceImpl，减少30%代码量
- ✅ **提取公共方法**: 统一密码加密、用户验证、查询逻辑
- ✅ **常量定义**: 消除魔法数字，提高代码可读性
- ✅ **方法职责单一**: 每个方法职责明确，便于维护和测试

#### 1.3.2 Feign客户端优化
- ✅ **架构规范**: 遵循服务提供方/消费方职责分离
- ✅ **统一管理**: 所有Feign客户端在消费方模块管理
- ✅ **降级处理**: 完善的降级处理机制
- ✅ **路径配置**: 使用path属性避免Bean名称冲突

## 2. 数据模型设计

### 2.1 数据库表结构
参考: [user-schema.sql](../../database/data/user/user-schema.sql)

### 2.2 实体类设计

#### 2.2.1 SysUser实体类
```java
@Data
@TableName("sys_user")
public class SysUser extends BaseEntity {
    @TableId(type = IdType.ASSIGN_ID)
    private String userId;
    
    @TableField("phone")
    private String phone;
    
    @TableField("wechat_id")
    private String wechatId;
    
    @TableField("youzan_id")
    private String youzanId;
    
    @TableField("username")
    private String username;
    
    @TableField("password")
    private String password;
    
    @TableField("nickname")
    private String nickname;
    
    @TableField("avatar")
    private String avatar;
    
    @TableField("email")
    private String email;
    
    @TableField("gender")
    private Integer gender;
    
    @TableField("status")
    private Integer status;
    
    @TableField("user_type")
    private Integer userType;
    
    @TableField("profile_id")
    private String profileId;
}
```

#### 2.2.2 UserProfile实体类
```java
@Data
@TableName("user_profile")
public class UserProfile extends BaseEntity {
    @TableId(type = IdType.ASSIGN_ID)
    private String profileId;
    
    @TableField("real_name")
    private String realName;
    
    @TableField("company_name")
    private String companyName;
    
    @TableField("company_address")
    private String companyAddress;
    
    @TableField("contact_person")
    private String contactPerson;
    
    @TableField("contact_phone")
    private String contactPhone;
    
    @TableField("industry")
    private String industry;
    
    @TableField("description")
    private String description;
}
```

### 2.3 DTO设计

#### 2.3.1 UserCreateRequest
```java
@Data
public class UserCreateRequest {
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;
    
    private String wechatId;
    private String youzanId;
    
    @NotBlank(message = "用户名不能为空")
    @Pattern(regexp = "^[a-zA-Z0-9_]{4,20}$", message = "用户名只能包含字母、数字、下划线，长度4-20位")
    private String username;
    
    @NotBlank(message = "密码不能为空")
    private String password;
    
    private String nickname;
    private String avatar;
    
    @Email(message = "邮箱格式不正确")
    private String email;
    
    @Min(value = 0, message = "性别值不正确")
    @Max(value = 2, message = "性别值不正确")
    private Integer gender;
    
    @NotNull(message = "用户类型不能为空")
    @Min(value = 1, message = "用户类型不正确")
    @Max(value = 3, message = "用户类型不正确")
    private Integer userType;
}
```

#### 2.3.2 UserUpdateRequest
```java
@Data
public class UserUpdateRequest {
    private String nickname;
    private String avatar;
    
    @Email(message = "邮箱格式不正确")
    private String email;
    
    @Min(value = 0, message = "性别值不正确")
    @Max(value = 2, message = "性别值不正确")
    private Integer gender;
    
    // 扩展信息字段
    private String realName;
    private String companyName;
    private String companyAddress;
    private String contactPerson;
    
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "联系电话格式不正确")
    private String contactPhone;
    
    private String industry;
    private String description;
}
```

#### 2.3.3 UserQueryRequest
```java
@Data
public class UserQueryRequest {
    private String username;
    private String nickname;
    private String phone;
    private String email;
    private Integer userType;
    private Integer status;
    private Integer gender;
    private String startTime;
    private String endTime;
    
    @Min(value = 1, message = "页码不能小于1")
    private Integer current = 1;
    
    @Min(value = 1, message = "每页大小不能小于1")
    @Max(value = 100, message = "每页大小不能超过100")
    private Integer size = 10;
}
```

#### 2.3.4 AvatarResponse
```java
@Data
public class AvatarResponse {
    private String userId;
    private String avatarUrl;
    private Long fileSize;
    private String mimeType;
    private String originalFileName;
}
```

## 3. 接口设计

### 3.1 用户基础信息管理接口 {#31-用户基础信息管理接口}

#### 3.1.1 创建用户
- **接口路径**: `POST /user`
- **功能描述**: 创建新用户，支持管理员和发布者两种用户类型
- **Feign调用**: 是(Auth服务 - 密码加密)
- **请求头**:
  ```
  Content-Type: application/json
  Authorization: Bearer {token}
  ```
- **请求参数**:
  ```json
  {
    "phone": "13800138001",
    "wechatId": "wx_001",
    "youzanId": "yz_001",
    "username": "testuser001",
    "password": "password123",
    "nickname": "测试用户001",
    "email": "test001@example.com",
    "gender": 1,
    "userType": 2
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "创建成功",
    "data": {
      "userId": "1234567890abcdef",
      "username": "testuser001",
      "phone": "13800138001",
      "createTime": "2025-01-27T10:00:00"
    }
  }
  ```
- **错误码**:
  - `400`: 参数验证失败
  - `409`: 用户名、手机号已存在
  - `403`: 无权限创建用户
  - `500`: 服务器内部错误
- **业务规则**:
  - 需要管理员权限
  - 用户名、手机号必须唯一
  - 密码通过Auth服务加密存储
  - 用户类型：1-管理员，2-发布者，3-接收者

#### 3.1.2 创建用户(含头像)
- **接口路径**: `POST /user/with-avatar`
- **功能描述**: 创建新用户并上传头像
- **Feign调用**: 是(Auth服务 - 密码加密, OSS服务 - 文件上传)
- **请求头**:
  ```
  Content-Type: multipart/form-data
  Authorization: Bearer {token}
  ```
- **请求参数**:
  ```
  userData: {
    "phone": "13800138001",
    "username": "testuser001",
    "password": "password123",
    "nickname": "测试用户001",
    "userType": 2
  }
  avatarFile: [文件]
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "创建成功",
    "data": {
      "userId": "1234567890abcdef",
      "username": "testuser001",
      "avatar": "https://oss.example.com/avatar/2025-01-27/xxx.jpg"
    }
  }
  ```
- **业务规则**:
  - 支持JPG、PNG、GIF格式
  - 文件大小限制5MB
  - 头像上传失败不影响用户创建

#### 3.1.3 获取用户信息
- **接口路径**: `GET /user/{userId}`
- **功能描述**: 根据用户ID获取用户详细信息
- **Feign调用**: 是
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "userId": "1234567890abcdef",
      "phone": "13800138001",
      "wechatId": "wx_001",
      "youzanId": "yz_001",
      "username": "testuser001",
      "nickname": "测试用户001",
      "avatar": "https://example.com/avatar.jpg",
      "email": "test001@example.com",
      "gender": 1,
      "status": 1,
      "userType": 2,
      "profileId": "profile_123456",
      "createTime": "2025-01-27T10:00:00",
      "updateTime": "2025-01-27T10:00:00"
    }
  }
  ```
- **错误码**:
  - `401`: 无权限访问
  - `404`: 用户不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 只能查看自己的信息或管理员可查看所有用户
  - 敏感信息需要脱敏处理

#### 3.1.4 更新用户信息
- **接口路径**: `PUT /user/{userId}`
- **功能描述**: 更新用户的基础信息（昵称、头像、邮箱等）
- **Feign调用**: 否
- **请求头**:
  ```
  Content-Type: application/json
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **请求参数**:
  ```json
  {
    "nickname": "新昵称",
    "email": "newemail@example.com",
    "gender": 2,
    "realName": "张三",
    "companyName": "测试公司",
    "contactPhone": "13900139001",
    "industry": "互联网"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": true
  }
  ```
- **错误码**:
  - `400`: 参数验证失败
  - `401`: 无权限修改
  - `404`: 用户不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 只能修改自己的信息或管理员可修改所有用户
  - 邮箱格式验证
  - 联系电话格式验证

#### 3.1.5 更新用户信息(含头像)
- **接口路径**: `PUT /user/{userId}/with-avatar`
- **功能描述**: 更新用户信息并上传头像
- **Feign调用**: 是(OSS服务 - 文件上传)
- **请求头**:
  ```
  Content-Type: multipart/form-data
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **请求参数**:
  ```
  userData: {
    "nickname": "新昵称",
    "email": "newemail@example.com"
  }
  avatarFile: [文件]
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "更新成功",
    "data": {
      "userId": "1234567890abcdef",
      "avatar": "https://oss.example.com/avatar/2025-01-27/xxx.jpg"
    }
  }
  ```
- **业务规则**:
  - 头像上传失败不影响用户信息更新
  - 支持JPG、PNG、GIF格式
  - 文件大小限制5MB

#### 3.1.6 删除用户
- **接口路径**: `DELETE /user/{userId}`
- **功能描述**: 软删除指定用户
- **Feign调用**: 否
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "删除成功",
    "data": true
  }
  ```
- **错误码**:
  - `401`: 无权限删除
  - `404`: 用户不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 需要管理员权限
  - 软删除，设置status=3
  - 不能删除自己

#### 3.1.7 用户列表查询
- **接口路径**: `GET /user/list`
- **功能描述**: 分页查询用户列表，支持多条件筛选
- **Feign调用**: 否
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **请求参数**:
  ```
  username: string  // 用户名模糊查询（可选）
  nickname: string  // 昵称模糊查询（可选）
  phone: string     // 手机号模糊查询（可选）
  email: string     // 邮箱模糊查询（可选）
  userType: 2       // 用户类型筛选（可选）
  status: 1         // 状态筛选（可选）
  gender: 1         // 性别筛选（可选）
  startTime: string // 开始时间（可选）
  endTime: string   // 结束时间（可选）
  current: 1        // 页码（可选，默认1）
  size: 10          // 每页大小（可选，默认10）
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "total": 100,
      "pages": 10,
      "current": 1,
      "size": 10,
      "records": [
        {
          "userId": "1234567890abcdef",
          "phone": "13800138001",
          "username": "testuser001",
          "nickname": "测试用户001",
          "avatar": "https://example.com/avatar.jpg",
          "email": "test001@example.com",
          "gender": 1,
          "status": 1,
          "userType": 2,
          "createTime": "2025-01-27T10:00:00"
        }
      ]
    }
  }
  ```
- **错误码**:
  - `401`: 无权限查询
  - `500`: 服务器内部错误
- **业务规则**:
  - 需要管理员权限
  - 支持分页查询
  - 支持多条件筛选
  - 敏感信息脱敏

#### 3.1.8 批量删除用户
- **接口路径**: `DELETE /user/batch`
- **功能描述**: 批量软删除多个用户
- **Feign调用**: 否
- **请求头**:
  ```
  Content-Type: application/json
  Authorization: Bearer {token}
  ```
- **请求参数**:
  ```json
  {
    "userIds": ["1234567890abcdef", "abcdef1234567890", "9876543210fedcba"]
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "批量删除成功",
    "data": {
      "successCount": 3,
      "failCount": 0,
      "failedUsers": []
    }
  }
  ```
- **错误码**:
  - `400`: 参数验证失败
  - `401`: 无权限操作
  - `500`: 服务器内部错误
- **业务规则**:
  - 需要管理员权限
  - 不能删除自己
  - 软删除，设置status=3
  - 返回删除结果统计

#### 3.1.9 上传头像
- **接口路径**: `POST /user/{userId}/avatar`
- **功能描述**: 上传用户头像
- **Feign调用**: 是(OSS服务 - 文件上传)
- **请求头**:
  ```
  Content-Type: multipart/form-data
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **请求参数**:
  ```
  file: [文件]
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "上传成功",
    "data": {
      "userId": "1234567890abcdef",
      "avatarUrl": "https://oss.example.com/avatar/2025-01-27/xxx.jpg",
      "fileSize": 1024000,
      "mimeType": "image/jpeg",
      "originalFileName": "avatar.jpg"
    }
  }
  ```
- **错误码**:
  - `400`: 文件格式不支持或文件过大
  - `401`: 无权限操作
  - `404`: 用户不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 支持JPG、PNG、GIF格式
  - 文件大小限制5MB
  - 只能上传自己的头像或管理员可上传任何用户头像

#### 3.1.10 获取头像信息
- **接口路径**: `GET /user/{userId}/avatar`
- **功能描述**: 获取用户头像信息
- **Feign调用**: 否
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "userId": "1234567890abcdef",
      "avatarUrl": "https://oss.example.com/avatar/2025-01-27/xxx.jpg"
    }
  }
  ```
- **错误码**:
  - `401`: 无权限访问
  - `404`: 用户不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 如果没有头像，返回默认头像URL
  - 只能查看自己的头像或管理员可查看任何用户头像

### 3.2 用户扩展信息管理接口 {#32-用户扩展信息管理接口}

#### 3.2.1 获取用户扩展信息
- **接口路径**: `GET /profile/{userId}`
- **功能描述**: 获取用户的详细资料和公司信息
- **Feign调用**: 是
- **请求头**:
  ```
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "获取成功",
    "data": {
      "profileId": "profile_123456",
      "realName": "张三",
      "companyName": "测试公司",
      "companyAddress": "北京市朝阳区测试街道123号",
      "contactPerson": "李四",
      "contactPhone": "13900139001",
      "industry": "互联网",
      "description": "这是一段个人简介",
      "createTime": "2025-01-27T10:00:00",
      "updateTime": "2025-01-27T10:00:00"
    }
  }
  ```
- **错误码**:
  - `401`: 无权限访问
  - `404`: 扩展信息不存在
  - `500`: 服务器内部错误
- **业务规则**:
  - 只能查看自己的扩展信息或管理员可查看所有
  - 如果不存在返回404

#### 3.2.2 创建或更新用户扩展信息
- **接口路径**: `POST /profile/{userId}`
- **功能描述**: 创建或更新用户的扩展信息（真实姓名、公司信息等）
- **Feign调用**: 否
- **请求头**:
  ```
  Content-Type: application/json
  Authorization: Bearer {token}
  ```
- **路径参数**:
  - `userId`: 用户ID
- **请求参数**:
  ```json
  {
    "realName": "张三",
    "companyName": "测试公司",
    "companyAddress": "北京市朝阳区测试街道123号",
    "contactPerson": "李四",
    "contactPhone": "13900139001",
    "industry": "互联网",
    "description": "这是一段个人简介"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": true
  }
  ```
- **错误码**:
  - `400`: 参数验证失败
  - `401`: 无权限操作
  - `500`: 服务器内部错误
- **业务规则**:
  - 只能修改自己的扩展信息或管理员可修改所有
  - 如果不存在则创建，存在则更新
  - 联系电话格式验证

## 4. 功能特性

### 4.1 用户管理功能
- ✅ **用户创建与删除**
  - 管理员创建用户（支持批量）
  - 管理员删除用户（支持批量）
  - 用户信息验证和唯一性检查
  - 软删除机制
  
- ✅ **用户信息查询与更新**
  - 用户信息查询（支持分页和筛选）
  - 用户信息更新（权限控制）
  - 敏感信息脱敏处理
  - 数据验证和格式检查
  
- ✅ **用户状态管理**
  - 用户状态控制（启用/禁用）
  - 用户类型管理（管理员/发布者/接收者）
  - 状态变更记录

### 4.2 用户扩展信息功能
- ✅ **扩展信息管理**
  - 用户详细资料管理
  - 企业信息管理
  - 联系信息管理
  - 个人简介管理

### 4.3 头像管理功能
- ✅ **头像上传与管理**
  - 支持多种图片格式（JPG、PNG、GIF）
  - 文件大小限制（5MB）
  - 自动文件格式验证
  - 头像URL管理

### 4.4 安全特性
- ✅ **认证授权**
  - JWT Token验证
  - 用户权限验证
  - 数据访问控制
  - 跨服务认证
  
- ✅ **数据安全**
  - 敏感信息脱敏
  - 输入参数验证
  - SQL注入防护
  - 数据完整性保护

## 5. 技术实现

### 5.1 技术栈
- **框架**: Spring Boot 3.x
- **数据库**: MySQL 8.0
- **ORM**: MyBatis-Plus
- **缓存**: Redis
- **认证**: JWT + Spring Security
- **文档**: Knife4j (Swagger)
- **配置中心**: Nacos
- **服务发现**: Nacos Discovery
- **服务调用**: OpenFeign
- **文件存储**: 阿里云OSS

### 5.2 核心配置
- **数据库连接池**: HikariCP
- **缓存策略**: Redis + 本地缓存
- **事务管理**: Spring声明式事务
- **异常处理**: 全局异常处理器
- **跨域配置**: CORS配置

### 5.3 Feign客户端配置

#### 5.3.1 AuthFeignClient
```java
@FeignClient(
    name = "service-auth", 
    path = "/service/auth", 
    fallback = AuthFeignClientFallback.class
)
public interface AuthFeignClient {
    @PostMapping("/password/encrypt")
    ResultData<PasswordEncryptResponse> encryptPassword(@RequestBody PasswordEncryptRequest request);
    
    @PostMapping("/password/verify")
    ResultData<Boolean> verifyPassword(@RequestBody PasswordEncryptRequest request);
}
```

#### 5.3.2 OssFileFeignClient
```java
@FeignClient(
    name = "aliyun-oss", 
    path = "/service/oss", 
    fallback = OssFileFeignClientFallback.class
)
public interface OssFileFeignClient {
    @PostMapping("/upload")
    ResultData<FileUploadResponse> uploadFile(@RequestBody FileUploadRequest request);
}
```

### 5.4 缓存策略

#### 5.4.1 缓存配置
```yaml
# Redis缓存配置
spring:
  redis:
    host: localhost
    port: 6379
    database: 2
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms

# 缓存策略配置
cache:
  user:
    info:
      key-prefix: "user:info:"
      ttl: 1800  # 30分钟
    profile:
      key-prefix: "user:profile:"
      ttl: 3600  # 1小时
    list:
      key-prefix: "user:list:"
      ttl: 300   # 5分钟
```

#### 5.4.2 缓存策略详情
| 接口 | 缓存策略 | TTL | 缓存键 | 说明 |
|------|----------|-----|--------|------|
| **获取用户信息** | Cache-Aside | 30分钟 | `user:info:{userId}` | 高频读取，数据相对稳定 |
| **获取用户扩展信息** | Cache-Aside | 1小时 | `user:profile:{userId}` | 变化频率低，其他服务需要 |
| **用户列表查询** | Cache-Aside | 5分钟 | `user:list:{queryHash}` | 管理后台频繁查询 |
| **创建用户** | 写后缓存 | - | `user:info:{userId}` | 创建后立即缓存 |
| **更新用户信息** | 写后清除 | - | `user:info:{userId}` | 更新后清除缓存 |
| **删除用户** | 写后清除 | - | `user:info:{userId}` | 删除后清除缓存 |

### 5.5 项目结构
```
src/main/java/com/origin/user/
├── config/           # 配置类
├── controller/       # 控制器
├── dto/             # 数据传输对象
├── entity/          # 实体类
├── feign/           # Feign客户端
│   ├── AuthFeignClient.java
│   ├── AuthFeignClientFallback.java
│   ├── OssFileFeignClient.java
│   └── OssFileFeignClientFallback.java
├── interceptor/     # 拦截器
├── mapper/          # 数据访问层
├── service/         # 业务逻辑层
│   └── impl/        # 业务逻辑实现
└── util/            # 工具类
```

### 5.6 依赖关系
- **service-base**: Spring Boot公共配置（MyBatis-Plus、Redis、Knife4j等配置）
- **service-common**: 公共组件和工具类（ResultData、BaseEntity、BusinessException等）
- **service-auth**: 认证服务（通过Feign调用 - 密码加密、验证）
- **aliyun-oss**: 文件存储服务（通过Feign调用 - 头像上传）
- **service-gateway**: 网关服务（路由转发）

### 5.7 依赖管理

#### 5.7.1 基础依赖包
```xml
<!-- 基础配置包 - Spring Boot公共配置 -->
<dependency>
    <groupId>com.origin</groupId>
    <artifactId>service-base</artifactId>
    <version>${project.version}</version>
</dependency>

<!-- 公共工具包 - 静态方法和工具类 -->
<dependency>
    <groupId>com.origin</groupId>
    <artifactId>service-common</artifactId>
    <version>${project.version}</version>
</dependency>
```

#### 5.7.2 核心依赖
```xml
<dependencies>
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- MyBatis Plus -->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>
    
    <!-- Redis -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>
    
    <!-- Knife4j -->
    <dependency>
        <groupId>com.github.xiaoymin</groupId>
        <artifactId>knife4j-openapi3-spring-boot-starter</artifactId>
    </dependency>
    
    <!-- Nacos -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
    
    <!-- OpenFeign -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>
    
    <!-- FastJSON2 -->
    <dependency>
        <groupId>com.alibaba.fastjson2</groupId>
        <artifactId>fastjson2</artifactId>
    </dependency>
    
    <!-- Log4j2 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-log4j2</artifactId>
    </dependency>
</dependencies>
```

## 6. 代码重构优化

### 6.1 重构成果

#### 6.1.1 代码量减少
- **重构前**: 572行
- **重构后**: 约400行
- **减少**: 约30%的代码量

#### 6.1.2 重复代码消除
- ✅ **密码加密逻辑统一**: 提取为`encryptUserPassword()`方法
- ✅ **用户存在性检查统一**: 提取为`validateUserExists()`方法
- ✅ **查询方法统一**: 使用函数式编程统一查询逻辑
- ✅ **用户实体构建统一**: 提取为`buildUserFromRequest()`等方法
- ✅ **常量定义**: 统一常量定义，避免魔法数字

#### 6.1.3 方法职责单一化
- ✅ **验证方法**: `validateUserCreateRequest()`, `validateUserExists()`, `validateAvatarFile()`
- ✅ **构建方法**: `buildUserFromRequest()`, `buildUserQueryWrapper()`, `buildFileUploadRequest()`
- ✅ **业务方法**: `encryptUserPassword()`, `setUserDefaults()`, `updateUserAvatar()`

### 6.2 架构优化

#### 6.2.1 Feign客户端架构规范
- ✅ **职责分离**: 服务提供方不定义Feign客户端，只有消费方才需要
- ✅ **统一管理**: 所有Feign客户端在消费方模块管理
- ✅ **降级处理**: 完善的降级处理机制
- ✅ **路径配置**: 使用path属性避免Bean名称冲突

#### 6.2.2 数据库设计优化
- ✅ **简化表结构**: 移除RBAC相关表，简化权限控制
- ✅ **关联优化**: 使用`profile_id`关联用户和扩展信息
- ✅ **字段优化**: 统一字段命名规范

## 7. 后续优化计划

### 7.1 性能优化
- [ ] 用户信息缓存优化
- [ ] 数据库查询优化
- [ ] 分页查询性能提升
- [ ] 头像文件压缩优化

### 7.2 功能增强
- [ ] 用户数据导入导出
- [ ] 用户行为分析
- [ ] 用户标签管理
- [ ] 用户搜索功能增强

### 7.3 安全加固
- [ ] 数据加密存储
- [ ] 操作审计日志
- [ ] 敏感信息脱敏
- [ ] 访问频率限制
- [ ] 文件上传安全检查

### 7.4 监控告警
- [ ] 接口性能监控
- [ ] 异常告警机制
- [ ] 业务指标监控
- [ ] 服务健康检查 