# service-user 模块设计文档

## 📋 模块概述

### 基本信息
- **模块名称**: service-user
- **模块类型**: 微服务模块
- **主要职责**: 用户信息管理、用户档案维护、头像管理、用户查询服务
- **技术栈**: Spring Boot + MyBatis Plus + Feign + Redis + OSS
- **作者**: scccy
- **创建时间**: 2025-01-27

### 设计理念
service-user模块作为用户信息管理中心，负责用户基础信息的增删改查、用户档案管理、头像上传等功能。模块采用微服务架构，通过Feign客户端与其他服务进行通信，支持分布式部署和水平扩展。

## 🏗️ 架构设计

### 核心架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │     Service     │    │     Mapper      │
│                 │    │                 │    │                 │
│ UserController  │───▶│  SysUserService │───▶│  SysUserMapper  │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Feign Client  │    │      Util       │    │    Database     │
│                 │    │                 │    │                 │
│ AuthFeignClient │    │  UserUtil       │    │    sys_user     │
│ OssFeignClient  │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 业务模型
```
用户管理流程:
1. 用户注册/创建
2. 用户信息维护
3. 头像上传管理
4. 用户查询服务

外部服务集成:
1. 认证服务集成 (service-auth)
2. 文件存储集成 (aliyun-oss)
3. 用户档案服务集成
```

## 📁 目录结构

```
service-user/
├── src/main/java/com/origin/user/
│   ├── controller/
│   │   └── UserController.java              # 用户管理控制器
│   ├── service/
│   │   ├── SysUserService.java              # 用户服务接口
│   │   ├── UserProfileService.java          # 用户档案服务接口
│   │   └── impl/
│   │       ├── SysUserServiceImpl.java      # 用户服务实现
│   │       └── UserProfileServiceImpl.java  # 用户档案服务实现
│   ├── entity/
│   │   └── SysUser.java                     # 用户实体类
│   ├── mapper/
│   │   └── SysUserMapper.java               # 用户数据访问层
│   ├── dto/
│   │   ├── UserCreateRequest.java           # 用户创建请求DTO
│   │   ├── UserUpdateRequest.java           # 用户更新请求DTO
│   │   ├── UserQueryRequest.java            # 用户查询请求DTO
│   │   └── AvatarResponse.java              # 头像响应DTO
│   ├── feign/
│   │   ├── AuthFeignClient.java             # 认证服务Feign客户端
│   │   ├── AuthFeignClientFallback.java     # 认证服务降级处理
│   │   ├── OssFileFeignClient.java          # OSS文件服务Feign客户端
│   │   ├── OssFileFeignClientFallback.java  # OSS文件服务降级处理
│   │   ├── UserFeignClient.java             # 用户服务Feign客户端
│   │   └── UserFeignClientFallback.java     # 用户服务降级处理
│   ├── exception/
│   │   └── UserExceptionHandler.java        # 用户异常处理
│   └── ServiceUserApplication.java          # 启动类
└── src/main/resources/
    ├── application.yml                      # 配置文件
    └── mapper/
        └── SysUserMapper.xml                # MyBatis映射文件
```

## 🔧 核心组件

### 1. 控制器 (UserController)

#### 主要接口
```java
@RestController
@RequestMapping("/service/user")
public class UserController {
    
    // 创建用户
    @PostMapping
    public ResultData<SysUser> createUser(@RequestPart("userInfo") @Valid UserCreateRequest request,
                                         @RequestPart(value = "avatarFile", required = false) MultipartFile avatarFile);
    
    // 获取用户信息
    @GetMapping("/{userId}")
    public ResultData<SysUser> getUserInfo(@PathVariable String userId);
    
    // 更新用户信息
    @PostMapping("/{userId}")
    public ResultData<SysUser> updateUser(@PathVariable String userId,
                                         @RequestPart("userInfo") @Valid UserUpdateRequest request,
                                         @RequestPart(value = "avatarFile", required = false) MultipartFile avatarFile);
    
    // 删除用户
    @PostMapping("/{userId}/delete")
    public ResultData<String> deleteUser(@PathVariable String userId);
    
    // 用户列表查询
    @GetMapping("/list")
    public ResultData<IPage<SysUser>> getUserList(@Valid UserQueryRequest request);
    
    // 批量删除用户
    @PostMapping("/batch/delete")
    public ResultData<String> batchDeleteUsers(@RequestBody List<String> userIds);
    
    // 获取用户头像信息
    @GetMapping("/{userId}/avatar")
    public ResultData<AvatarResponse> getAvatarInfo(@PathVariable String userId);
    
    // 健康检查
    @GetMapping("/test")
    public ResultData<String> test(HttpServletRequest httpRequest);
}
```

#### 接口说明
| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建用户 | POST | `/service/user` | 创建新用户，支持头像上传 |
| 获取用户信息 | GET | `/service/user/{userId}` | 根据用户ID获取用户详细信息 |
| 更新用户信息 | POST | `/service/user/{userId}` | 更新用户信息，支持头像更新 |
| 删除用户 | POST | `/service/user/{userId}/delete` | 软删除指定用户 |
| 用户列表查询 | GET | `/service/user/list` | 分页查询用户列表，支持多条件筛选 |
| 批量删除用户 | POST | `/service/user/batch/delete` | 批量软删除多个用户 |
| 获取用户头像信息 | GET | `/service/user/{userId}/avatar` | 获取用户的头像URL和相关信息 |
| 健康检查 | GET | `/service/user/test` | 服务健康检查接口 |

### 2. 服务层 (SysUserService)

#### 核心方法
```java
public interface SysUserService {
    
    // 创建用户（支持头像）
    SysUser createUserWithAvatar(UserCreateRequest request, MultipartFile avatarFile);
    
    // 根据ID获取用户
    SysUser getUserById(String userId);
    
    // 更新用户信息（支持头像）
    SysUser updateUserWithAvatar(String userId, UserUpdateRequest request, MultipartFile avatarFile);
    
    // 删除用户
    boolean deleteUser(String userId);
    
    // 分页查询用户
    IPage<SysUser> getUserPage(UserQueryRequest request);
    
    // 批量删除用户
    int batchDeleteUsers(List<String> userIds);
    
    // 获取头像信息
    AvatarResponse getAvatarInfo(String userId);
}
```

#### 业务逻辑
```java
// 创建用户业务逻辑
public SysUser createUserWithAvatar(UserCreateRequest request, MultipartFile avatarFile) {
    // 1. 验证用户信息
    // 2. 调用认证服务加密密码
    // 3. 上传头像到OSS（如果有）
    // 4. 保存用户信息到数据库
    // 5. 返回用户信息
}
```

### 3. Feign客户端列表

#### 依赖的外部服务
| 服务名称 | Feign客户端 | 主要用途 | 接口路径 |
|----------|-------------|----------|----------|
| service-auth | AuthFeignClient | 用户认证、密码加密验证、权限验证 | `/service/auth` |
| aliyun-oss | OssFileFeignClient | 文件上传、头像管理 | `/tp/oss` |
| service-user | UserFeignClient | 用户信息查询（内部调用） | `/service/user` |

#### Feign客户端接口
```java
@FeignClient(name = "service-auth", path = "/service/auth", fallback = AuthFeignClientFallback.class)
public interface AuthFeignClient {
    
    // 用户登录
    @PostMapping("/login")
    ResultData login(@RequestBody LoginRequest loginRequest);
    
    // 验证JWT令牌
    @PostMapping("/validate")
    ResultData<Boolean> validateToken(@RequestParam("token") String token);
    
    // 获取用户信息
    @GetMapping("/user/info")
    ResultData<SysUser> getUserInfo(@RequestParam("userId") String userId);
    
    // 密码加密
    @PostMapping("/password/encrypt")
    ResultData<PasswordEncryptResponse> encryptPassword(@RequestBody PasswordEncryptRequest request);
    
    // 密码验证
    @PostMapping("/password/verify")
    ResultData<Boolean> verifyPassword(@RequestBody PasswordEncryptRequest request);
}

@FeignClient(name = "aliyun-oss", path = "/tp/oss", fallback = OssFileFeignClientFallback.class)
public interface OssFileFeignClient {
    
    // 上传文件到OSS
    @PostMapping("/upload")
    ResultData<FileUploadResponse> uploadFile(@RequestBody FileUploadRequest request);
    
    // 获取文件访问URL
    @GetMapping("/url/{fileId}")
    ResultData<String> getFileUrl(@PathVariable("fileId") String fileId);
}
```

#### Feign降级处理
```java
@Component
public class AuthFeignClientFallback implements AuthFeignClient {
    
    @Override
    public ResultData login(LoginRequest loginRequest) {
        return ResultData.error(ErrorCode.SERVICE_UNAVAILABLE, "认证服务暂时不可用");
    }
    
    @Override
    public ResultData<Boolean> validateToken(String token) {
        return ResultData.error(ErrorCode.SERVICE_UNAVAILABLE, "认证服务暂时不可用");
    }
}

@Component
public class OssFileFeignClientFallback implements OssFileFeignClient {
    
    @Override
    public ResultData<FileUploadResponse> uploadFile(FileUploadRequest request) {
        return ResultData.error(ErrorCode.SERVICE_UNAVAILABLE, "文件服务暂时不可用");
    }
}
```

### 4. 工具类 (UserUtil)

#### 核心功能
```java
@Component
public class UserUtil {
    
    // 验证用户信息
    public void validateUserInfo(UserCreateRequest request);
    
    // 处理头像文件
    public String processAvatarFile(MultipartFile avatarFile);
    
    // 生成用户ID
    public String generateUserId();
    
    // 验证用户权限
    public boolean validateUserPermission(String userId, String operation);
}
```

## 🗄️ 数据模型

### 实体类 (SysUser)
```java
@Data
@TableName("sys_user")
public class SysUser extends BaseEntity {
    
    @TableId(value = "user_id", type = IdType.ASSIGN_ID)
    private String userId;                    // 用户ID
    
    private String username;                  // 用户名
    private String password;                  // 密码（加密）
    private String nickname;                  // 昵称
    private String email;                     // 邮箱
    private String phone;                     // 手机号
    private String avatar;                    // 头像URL
    private Integer userType;                 // 用户类型
    private Integer status;                   // 用户状态
    private LocalDateTime lastLoginTime;      // 最后登录时间
    private String lastLoginIp;               // 最后登录IP
}
```

### DTO设计

#### 请求DTO (UserCreateRequest)
```java
@Data
public class UserCreateRequest {
    private String username;                  // 用户名
    private String password;                  // 密码
    private String nickname;                  // 昵称
    private String email;                     // 邮箱
    private String phone;                     // 手机号
    private Integer userType;                 // 用户类型
}
```

#### 请求DTO (UserUpdateRequest)
```java
@Data
public class UserUpdateRequest {
    private String nickname;                  // 昵称
    private String email;                     // 邮箱
    private String phone;                     // 手机号
}
```

#### 请求DTO (UserQueryRequest)
```java
@Data
public class UserQueryRequest {
    private Integer current = 1;              // 当前页码
    private Integer size = 10;                // 每页大小
    private String keyword;                   // 关键词
    private Integer userType;                 // 用户类型
    private Integer status;                   // 用户状态
    private String sortField;                 // 排序字段
    private String sortOrder = "desc";        // 排序方向
}
```

#### 响应DTO (AvatarResponse)
```java
@Data
public class AvatarResponse {
    private String userId;                    // 用户ID
    private String avatarUrl;                 // 头像URL
    private String avatarThumbnail;           // 头像缩略图URL
    private Long fileSize;                    // 文件大小
    private String fileType;                  // 文件类型
    private LocalDateTime uploadTime;         // 上传时间
}
```

## 🔐 安全设计

### 1. 认证授权
- **JWT验证**: 通过Feign客户端调用认证服务验证用户身份
- **权限控制**: 基于用户类型和状态进行权限控制
- **数据隔离**: 用户只能访问自己的信息，管理员可以访问所有用户信息
- **操作审计**: 记录所有用户操作的审计日志

### 2. 数据安全
- **密码安全**: 密码通过认证服务加密存储
- **输入验证**: 所有输入参数进行验证和过滤
- **SQL注入防护**: 使用MyBatis Plus参数化查询
- **敏感数据处理**: 密码等敏感信息不返回给前端

### 3. 接口安全
- **接口限流**: 对高频接口进行限流保护
- **异常处理**: 统一的异常处理机制
- **日志记录**: 关键操作的日志记录
- **链路追踪**: 支持请求链路追踪

## ⚙️ 配置管理

### 应用配置
```yaml
spring:
  application:
    name: service-user
  datasource:
    url: jdbc:mysql://localhost:3306/banyu
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:root}
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: ${REDIS_DATABASE:0}

# Feign配置
feign:
  client:
    config:
      service-auth:
        connect-timeout: 5000
        read-timeout: 10000
      aliyun-oss:
        connect-timeout: 10000
        read-timeout: 30000

# 文件上传配置
file:
  upload:
    max-size: 10MB
    allowed-types: jpg,jpeg,png,gif
    avatar-path: /avatars/
```

### 环境配置
- **开发环境**: `application-dev.yml`
- **测试环境**: `application-test.yml`
- **生产环境**: `application-prod.yml`

## 🔄 业务流程

### 1. 用户创建流程
```
1. 接收用户创建请求
   ↓
2. 验证用户信息
   ↓
3. 调用认证服务加密密码
   ↓
4. 上传头像到OSS（如果有）
   ↓
5. 保存用户信息到数据库
   ↓
6. 返回用户信息
```

### 2. 用户信息更新流程
```
1. 接收用户更新请求
   ↓
2. 验证用户权限
   ↓
3. 更新头像（如果有）
   ↓
4. 更新用户信息
   ↓
5. 记录操作日志
   ↓
6. 返回更新结果
```

### 3. 用户查询流程
```
1. 接收查询请求
   ↓
2. 验证查询权限
   ↓
3. 构建查询条件
   ↓
4. 执行分页查询
   ↓
5. 处理查询结果
   ↓
6. 返回查询结果
```

## 🚨 异常处理与错误码

### 1. 异常处理机制
- **统一异常处理**: 使用`UserExceptionHandler`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 使用`GlobalExceptionHandler`处理系统异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 2. 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 409 | 状态冲突 | 资源状态不允许操作 |
| 500 | 系统错误 | 系统内部错误 |

#### 用户管理相关错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 1001 | 用户不存在 | 指定的用户不存在 |
| 1002 | 用户已存在 | 用户名或手机号已存在 |
| 1003 | 密码错误 | 用户密码错误 |
| 1004 | 账号已被禁用 | 用户账号已被禁用 |
| 1005 | 令牌已过期 | JWT令牌已过期 |
| 1006 | 令牌无效 | JWT令牌无效 |
| 1007 | 用户档案不存在 | 用户档案信息不存在 |
| 1008 | 用户头像上传失败 | 用户头像上传操作失败 |
| 1009 | 用户权限不足 | 用户权限不足以执行操作 |

#### 文件相关错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 4109 | OSS文件上传失败 | OSS文件上传操作失败 |
| 4110 | OSS文件不存在 | OSS指定的文件不存在 |
| 4111 | OSS文件大小超限 | OSS文件大小超过限制 |
| 4112 | OSS文件类型不允许 | OSS不支持的文件类型 |

### 3. 异常处理流程
```
1. 异常发生
   ↓
2. 异常拦截器捕获
   ↓
3. 异常分类处理
   ↓
4. 错误码映射
   ↓
5. 错误信息格式化
   ↓
6. 返回统一错误响应
```

## 📊 性能优化

### 1. 缓存策略
- **Redis缓存**: 用户信息缓存，减少数据库查询
- **头像缓存**: 头像URL缓存，提高访问速度
- **查询缓存**: 用户列表查询结果缓存
- **缓存过期**: 合理的缓存过期时间设置

### 2. 数据库优化
- **索引优化**: 用户名、邮箱、手机号等字段创建索引
- **查询优化**: 使用MyBatis Plus优化查询
- **连接池**: 配置合适的数据库连接池
- **分页查询**: 用户列表使用分页查询

### 3. 接口优化
- **异步处理**: 头像上传使用异步处理
- **批量操作**: 批量删除用户操作
- **限流保护**: 高频接口限流保护
- **响应优化**: 合理设置响应数据大小

## 🧪 测试策略

### 1. 单元测试
- **Service层测试**: 测试用户业务逻辑
- **Feign客户端测试**: 测试外部服务调用
- **Mapper层测试**: 测试数据访问层

### 2. 集成测试
- **API测试**: 测试REST接口功能
- **数据库测试**: 测试数据库操作
- **Feign测试**: 测试外部服务集成

### 3. 性能测试
- **并发测试**: 测试并发用户操作性能
- **压力测试**: 测试系统承载能力
- **稳定性测试**: 测试长期运行稳定性

## 📈 监控指标

### 1. 业务指标
- **用户创建成功率**: 用户创建成功次数/总创建次数
- **用户查询响应时间**: 用户查询接口平均响应时间
- **头像上传成功率**: 头像上传成功次数/总上传次数
- **活跃用户数**: 当前活跃用户数量

### 2. 技术指标
- **接口响应时间**: 各接口平均响应时间
- **错误率**: 接口错误率统计
- **缓存命中率**: Redis缓存命中率
- **数据库连接数**: 数据库连接池使用情况

### 3. 外部服务指标
- **认证服务调用成功率**: Auth服务调用成功次数/总调用次数
- **OSS服务响应时间**: 文件上传的平均响应时间
- **Feign降级次数**: 外部服务不可用时的降级处理次数

## 🔮 扩展规划

### 1. 功能扩展
- **用户档案管理**: 扩展用户档案信息
- **用户标签系统**: 支持用户标签管理
- **用户分组管理**: 支持用户分组功能
- **用户行为分析**: 用户行为数据收集和分析

### 2. 性能优化
- **分布式缓存**: 使用Redis集群
- **数据库分库分表**: 支持大规模用户
- **CDN加速**: 头像文件CDN加速
- **异步处理**: 更多异步处理场景

### 3. 架构升级
- **服务网格**: 集成Istio服务网格
- **容器化部署**: 支持Kubernetes部署
- **监控告警**: 完善监控告警体系
- **自动化运维**: 实现自动化运维

---

**文档版本**: v1.0  
**创建时间**: 2025-01-27  
**维护人员**: scccy 