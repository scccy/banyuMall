# Core Publisher 模块设计文档

## 📋 模块概述

**模块名称**: core-publisher  
**模块类型**: 核心业务服务  
**技术栈**: Spring Boot + MyBatis Plus + OpenFeign + Nacos  
**作者**: scccy  
**创建时间**: 2025-07-31  

### 模块职责
- **任务管理**: 提供任务的创建、更新、查询、删除等核心功能
- **任务完成管理**: 处理任务完成提交、审核、状态检查等流程
- **社群分享审核**: 管理社群分享内容的审核流程
- **文件管理**: 集成OSS文件服务，处理任务相关文件上传
- **企业微信集成**: 与企业微信系统集成，处理任务完成状态回调

## 🏗️ 架构设计

### 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   网关服务       │───▶│  Core Publisher  │───▶│   第三方服务     │
│                │    │                │    │                │
│ - 路由转发      │    │ - 任务管理      │    │ - OSS文件服务   │
│ - 链路追踪      │    │ - 完成管理      │    │ - 企业微信      │
└─────────────────┘    │ - 分享审核      │    └─────────────────┘
                       │ - 文件集成      │
                       └─────────────────┘
                               │
                               ▼
                       ┌─────────────────┐
                       │   数据库        │
                       │                │
                       │ - publisher_task│
                       │ - publisher_share_review│
                       │ - publisher_task_completion│
                       └─────────────────┘
```

### 核心组件
1. **CorePublisherApplication**: 核心发布者服务启动类
2. **PublisherTaskController**: 任务管理控制器
3. **TaskCompletionController**: 任务完成管理控制器
4. **PublisherShareReviewController**: 社群分享审核控制器
5. **OssFileFeignClient**: OSS文件服务Feign客户端

## 🔧 核心功能

### 1. 任务管理
- **任务创建**: 创建新任务，支持多种任务类型
- **任务更新**: 更新任务信息和配置
- **任务查询**: 获取任务详情和列表
- **任务删除**: 删除任务
- **任务状态管理**: 更新任务状态（草稿、上架、下架等）
- **任务发布**: 发布和下架任务

### 2. 任务完成管理
- **完成提交**: 用户提交任务完成申请
- **完成审核**: 审核任务完成申请
- **完成查询**: 获取任务完成记录列表
- **状态检查**: 检查用户任务完成状态
- **企业微信回调**: 处理企业微信任务完成状态回调

### 3. 社群分享审核
- **审核提交**: 提交社群分享审核申请
- **审核处理**: 审核分享内容
- **审核查询**: 获取分享审核列表

### 4. 文件管理
- **文件上传**: 上传任务相关文件到OSS
- **文件访问**: 获取文件访问URL

## 📊 数据模型

### 1. PublisherTask (任务主表)
```java
public class PublisherTask extends BaseEntity {
    private String taskId;                    // 任务ID
    private String taskName;                  // 任务名称
    private Integer taskTypeId;               // 任务类型ID
    private String taskDescription;           // 任务描述
    private BigDecimal taskReward;            // 任务积分
    private String taskIconUrl;               // 任务图标URL
    private String detailId;                  // 详情配置ID
    private Integer statusId;                 // 任务状态ID
}
```

### 2. PublisherTaskDetail (任务详情表)
```java
public class PublisherTaskDetail extends BaseEntity {
    private String detailId;                  // 详情ID
    private String taskId;                    // 任务ID
    private String taskConfig;                // 任务配置JSON
}
```

### 任务配置示例 (taskConfig)

#### 1. 点赞任务 (taskTypeId: 1)
```json
{
  "targetUrl": "http://example.com/post/123",
  "targetType": "like",
  "minDuration": 30
}
```

#### 2. 评论任务 (taskTypeId: 2)
```json
{
  "targetUrl": "http://example.com/post/123",
  "targetType": "comment",
  "minCommentLength": 10,
  "requireScreenshot": true
}
```

#### 3. 社群讨论任务 (taskTypeId: 3)
```json
{
  "targetUrl": "http://example.com/forum/topic/456",
  "targetType": "discussion",
  "minContentLength": 50,
  "requireScreenshot": true
}
```

#### 4. 社群分享任务 (taskTypeId: 4)
```json
{
  "taskDescription": "分享到朋友圈或微信群",
  "requireImage": true,
  "minImageCount": 1,
  "requireLink": true,
  "linkUrl": "http://example.com/share/789",
  "sharePlatforms": ["wechat", "weibo", "qq"]
}
```

#### 5. 邀请好友任务 (taskTypeId: 5)
```json
{
  "inviteType": "group", // group: 入群, wechat: 加微信
  "rewardInvitee": true,
  "inviteeReward": 50.00,
  "activityRules": "邀请好友入群，双方均可获得积分奖励",
  "qrCodeUrl": "http://example.com/qr/group123.png"
}
```

#### 6. 反馈任务 (taskTypeId: 6)
```json
{
  "taskImage": "http://example.com/feedback/icon.png",
  "feedbackUrl": "http://example.com/feedback/form",
  "requireScreenshot": true
}
```

#### 7. 排行榜任务 (taskTypeId: 7)
```json
{
  "topCount": 10,
  "rankingType": "points", // points: 积分排行, completion: 完成数排行
  "displayPeriod": "weekly" // daily, weekly, monthly
}
```

### 3. PublisherTaskCompletion (任务完成表)
```java
public class PublisherTaskCompletion extends BaseEntity {
    private String completionId;              // 完成记录ID
    private String taskId;                    // 任务ID
    private String userId;                    // 用户ID
    private Integer completionStatus;         // 完成状态
    private String completionContent;         // 完成内容
    private String reviewComment;             // 审核意见
    private Integer reviewStatus;             // 审核状态
}
```

### 4. PublisherShareReview (分享审核表)
```java
public class PublisherShareReview extends BaseEntity {
    private String shareReviewId;             // 分享审核ID
    private String userId;                    // 用户ID
    private String shareContent;              // 分享内容
    private String shareImages;               // 分享图片
    private Integer reviewStatus;             // 审核状态
    private String reviewComment;             // 审核意见
    private String reviewerId;                // 审核人ID
}
```

## 🔗 Feign客户端接口

### OssFileFeignClient
| 方法名 | 请求路径 | 请求方法 | 功能描述 |
|--------|----------|----------|----------|
| uploadFile | /tp/oss/upload | POST | 上传文件到OSS |
| getFileUrl | /tp/oss/url/{fileId} | GET | 获取文件访问URL |

## ⚙️ 配置说明

### 应用配置
```yaml
# 应用名称
spring:
  application:
    name: core-publisher
  
  # 数据源配置
  datasource:
    url: jdbc:mysql://localhost:3306/publisher
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver

# MyBatis Plus配置
mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.origin.publisher.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# Feign配置
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000
```

### Nacos配置
- **服务发现**: 自动注册到Nacos注册中心
- **配置中心**: 从Nacos加载动态配置
- **负载均衡**: 使用Spring Cloud LoadBalancer

## 🔄 业务流程

### 1. 任务创建流程
```
1. 接收任务创建请求
   ↓
2. 验证请求参数
   ↓
3. 创建任务记录
   ↓
4. 创建任务详情记录
   ↓
5. 返回任务ID
```

### 2. 任务完成流程
```
1. 用户提交任务完成申请
   ↓
2. 验证任务状态和用户权限
   ↓
3. 创建完成记录
   ↓
4. 更新任务统计信息
   ↓
5. 触发审核流程
```

### 3. 分享审核流程
```
1. 用户提交分享审核申请
   ↓
2. 验证分享内容
   ↓
3. 创建审核记录
   ↓
4. 管理员审核
   ↓
5. 更新审核状态
```

## 🚨 异常处理与错误码

### 1. 异常处理机制
- **统一异常处理**: 使用`PublisherExceptionHandler`统一处理异常
- **业务异常**: 使用`BusinessException`处理业务逻辑异常
- **系统异常**: 使用`GlobalExceptionHandler`处理系统异常
- **参数验证**: 使用`@Valid`和`@Validated`进行参数验证

### 2. 错误码定义

#### 基础错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 400 | 参数错误 | 请求参数不正确 |
| 401 | 未授权 | 用户未登录或认证失败 |
| 403 | 禁止访问 | 用户权限不足 |
| 404 | 资源不存在 | 请求的资源不存在 |
| 409 | 状态冲突 | 资源状态不允许操作 |
| 500 | 系统错误 | 系统内部错误 |

#### 核心服务通用错误码
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 2000 | 核心服务错误 | 核心服务通用错误 |
| 2001 | 核心服务不可用 | 核心服务不可用 |
| 2002 | 核心服务超时 | 核心服务超时 |
| 2003 | 核心服务配置错误 | 核心服务配置错误 |

#### 发布者服务错误码 (21xx)
| 错误码 | 错误类型 | 错误描述 |
|--------|----------|----------|
| 2101 | 任务不存在 | 指定的任务不存在 |
| 2102 | 任务已完成 | 任务已经完成，不能重复操作 |
| 2103 | 任务已过期 | 任务已过期，无法操作 |
| 2104 | 任务状态无效 | 任务状态不允许当前操作 |
| 2105 | 任务审核记录不存在 | 指定的审核记录不存在 |
| 2106 | 任务审核状态无效 | 审核状态不允许当前操作 |
| 2107 | 任务完成记录不存在 | 指定的完成记录不存在 |
| 2108 | 任务配置错误 | 任务配置格式或内容错误 |
| 2109 | 任务验证失败 | 任务参数验证失败 |
| 2110 | 任务发布失败 | 任务发布操作失败 |
| 2111 | 任务下架失败 | 任务下架操作失败 |
| 2112 | 任务删除失败 | 任务删除操作失败 |
| 2113 | 任务重复提交 | 任务重复提交，不允许 |

### 3. 异常处理流程
```
1. 异常发生
   ↓
2. 异常拦截器捕获
   ↓
3. 异常分类处理
   ↓
4. 错误码映射
   ↓
5. 错误信息格式化
   ↓
6. 返回统一错误响应
```

## 📊 监控与日志

### 日志配置
- **日志框架**: Log4j2
- **日志级别**: INFO (生产环境)
- **日志文件**: logs/core-publisher.log
- **日志轮转**: 100MB/文件，保留30天

### 监控指标
- **任务创建成功率**: 任务创建成功次数/总请求次数
- **任务完成率**: 任务完成次数/任务总数
- **审核处理时间**: 审核处理平均时间
- **文件上传成功率**: 文件上传成功次数/总上传次数

## 🔒 安全考虑

### 数据安全
- **参数验证**: 所有输入参数进行严格验证
- **SQL注入防护**: 使用MyBatis Plus防止SQL注入
- **敏感信息保护**: 不在日志中记录敏感信息

### 接口安全
- **权限控制**: 基于用户角色的权限控制
- **请求限流**: 防止恶意请求攻击
- **数据脱敏**: 敏感数据脱敏处理

## 🚀 部署说明

### 环境要求
- **JDK版本**: 21
- **内存要求**: 最小1GB，推荐2GB
- **端口**: 8083

### 启动命令
```bash
# 开发环境
java -jar core-publisher.jar --spring.profiles.active=dev

# 生产环境
java -jar core-publisher.jar --spring.profiles.active=prod
```

### 依赖服务
- **MySQL数据库**: 存储任务和审核数据
- **Nacos注册中心**: 服务注册与发现
- **OSS文件服务**: 文件存储服务
- **企业微信**: 任务完成状态回调

## 📝 注意事项

### 性能优化
1. **数据库优化**: 合理设计索引，优化查询语句
2. **缓存策略**: 对热点数据进行缓存
3. **异步处理**: 非关键流程使用异步处理

### 扩展性
1. **任务类型扩展**: 支持新增任务类型
2. **审核流程扩展**: 支持自定义审核流程
3. **第三方集成**: 支持更多第三方服务集成

### 维护性
1. **代码规范**: 遵循统一的代码规范
2. **文档同步**: 及时更新接口文档
3. **版本管理**: 合理的版本管理策略

---

**文档版本**: v1.0  
**最后更新**: 2025-07-31  
**维护人员**: scccy 