# 发布者模块数据库重新设计说明

> **文档位置**: `zinfra/moudleDocs/core-publisher/数据库重新设计说明.md`
> **创建时间**: 2025-01-27
> **作者**: scccy

## 1. 重新设计背景

### 1.1 原有设计问题
1. **过度分表**: 每个任务类型都单独建表，导致表数量过多（10张表）
2. **命名不规范**: 主键使用 `id` 而不是 `{表名}_id`
3. **外键约束**: 使用外键约束影响性能
4. **类型存储**: 任务类型使用VARCHAR存储，查询效率低
5. **更新逻辑问题**: 逻辑删除 + 唯一键约束导致更新操作失败

### 1.2 重新设计目标
1. **简化表结构**: 从10张表减少到4张表
2. **规范命名**: 遵循MySQL数据开发规范
3. **提高性能**: 使用INT存储枚举值，不使用外键约束
4. **解决更新问题**: 使用JSON存储任务详情，避免逻辑删除冲突

## 2. 新设计架构

### 2.1 表结构概览

| 表名 | 用途 | 主要字段 |
|------|------|----------|
| `publisher_task` | 任务主表 | `task_id`, `task_name`, `task_type_id`, `status_id` |
| `publisher_task_detail` | 任务详情表 | `detail_id`, `task_id`, `task_config` (JSON) |
| `publisher_share_review` | 社群分享审核 | `share_review_id`, `task_id`, `share_content` |
| `publisher_task_completion` | 任务完成流水表 | `completion_id`, `task_id`, `user_id`, `completion_evidence` (JSON，仅社群分享任务需要) |

### 2.2 设计优势

1. **表数量减少**: 从10张表减少到4张表，降低维护复杂度
2. **命名规范**: 所有主键使用 `{表名}_id` 格式
3. **性能优化**: 使用INT存储枚举值，提高查询效率
4. **灵活性**: JSON存储任务详情，支持不同类型任务的扩展
5. **无外键约束**: 应用层控制数据完整性，提高性能
6. **智能判断**: 除社群分享任务外，其他任务通过企业微信API自动判断完成状态

## 3. 核心表设计详解

### 3.1 任务主表 (`publisher_task`)

**设计思路**: 存储任务的基础信息，使用INT类型存储任务类型和状态

```sql
CREATE TABLE `publisher_task` (
    `task_id` VARCHAR(32) NOT NULL COMMENT '任务ID',                    -- SQL字段名
    `task_name` VARCHAR(100) NOT NULL COMMENT '任务名称',                -- SQL字段名
    `task_type_id` INT NOT NULL COMMENT '任务类型ID：1-点赞，2-评论，3-讨论，4-分享，5-邀请，6-反馈，7-排行榜',  -- SQL字段名
    `task_description` TEXT COMMENT '任务描述',                          -- SQL字段名
    `task_reward` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '任务积分', -- SQL字段名
    `task_icon_url` VARCHAR(500) DEFAULT NULL COMMENT '任务图标URL',      -- SQL字段名
    `detail_id` VARCHAR(32) DEFAULT NULL COMMENT '详情配置ID',           -- SQL字段名
    `status_id` INT NOT NULL DEFAULT 1 COMMENT '任务状态ID：1-草稿，2-上架，3-下架，4-审核通过，5-审核不通过',  -- SQL字段名
    -- 通用字段
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,          -- SQL字段名
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,  -- SQL字段名
    `created_by` VARCHAR(32) DEFAULT NULL,                              -- SQL字段名
    `updated_by` VARCHAR(32) DEFAULT NULL,                              -- SQL字段名
    `deleted` TINYINT(1) NOT NULL DEFAULT 0,                            -- SQL字段名
    PRIMARY KEY (`task_id`)
);
```

### 3.2 任务详情表 (`publisher_task_detail`)

**设计思路**: 使用JSON字段存储不同类型任务的配置信息

```sql
CREATE TABLE `publisher_task_detail` (
    `detail_id` VARCHAR(32) NOT NULL COMMENT '详情ID',                   -- SQL字段名
    `task_id` VARCHAR(32) NOT NULL COMMENT '任务ID',                     -- SQL字段名
    `task_config` JSON NOT NULL COMMENT '任务配置JSON',                  -- SQL字段名
    -- 通用字段
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,          -- SQL字段名
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,  -- SQL字段名
    `created_by` VARCHAR(32) DEFAULT NULL,                              -- SQL字段名
    `updated_by` VARCHAR(32) DEFAULT NULL,                              -- SQL字段名
    `deleted` TINYINT(1) NOT NULL DEFAULT 0,                            -- SQL字段名
    PRIMARY KEY (`detail_id`),
    UNIQUE KEY `uk_task_id` (`task_id`)
);
```

**JSON配置示例**:
```json
// 点赞任务配置 - 无特定字段，使用主表字段即可
{}

// 评论任务配置 - 无特定字段，使用主表字段即可
{}

// 社群讨论任务配置 - 无特定字段，使用主表字段即可
{}

// 社群分享任务配置
{
  "taskInstruction": "请分享指定内容到您的社群",  // JSON字段名
  "imageRequired": true,                        // JSON字段名
  "minImageCount": 1,                           // JSON字段名
  "linkRequired": false,                        // JSON字段名
  "linkUrl": "https://example.com/target-content"  // JSON字段名
}

// 邀请好友任务配置 - 邀请加好友
{
  "inviteType": "friend",                       // JSON字段名：邀请类型(friend-加好友, group-入群)
  "inviteeReward": true,                        // JSON字段名：被邀请人是否加分
  "inviteeRewardAmount": 5.00,                  // JSON字段名：被邀请人添加积分
  "activityRules": "邀请好友加入可获得额外奖励",    // JSON字段名：活动规则
  "taskQrCodeUrl": "https://example.com/qr-code.jpg"  // JSON字段名：任务展示二维码
}

// 邀请好友任务配置 - 邀请入群
{
  "inviteType": "group",                        // JSON字段名：邀请类型(friend-加好友, group-入群)
  "inviteeReward": true,                        // JSON字段名：被邀请人是否加分
  "inviteeRewardAmount": 5.00,                  // JSON字段名：被邀请人添加积分
  "activityRules": "邀请好友入群可获得额外奖励",      // JSON字段名：活动规则
  "taskQrCodeUrl": "https://example.com/qr-code.jpg"  // JSON字段名：任务展示二维码
}

// 反馈任务配置
{
  "taskImageUrl": "https://example.com/feedback-image.jpg",  // JSON字段名：任务图片URL
  "feedbackJumpUrl": "https://example.com/feedback-jump"     // JSON字段名：反馈跳转链接
}

// 排行榜任务配置
{
  "topRanking": 10  // JSON字段名：展示排行榜前x名
}
```

### 3.4 任务完成流水表 (`publisher_task_completion`)

**设计思路**: 记录用户任务完成情况，支持两种完成判断方式

```sql
CREATE TABLE `publisher_task_completion` (
    `completion_id` VARCHAR(32) NOT NULL COMMENT '完成记录ID',
    `task_id` VARCHAR(32) NOT NULL COMMENT '任务ID',
    `user_id` VARCHAR(32) NOT NULL COMMENT '完成用户ID',
    `completion_status` INT NOT NULL DEFAULT 1 COMMENT '完成状态：1-进行中，2-已完成，3-已拒绝',
    `completion_time` DATETIME COMMENT '完成时间',
    `reward_amount` DECIMAL(10,2) NOT NULL DEFAULT 0.00 COMMENT '获得奖励金额',
    `completion_evidence` JSON COMMENT '完成证据（仅社群分享任务需要，其他任务通过企业微信API自动判断）',
    -- 通用字段
    `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` VARCHAR(32) DEFAULT NULL,
    `updated_by` VARCHAR(32) DEFAULT NULL,
    `deleted` TINYINT(1) NOT NULL DEFAULT 0,
    PRIMARY KEY (`completion_id`),
    KEY `idx_task_id` (`task_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_completion_status` (`completion_status`),
    KEY `idx_completion_time` (`completion_time`),
    KEY `idx_task_user` (`task_id`, `user_id`),
    KEY `idx_user_status` (`user_id`, `completion_status`)
);
```

**完成判断逻辑**:
1. **社群分享任务** (task_type_id: 4): 需要用户上传截图等证据，人工审核
2. **其他任务** (task_type_id: 1,2,3,5,6,7): 通过企业微信API接口自动查询完成情况，无需证据

## 4. 数据迁移方案

### 4.1 迁移步骤

1. **创建新表结构**: 执行新的建表脚本
2. **数据迁移**: 将旧表数据迁移到新表结构
3. **应用层适配**: 修改应用代码适配新的表结构
4. **测试验证**: 验证数据迁移的正确性
5. **切换上线**: 切换到新的表结构

### 4.2 迁移脚本示例

```sql
-- 迁移任务主表数据
INSERT INTO publisher_task (
    task_id, task_name, 
    CASE task_type 
        WHEN 'LIKE' THEN 1
        WHEN 'COMMENT' THEN 2
        WHEN 'DISCUSS' THEN 3
        WHEN 'SHARE' THEN 4
        WHEN 'INVITE' THEN 5
        WHEN 'FEEDBACK' THEN 6
        WHEN 'RANKING' THEN 7
    END as task_type_id,
    task_description, reward_amount, publisher_id,
    CASE status
        WHEN 'DRAFT' THEN 1
        WHEN 'SUBMITTED' THEN 2
        WHEN 'REVIEWING' THEN 3
        WHEN 'APPROVED' THEN 4
        WHEN 'REJECTED' THEN 5
        WHEN 'ACTIVE' THEN 6
        WHEN 'COMPLETED' THEN 7
        WHEN 'CANCELLED' THEN 8
    END as status_id,
    start_time, end_time, max_participants, current_participants,
    created_time, updated_time
FROM publisher_task_old;
```

## 5. 应用层适配

### 5.1 实体类修改

```java
// 任务主表实体
@Data
@TableName("publisher_task")
public class PublisherTask extends BaseEntity {
    @TableId
    private String taskId;
    private String taskName;
    private Integer taskTypeId;  // 改为INT类型
    private String taskDescription;
    private BigDecimal taskReward;   // 任务积分
    private String taskIconUrl;      // 任务图标URL
    private String detailId;         // 详情配置ID
    private Integer statusId;        // 改为INT类型
}

// 任务详情实体
@Data
@TableName("publisher_task_detail")
public class PublisherTaskDetail extends BaseEntity {
    @TableId
    private String detailId;
    private String taskId;
    private String taskConfig;  // JSON字符串
}
```

### 5.2 服务层修改

```java
@Service
public class PublisherTaskServiceImpl implements PublisherTaskService {
    
    // 创建任务时构建JSON配置
private void createTaskDetail(String taskId, TaskCreateRequest request) {
    Map<String, Object> config = new HashMap<>();
    
    switch (request.getTaskTypeId()) {
        case 1: // 点赞任务
            config.put("targetUrl", request.getTargetUrl());
            config.put("likeCount", request.getLikeCount());
            config.put("commentRequired", request.getCommentRequired());
            break;
        case 2: // 评论任务
            config.put("targetUrl", request.getTargetUrl());
            config.put("commentTemplate", request.getCommentTemplate());
            config.put("minCommentLength", request.getMinCommentLength());
            config.put("maxCommentLength", request.getMaxCommentLength());
            break;
        // ... 其他类型
    }
    
    String jsonConfig = objectMapper.writeValueAsString(config);
    
    // 先创建详情记录
    PublisherTaskDetail detail = new PublisherTaskDetail();
    String detailId = IdUtil.getSnowflakeNextIdStr();
    detail.setDetailId(detailId);
    detail.setTaskId(taskId);
    detail.setTaskConfig(jsonConfig);
    
    taskDetailMapper.insert(detail);
    
    // 更新任务主表的detail_id
    PublisherTask task = new PublisherTask();
    task.setTaskId(taskId);
    task.setDetailId(detailId);
    taskMapper.updateById(task);
}
}
```

## 6. 性能优化建议

### 6.1 索引优化

```sql
-- 任务主表索引
KEY `idx_publisher_status` (`publisher_id`, `status_id`),
KEY `idx_type_status` (`task_type_id`, `status_id`),
KEY `idx_start_time` (`start_time`),
KEY `idx_end_time` (`end_time`)

-- 任务详情表索引
KEY `idx_task_id` (`task_id`)
```

### 6.2 查询优化

1. **避免JSON字段查询**: 尽量在应用层处理JSON数据
2. **使用缓存**: 对枚举数据进行缓存
3. **分页查询**: 使用LIMIT进行分页
4. **批量操作**: 使用批量插入和更新

## 7. 总结

### 7.1 设计优势

1. **简化维护**: 表数量减少，维护成本降低
2. **提高性能**: INT类型存储枚举值，查询效率更高
3. **增强灵活性**: JSON存储支持任务类型的扩展
4. **解决更新问题**: 避免了逻辑删除 + 唯一键约束的冲突
5. **规范命名**: 遵循MySQL数据开发规范

### 7.2 注意事项

1. **JSON字段验证**: 应用层需要验证JSON字段的完整性
2. **向后兼容**: 新增任务类型时需要考虑向后兼容性
3. **性能监控**: 监控JSON字段查询的性能影响
4. **数据迁移**: 需要仔细规划数据迁移方案

## 8. 任务配置JSON结构

### 8.1 概述

本文档定义了发布者模块中 `publisher_task_detail` 表的 `task_config` 字段的JSON结构。不同类型的任务使用不同的JSON配置格式来存储任务详情。

### 8.2 JSON配置结构

#### 8.2.1 点赞任务 (task_type_id: 1)

```json
{}
```

**字段说明**:
- 无特定字段，使用主表的 `task_name`, `task_description`, `task_reward`, `task_icon_url` 字段

#### 8.2.2 评论任务 (task_type_id: 2)

```json
{}
```

**字段说明**:
- 无特定字段，使用主表的 `task_name`, `task_description`, `task_reward`, `task_icon_url` 字段

#### 8.2.3 讨论任务 (task_type_id: 3)

```json
{}
```

**字段说明**:
- 无特定字段，使用主表的 `task_name`, `task_description`, `task_reward`, `task_icon_url` 字段

#### 8.2.4 分享任务 (task_type_id: 4)

```json
{
  "taskInstruction": "请分享指定内容到您的社群",  // JSON字段名
  "imageRequired": true,                        // JSON字段名
  "minImageCount": 1,                           // JSON字段名
  "linkRequired": false,                        // JSON字段名
  "linkUrl": "https://example.com/target-content"  // JSON字段名
}
```

**字段说明**:
- `taskInstruction`: 任务说明 (JSON字段名)
- `imageRequired`: 是否上传图片 (JSON字段名)
- `minImageCount`: 最低图片数量要求 (JSON字段名)
- `linkRequired`: 是否要填写链接 (JSON字段名)
- `linkUrl`: 链接地址 (JSON字段名)

#### 8.2.5 邀请任务 (task_type_id: 5)

**邀请加好友配置**:
```json
{
  "inviteType": "friend",                       // JSON字段名：邀请类型(friend-加好友, group-入群)
  "inviteeReward": true,                        // JSON字段名：被邀请人是否加分
  "inviteeRewardAmount": 5.00,                  // JSON字段名：被邀请人添加积分
  "activityRules": "邀请好友加入可获得额外奖励",    // JSON字段名：活动规则
  "taskQrCodeUrl": "https://example.com/qr-code.jpg"  // JSON字段名：任务展示二维码
}
```

**邀请入群配置**:
```json
{
  "inviteType": "group",                        // JSON字段名：邀请类型(friend-加好友, group-入群)
  "inviteeReward": true,                        // JSON字段名：被邀请人是否加分
  "inviteeRewardAmount": 5.00,                  // JSON字段名：被邀请人添加积分
  "activityRules": "邀请好友入群可获得额外奖励",      // JSON字段名：活动规则
  "taskQrCodeUrl": "https://example.com/qr-code.jpg"  // JSON字段名：任务展示二维码
}
```

**字段说明**:
- `inviteType`: 邀请类型 (JSON字段名) - "friend"表示邀请加好友，"group"表示邀请入群
- `inviteeReward`: 被邀请人是否加分 (JSON字段名)
- `inviteeRewardAmount`: 被邀请人添加积分 (JSON字段名)
- `activityRules`: 活动规则 (JSON字段名)
- `taskQrCodeUrl`: 任务展示二维码URL (JSON字段名)

#### 8.2.6 反馈任务 (task_type_id: 6)

```json
{
  "taskImageUrl": "https://example.com/feedback-image.jpg",  // JSON字段名：任务图片URL
  "feedbackJumpUrl": "https://example.com/feedback-jump"     // JSON字段名：反馈跳转链接
}
```

**字段说明**:
- `taskImageUrl`: 任务图片URL (JSON字段名)
- `feedbackJumpUrl`: 反馈跳转链接 (JSON字段名)

#### 8.2.7 排行榜任务 (task_type_id: 7)

```json
{
  "topRanking": 10  // JSON字段名：展示排行榜前x名
}
```

**字段说明**:
- `topRanking`: 展示排行榜前x名 (JSON字段名)

### 8.3 通用字段

所有任务类型都可以包含以下通用字段：

```json
{
  "commonFields": {
    "priority": 1,
    "tags": ["tag1", "tag2"],
    "metadata": {
      "source": "manual",
      "version": "1.0"
    }
  }
}
```

### 8.4 使用示例

#### 8.4.1 创建点赞任务配置

```java
// Java代码示例 - 点赞任务无特定配置字段
Map<String, Object> likeTaskConfig = new HashMap<>();
// 点赞任务使用主表字段即可，无需额外配置

// 转换为JSON字符串
String jsonConfig = objectMapper.writeValueAsString(likeTaskConfig);
```

#### 8.4.2 创建社群分享任务配置

```java
// Java代码示例 - 社群分享任务有特定配置字段
Map<String, Object> shareTaskConfig = new HashMap<>();
shareTaskConfig.put("taskInstruction", "请分享指定内容到您的社群");  // JSON字段名
shareTaskConfig.put("imageRequired", true);                        // JSON字段名
shareTaskConfig.put("minImageCount", 1);                           // JSON字段名
shareTaskConfig.put("linkRequired", false);                        // JSON字段名
shareTaskConfig.put("linkUrl", "https://example.com/target-content");  // JSON字段名

// 转换为JSON字符串
String jsonConfig = objectMapper.writeValueAsString(shareTaskConfig);
```

#### 8.4.3 创建邀请任务配置

```java
// Java代码示例 - 邀请加好友任务配置
Map<String, Object> inviteFriendConfig = new HashMap<>();
inviteFriendConfig.put("inviteType", "friend");                    // JSON字段名：邀请类型
inviteFriendConfig.put("inviteeReward", true);                     // JSON字段名：被邀请人是否加分
inviteFriendConfig.put("inviteeRewardAmount", 5.00);              // JSON字段名：被邀请人添加积分
inviteFriendConfig.put("activityRules", "邀请好友加入可获得额外奖励");  // JSON字段名：活动规则
inviteFriendConfig.put("taskQrCodeUrl", "https://example.com/qr-code.jpg");  // JSON字段名：任务展示二维码

// 转换为JSON字符串
String jsonConfig = objectMapper.writeValueAsString(inviteFriendConfig);
```

```java
// Java代码示例 - 邀请入群任务配置
Map<String, Object> inviteGroupConfig = new HashMap<>();
inviteGroupConfig.put("inviteType", "group");                      // JSON字段名：邀请类型
inviteGroupConfig.put("inviteeReward", true);                      // JSON字段名：被邀请人是否加分
inviteGroupConfig.put("inviteeRewardAmount", 5.00);               // JSON字段名：被邀请人添加积分
inviteGroupConfig.put("activityRules", "邀请好友入群可获得额外奖励");    // JSON字段名：活动规则
inviteGroupConfig.put("taskQrCodeUrl", "https://example.com/qr-code.jpg");  // JSON字段名：任务展示二维码

// 转换为JSON字符串
String jsonConfig = objectMapper.writeValueAsString(inviteGroupConfig);
```

#### 8.4.4 解析任务配置

```java
// Java代码示例
String jsonConfig = taskDetail.getTaskConfig();
Map<String, Object> config = objectMapper.readValue(jsonConfig, Map.class);

// 根据任务类型解析不同配置
switch (task.getTaskTypeId()) {
    case 1: // 点赞任务 - 无特定字段
        // 使用主表字段：task.getTaskName(), task.getTaskDescription() 等
        break;
    case 4: // 社群分享任务
        String taskInstruction = (String) config.get("taskInstruction");  // JSON字段名
        Boolean imageRequired = (Boolean) config.get("imageRequired");    // JSON字段名
        Integer minImageCount = (Integer) config.get("minImageCount");    // JSON字段名
        Boolean linkRequired = (Boolean) config.get("linkRequired");      // JSON字段名
        String linkUrl = (String) config.get("linkUrl");                 // JSON字段名
        break;
    case 5: // 邀请任务
        String inviteType = (String) config.get("inviteType");           // JSON字段名：邀请类型
        Boolean inviteeReward = (Boolean) config.get("inviteeReward");   // JSON字段名：被邀请人是否加分
        BigDecimal inviteeRewardAmount = new BigDecimal(config.get("inviteeRewardAmount").toString());  // JSON字段名：被邀请人添加积分
        String activityRules = (String) config.get("activityRules");     // JSON字段名：活动规则
        String taskQrCodeUrl = (String) config.get("taskQrCodeUrl");     // JSON字段名：任务展示二维码
        
        // 根据邀请类型进行不同处理
        if ("friend".equals(inviteType)) {
            // 处理邀请加好友逻辑
        } else if ("group".equals(inviteType)) {
            // 处理邀请入群逻辑
        }
        break;
    case 6: // 反馈任务
        String taskImageUrl = (String) config.get("taskImageUrl");       // JSON字段名：任务图片URL
        String feedbackJumpUrl = (String) config.get("feedbackJumpUrl"); // JSON字段名：反馈跳转链接
        break;
    case 7: // 排行榜任务
        Integer topRanking = (Integer) config.get("topRanking");         // JSON字段名：展示排行榜前x名
        break;
    // ... 其他类型
}
```

### 8.5 注意事项

1. **字段验证**: 应用层需要验证JSON字段的完整性和正确性
2. **版本兼容**: 新增字段时需要考虑向后兼容性
3. **性能考虑**: JSON字段的查询性能相对较低，建议在应用层进行缓存
4. **数据完整性**: 应用层需要确保JSON数据的完整性，数据库层面无法进行约束验证

## 9. 任务完成证据JSON结构

### 9.1 概述

本文档定义了发布者模块中 `publisher_task_completion` 表的 `completion_evidence` 字段的JSON结构。**只有社群分享任务(task_type_id: 4)需要提供完成证据**，其他任务通过企业微信API接口自动判断完成情况。

### 9.2 完成判断方式

#### 9.2.1 自动判断任务 (task_type_id: 1,2,3,5,6,7)
- **点赞任务**: 通过企业微信API查询点赞状态
- **评论任务**: 通过企业微信API查询评论状态  
- **讨论任务**: 通过企业微信API查询讨论状态
- **邀请任务**: 通过企业微信API查询邀请状态
- **反馈任务**: 通过企业微信API查询反馈状态
- **排行榜任务**: 通过企业微信API查询排行榜状态

#### 9.2.2 人工审核任务 (task_type_id: 4)
- **社群分享任务**: 需要用户上传截图等证据，人工审核

### 9.3 完成状态说明

#### 9.3.1 完成状态 (completion_status)
- `1`: 进行中 - 用户已接受任务，正在执行
- `2`: 已完成 - 用户已完成任务，等待审核（仅社群分享任务）
- `3`: 已拒绝 - 任务被拒绝

### 9.4 JSON配置结构（仅社群分享任务）

#### 9.4.1 社群分享任务完成证据 (task_type_id: 4)

```json
{
  "screenshotUrl": "https://example.com/screenshot.jpg",
  "shareTime": "2025-01-27T10:30:00",
  "platform": "weibo",
  "shareUrl": "https://example.com/share/123",
  "shareContent": "分享内容",
  "shareLink": "https://example.com/target-content"
}
```

**字段说明**:
- `screenshotUrl`: 分享截图URL（必需）
- `shareTime`: 分享时间
- `platform`: 分享平台
- `shareUrl`: 分享链接
- `shareContent`: 分享内容
- `shareLink`: 目标分享链接

### 9.5 使用示例

#### 9.5.1 创建社群分享任务完成记录

```java
// Java代码示例 - 仅社群分享任务需要
if (task.getTaskTypeId() == 4) { // 社群分享任务
    Map<String, Object> evidence = new HashMap<>();
    evidence.put("screenshotUrl", "https://example.com/screenshot.jpg");
    evidence.put("shareTime", LocalDateTime.now().toString());
    evidence.put("platform", "weibo");
    evidence.put("shareUrl", "https://example.com/share/123");
    
    // 转换为JSON字符串
    String jsonEvidence = objectMapper.writeValueAsString(evidence);
    
    // 创建完成记录
    PublisherTaskCompletion completion = new PublisherTaskCompletion();
    completion.setCompletionId(IdUtil.getSnowflakeNextIdStr());
    completion.setTaskId(taskId);
    completion.setUserId(userId);
    completion.setCompletionStatus(2); // 已完成，等待审核
    completion.setCompletionTime(LocalDateTime.now());
    completion.setRewardAmount(rewardAmount);
    completion.setCompletionEvidence(jsonEvidence); // 仅社群分享任务需要
    
    taskCompletionMapper.insert(completion);
} else {
    // 其他任务通过企业微信API自动判断，无需证据
    PublisherTaskCompletion completion = new PublisherTaskCompletion();
    completion.setCompletionId(IdUtil.getSnowflakeNextIdStr());
    completion.setTaskId(taskId);
    completion.setUserId(userId);
    completion.setCompletionStatus(1); // 进行中
    completion.setCompletionTime(null); // 等待API判断完成
    completion.setRewardAmount(rewardAmount);
    completion.setCompletionEvidence(null); // 其他任务不需要证据
    
    taskCompletionMapper.insert(completion);
}
```

#### 9.5.2 企业微信API自动判断任务完成

```java
// Java代码示例 - 通过企业微信API判断任务完成
@Service
public class WechatWorkTaskService {
    
    public void checkTaskCompletion(String taskId, String userId) {
        PublisherTask task = taskMapper.selectById(taskId);
        
        switch (task.getTaskTypeId()) {
            case 1: // 点赞任务
                checkLikeTaskCompletion(taskId, userId);
                break;
            case 2: // 评论任务
                checkCommentTaskCompletion(taskId, userId);
                break;
            case 3: // 讨论任务
                checkDiscussTaskCompletion(taskId, userId);
                break;
            case 5: // 邀请任务
                checkInviteTaskCompletion(taskId, userId);
                break;
            case 6: // 反馈任务
                checkFeedbackTaskCompletion(taskId, userId);
                break;
            case 7: // 排行榜任务
                checkRankingTaskCompletion(taskId, userId);
                break;
            // 社群分享任务(task_type_id: 4)需要人工审核，不在此处处理
        }
    }
    
    private void checkLikeTaskCompletion(String taskId, String userId) {
        // 调用企业微信API查询点赞状态
        boolean isCompleted = wechatWorkApi.checkLikeStatus(taskId, userId);
        
        if (isCompleted) {
            // 更新完成状态
            PublisherTaskCompletion completion = taskCompletionMapper.selectByTaskAndUser(taskId, userId);
            completion.setCompletionStatus(2); // 已完成
            completion.setCompletionTime(LocalDateTime.now());
            taskCompletionMapper.updateById(completion);
        }
    }
    
    // ... 其他任务类型的检查方法
}
```

### 9.6 注意事项

1. **证据完整性**: 仅社群分享任务需要验证证据的完整性和正确性
2. **图片存储**: 社群分享任务的截图URL需要指向有效的图片文件
3. **时间验证**: 完成时间应该在任务的有效期内
4. **审核流程**: 仅社群分享任务需要人工审核流程
5. **API集成**: 其他任务需要集成企业微信API进行自动判断
6. **数据安全**: 敏感信息（如用户ID）需要进行脱敏处理

这次重新设计解决了原有设计中的主要问题，为发布者模块提供了更加稳定、高效、易维护的数据库架构。 