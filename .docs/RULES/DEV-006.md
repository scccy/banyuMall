# 开发规则：Docker容器化部署

**ID**: DEV-006  
**Name**: Docker容器化部署规则  
**Status**: Active  
**创建时间**: 2025-07-30  

## 触发情景 (Context/Trigger)
当开发微服务模块时，以及需要部署到Kubernetes环境时。

## 指令 (Directive)

### 1. Docker文件规范
- **必须 (MUST)** 为每个微服务模块创建 `Dockerfile`
- **必须 (MUST)** 使用多阶段构建优化镜像大小
- **必须 (MUST)** 基于官方OpenJDK镜像构建
- **必须 (MUST)** 设置非root用户运行应用
- **必须 (MUST)** 配置健康检查端点
- **必须 (MUST)** 使用 `.dockerignore` 排除不必要文件

### 2. 镜像构建规范
- **必须 (MUST)** 使用语义化版本标签
- **必须 (MUST)** 同时打 `latest` 和版本号标签
- **必须 (MUST)** 在 `infra/docker` 目录下维护构建脚本
- **必须 (MUST)** 支持环境变量配置
- **禁止 (MUST NOT)** 在镜像中包含敏感信息

### 3. Docker Compose规范
- **必须 (MUST)** 在 `infra/docker` 目录下维护 `docker-compose.yml`
- **必须 (MUST)** 支持开发、测试、生产环境配置
- **必须 (MUST)** 配置服务间网络通信
- **必须 (MUST)** 配置数据卷持久化
- **必须 (MUST)** 配置环境变量文件

### 4. Kubernetes部署规范
- **必须 (MUST)** 在 `infra/k8s` 目录下维护K8s配置文件
- **必须 (MUST)** 创建Deployment、Service、ConfigMap、Secret
- **必须 (MUST)** 配置资源限制和请求
- **必须 (MUST)** 配置健康检查和就绪检查
- **必须 (MUST)** 支持多环境配置（dev/staging/prod）

### 5. Jenkins集成规范
- **必须 (MUST)** 在 `infra/jenkins` 目录下维护Jenkinsfile
- **必须 (MUST)** 支持多分支流水线
- **必须 (MUST)** 配置自动化测试和构建
- **必须 (MUST)** 配置镜像推送到容器仓库
- **必须 (MUST)** 配置K8s部署自动化

## 理由 (Justification)
此规则源于微服务架构的容器化部署需求：
1. **标准化部署**: 确保所有服务使用统一的容器化标准
2. **自动化运维**: 支持CI/CD流水线自动化部署
3. **环境一致性**: 确保开发、测试、生产环境的一致性
4. **可扩展性**: 支持Kubernetes集群的弹性扩展

## 执行流程

### 1. 新服务模块创建
```bash
# 1. 创建Dockerfile
touch service/service-xxx/Dockerfile

# 2. 创建.dockerignore
touch service/service-xxx/.dockerignore

# 3. 更新构建脚本
# 在infra/docker/build.sh中添加新服务

# 4. 更新docker-compose
# 在infra/docker/docker-compose.yml中添加新服务

# 5. 创建K8s配置
# 在infra/k8s/下创建service-xxx相关配置
```

### 2. 镜像构建流程
```bash
# 开发环境构建
./infra/docker/build.sh service-auth dev

# 生产环境构建
./infra/docker/build.sh service-auth prod

# 推送镜像
./infra/docker/push.sh service-auth v1.0.0
```

### 3. 本地开发启动
```bash
# 启动所有服务
docker-compose -f infra/docker/docker-compose.dev.yml up

# 启动单个服务
docker-compose -f infra/docker/docker-compose.dev.yml up service-auth
```

### 4. K8s部署流程
```bash
# 部署到开发环境
kubectl apply -f infra/k8s/dev/

# 部署到生产环境
kubectl apply -f infra/k8s/prod/
```

## 文件结构规范

### Docker相关文件
```
infra/
├── docker/
│   ├── build.sh              # 镜像构建脚本
│   ├── push.sh               # 镜像推送脚本
│   ├── docker-compose.dev.yml    # 开发环境配置
│   ├── docker-compose.test.yml   # 测试环境配置
│   ├── docker-compose.prod.yml   # 生产环境配置
│   └── templates/
│       ├── Dockerfile.template   # Dockerfile模板
│       └── dockerignore.template # .dockerignore模板
├── k8s/
│   ├── dev/                  # 开发环境K8s配置
│   ├── staging/              # 测试环境K8s配置
│   ├── prod/                 # 生产环境K8s配置
│   └── templates/            # K8s配置模板
└── jenkins/
    ├── Jenkinsfile.template  # Jenkins流水线模板
    └── scripts/              # Jenkins脚本
```

### 服务模块文件
```
service/service-xxx/
├── Dockerfile               # 服务Dockerfile
├── .dockerignore           # Docker忽略文件
└── k8s/                    # 服务专用K8s配置
    ├── deployment.yml
    ├── service.yml
    └── configmap.yml
```

## 最佳实践

### 1. Dockerfile最佳实践
```dockerfile
# 多阶段构建
FROM openjdk:21-jdk-slim AS builder
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

FROM openjdk:21-jre-slim
RUN addgroup --system app && adduser --system --ingroup app app
USER app
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 2. 环境变量配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  service-auth:
    build: 
      context: ../../service/service-auth
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
    ports:
      - "8081:8081"
    depends_on:
      - nacos
      - mysql
      - redis
```

### 3. K8s资源配置
```yaml
# deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-auth
spec:
  replicas: 2
  selector:
    matchLabels:
      app: service-auth
  template:
    metadata:
      labels:
        app: service-auth
    spec:
      containers:
      - name: service-auth
        image: banyumall/service-auth:latest
        ports:
        - containerPort: 8081
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
```

## 相关规则
- [DEV-005.md](./DEV-005.md) - 测试和文档管理规则
- [PERF-001.md](./PERF-001.md) - Spring Boot启动性能优化规则 