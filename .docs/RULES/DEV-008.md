# Maven资源文件管理规则

**ID**: DEV-008  
**Name**: Maven资源文件管理规则  
**Status**: Active  
**创建时间**: 2025-01-27  

## 概述

本规则定义了项目中Maven资源文件的管理策略，包括环境特定的配置文件组织、打包逻辑和最佳实践。

## 触发情景 (Context/Trigger)

当需要为不同环境（开发、测试、生产）配置不同的资源文件时，必须遵循本规则。

## 指令 (Directive)

### 1. 资源目录结构

**必须 (MUST)** 按照以下结构组织资源文件：

```
src/main/resources/
├── application.yml              # 主配置文件（基础配置）
├── application-dev.yml          # 开发环境配置（已废弃，移至dev目录）
├── application-test.yml         # 测试环境配置（已废弃，移至test目录）
├── application-prod.yml         # 生产环境配置（已废弃，移至prod目录）
├── dev/                         # 开发环境特定资源
│   └── application.yml          # 开发环境配置
├── test/                        # 测试环境特定资源
│   └── application.yml          # 测试环境配置
└── prod/                        # 生产环境特定资源
    └── application.yml          # 生产环境配置
```

### 2. Maven Profiles配置

**必须 (MUST)** 在根pom.xml中配置以下profiles：

```xml
<profiles>
    <profile>
       <id>dev</id>
       <properties>
          <profiles.activation>dev</profiles.activation>
       </properties>
       <activation>
          <activeByDefault>true</activeByDefault>
       </activation>
    </profile>
    <profile>
       <id>prod</id>
       <properties>
          <profiles.activation>prod</profiles.activation>
       </properties>
    </profile>
    <profile>
       <id>test</id>
       <properties>
          <profiles.activation>test</profiles.activation>
       </properties>
    </profile>
</profiles>
```

### 3. 资源文件处理规则

**必须 (MUST)** 配置以下资源处理规则：

```xml
<resources>
   <resource>
      <directory>src/main/java</directory>
      <includes>
         <include>**/*.properties</include>
         <include>**/*.xml</include>
      </includes>
   </resource>
   <resource>
      <directory>src/main/resources</directory>
      <excludes>
         <exclude>test/*</exclude>
         <exclude>prod/*</exclude>
         <exclude>dev/*</exclude>
      </excludes>
   </resource>
   <resource>
      <directory>src/main/resources/${profiles.activation}</directory>
   </resource>
</resources>
```

### 4. 配置文件内容规范

#### 主配置文件 (application.yml)
**必须 (MUST)** 只包含：
- 服务器基础配置
- Spring基础配置
- Nacos连接配置
- 管理端点配置
- 基础日志配置

**禁止 (MUST NOT)** 包含：
- 环境特定的数据库配置
- 环境特定的Redis配置
- 环境特定的业务配置

#### 环境特定配置文件
**必须 (MUST)** 包含：
- 数据源配置（使用环境变量）
- Redis配置（使用环境变量）
- MyBatis-Plus配置
- 环境特定的日志配置
- 环境特定的性能配置
- 环境特定的安全配置

### 5. 环境变量使用规范

**必须 (MUST)** 使用环境变量配置敏感信息：

```yaml
# 数据库配置
datasource:
  url: ${MYSQL_URL:jdbc:mysql://localhost:3306/banyu_mall}
  username: ${MYSQL_USERNAME:root}
  password: ${MYSQL_PASSWORD:123456}

# Redis配置
redis:
  host: ${REDIS_HOST:localhost}
  password: ${REDIS_PASSWORD:}

# JWT配置
jwt:
  secret: ${JWT_SECRET}
```

### 6. 打包和部署规范

#### 开发环境
```bash
# 使用默认profile（dev）
mvn clean package

# 显式指定dev profile
mvn clean package -P dev
```

#### 测试环境
```bash
# 指定test profile
mvn clean package -P test
```

#### 生产环境
```bash
# 指定prod profile
mvn clean package -P prod
```

### 7. 环境特定配置差异

#### 开发环境特性
- **数据库**: 本地MySQL，自动初始化
- **Redis**: 本地Redis，无密码
- **日志**: 详细日志，DEBUG级别
- **性能**: 懒加载，较小连接池
- **安全**: 宽松配置，支持热重启

#### 测试环境特性
- **数据库**: 测试环境MySQL，不自动初始化
- **Redis**: 测试环境Redis，有密码
- **日志**: 中等日志，INFO级别
- **性能**: 中等连接池，关闭懒加载
- **安全**: 中等配置，关闭热重启

#### 生产环境特性
- **数据库**: 生产环境MySQL，不自动初始化
- **Redis**: 生产环境Redis，强密码
- **日志**: 精简日志，WARN级别
- **性能**: 大连接池，性能优化
- **安全**: 严格配置，安全加固

## 理由 (Justification)

此规则源于任务 `task_20250127_1700_完善资源文件结构.md`。在该任务中，发现原有的配置文件管理方式不够灵活，无法支持不同环境的差异化配置，导致部署和维护困难。

通过实施本规则，可以实现：
1. **环境隔离**: 不同环境的配置完全分离
2. **打包自动化**: Maven自动选择对应环境的配置文件
3. **维护简化**: 配置文件结构清晰，易于维护
4. **安全性提升**: 敏感信息通过环境变量管理
5. **部署灵活**: 支持不同环境的差异化部署

## 最佳实践

### 1. 配置文件命名
- 使用 `application.yml` 作为环境特定配置文件名
- 避免使用环境后缀，由目录结构区分

### 2. 环境变量管理
- 使用 `.env` 文件管理本地开发环境变量
- 生产环境使用容器编排工具管理环境变量
- 定期轮换敏感信息

### 3. 配置验证
- 在CI/CD流程中验证配置文件语法
- 使用配置验证工具检查配置完整性
- 定期测试不同环境的配置

### 4. 文档维护
- 及时更新配置说明文档
- 记录环境特定的配置差异
- 维护环境变量清单

## 相关文档

- [Maven Profiles配置说明](../Maven-Profiles-README.md)
- [配置文件管理说明](../infra/templates/config/README.md)
- [任务状态文件](../TEMP/task_20250127_1700_完善资源文件结构.md) 