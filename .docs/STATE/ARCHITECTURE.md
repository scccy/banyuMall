# 系统架构设计

## 架构概述
半语积分商城采用微服务架构，基于Spring Cloud技术栈构建，包含以下核心组件：

## 基础设施服务

### 1. API网关 (infra-gateway)
- **端口**: 8080
- **技术栈**: Spring Cloud Gateway
- **功能**:
  - 统一入口：所有外部请求通过网关进入系统
  - 路由转发：根据路径将请求转发到对应的微服务
  - 负载均衡：使用Nacos服务发现实现负载均衡
  - 请求过滤：全局过滤器记录请求日志和添加请求头
  - 安全控制：统一的认证和授权入口



## 业务服务

### 1. 认证授权服务 (service-auth)
- **端口**: 8081 (context-path: /auth)
- **技术栈**: Spring Boot + Spring Security + JWT
- **功能**:
  - 用户认证：登录、注册、密码重置
  - 权限管理：角色、权限、用户角色关联
  - JWT令牌：生成和验证访问令牌
  - 安全控制：接口权限验证

## 技术架构

### 服务注册与发现
- **注册中心**: Nacos (http://117.50.197.170:8849/)
- **服务发现**: Spring Cloud Alibaba Nacos Discovery
- **配置中心**: Spring Cloud Alibaba Nacos Config

### 网关路由配置
```yaml
# 认证服务路由
- id: auth-service
  uri: lb://service-auth
  predicates:
    - Path=/auth/**
  filters:
    - StripPrefix=1

# 默认路由
- id: default-route
  uri: lb://service-auth
  predicates:
    - Path=/**
  filters:
    - StripPrefix=0
```

### 网络架构
```
外部请求 → API网关(8080) → 微服务集群
                ↓
            Nacos注册中心(8849)
                ↓
            服务发现与配置管理
```

## 部署架构

### 开发环境
- **网关服务**: localhost:8080
- **认证服务**: localhost:8081/auth
- **Nacos控制台**: http://117.50.197.170:8849/nacos

### 生产环境
- **负载均衡**: 前端负载均衡器
- **网关集群**: 多实例部署
- **服务集群**: 各微服务多实例部署
- **注册中心**: Nacos集群部署

## 安全架构

### 认证流程
1. 用户通过网关访问认证接口
2. 认证服务验证用户凭据
3. 生成JWT令牌返回给用户
4. 后续请求携带JWT令牌
5. 网关和服务验证令牌有效性

### 权限控制
- **网关层**: 统一入口，基础安全控制
- **服务层**: 细粒度权限控制
- **数据层**: 数据访问权限控制

## 监控与运维

### 健康检查
- **Actuator**: 各服务提供健康检查端点
- **Nacos**: 服务实例健康状态监控
- **网关**: 路由健康状态监控

### 日志管理
- **统一日志格式**: 结构化日志输出
- **请求链路追踪**: 网关全局过滤器记录请求日志
- **错误日志**: 异常信息记录和告警

## 扩展性设计

### 水平扩展
- **无状态服务**: 所有服务设计为无状态
- **负载均衡**: 支持多实例部署
- **服务发现**: 动态服务注册和发现

### 垂直扩展
- **模块化设计**: 按业务领域划分服务
- **独立部署**: 各服务可独立部署和升级
- **配置管理**: 统一配置中心管理

## 技术债务与优化方向

### 当前状态
- ✅ 基础微服务架构搭建完成
- ✅ 服务注册与发现机制建立
- ✅ API网关基础功能实现
- ✅ 认证服务集成完成

### 待优化项目
- 🔄 服务监控和链路追踪
- 🔄 配置中心统一管理
- 🔄 服务熔断和降级机制
- 🔄 分布式事务处理
- 🔄 缓存策略优化 